<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBC CRM</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Corporate Professional Design */
            --primary: #1E40AF;
            --primary-dark: #1E3A8A;
            --primary-light: #3B82F6;
            --secondary: #64748B;
            --accent: #059669;
            --danger: #DC2626;
            --warning: #F59E0B;
            --bg-main: #F5F7FA;
            --bg-card: #FFFFFF;
            --bg-sidebar: #F8FAFC;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border: #E2E8F0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            color: var(--text-primary);
            padding: 24px 16px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: none;
            border-right: 1px solid var(--border);
        }
        
        .logo {
            font-family: 'IBM Plex Sans', sans-serif;
            margin-bottom: 32px;
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        
        .logo span {
            display: block;
        }
        
        .nav-item {
            padding: 10px 12px;
            margin-bottom: 2px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
        }
        
        .nav-item:hover {
            background: #E2E8F0;
            color: var(--text-primary);
            transform: translateX(0);
        }
        
        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);
        }
        
        .nav-icon {
            width: 18px;
            height: 18px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 32px 40px;
            background: var(--bg-card);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header h1 {
            font-family: 'Epilogue', sans-serif;
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 64, 175, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #F8FAFC;
        }
        
        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            animation: fadeInUp 0.6s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }
        
        .card:hover::before {
            transform: scaleY(1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-kunde { background: #D1FAE5; color: #065F46; border: 1px solid #6EE7B7; }
        .badge-partner { background: #DBEAFE; color: #1E40AF; border: 1px solid #93C5FD; }
        .badge-bearbeitung { background: #FEF3C7; color: #92400E; border: 1px solid #FDE68A; }
        .badge-kontakt { background: #E9D5FF; color: #6B21A8; border: 1px solid #C084FC; }
        .badge-ehemalig { background: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; }
        .badge-verloren { background: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; }
        .badge-primary { background: #DBEAFE; color: #1E40AF; border: 1px solid #93C5FD; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .modal-title {
            font-family: 'Epilogue', sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: var(--bg-main);
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-label.required::after {
            content: ' *';
            color: var(--primary);
        }
        
        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: var(--bg-main);
            border-radius: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .services-section {
            margin-bottom: 20px;
        }
        
        .service-category {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 8px;
            margin-top: 12px;
        }
        
        .custom-service {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        /* Pipeline */
        .pipeline-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 0;
        }
        
        .pipeline-column {
            min-width: 280px;
            background: var(--bg-main);
            border-radius: 12px;
            padding: 20px;
        }
        
        .pipeline-header {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 16px;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .pipeline-deal {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: move;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .pipeline-deal:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .pipeline-deal.dragging {
            opacity: 0.5;
            border-color: var(--primary);
        }
        
        .deal-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .deal-value {
            color: var(--accent);
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .deal-info {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Score Stars */
        .score-stars {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        
        .star {
            cursor: pointer;
            font-size: 24px;
            color: #ddd;
            transition: all 0.2s ease;
        }
        
        .star.active {
            color: #FFB800;
        }
        
        .star:hover {
            transform: scale(1.2);
        }
        
        /* Tasks */
        .task-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .task-item:hover {
            box-shadow: var(--shadow-md);
        }
        
        .task-overdue {
            border-left: 4px solid var(--danger);
            background: #FFEBEE;
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .task-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .icon-btn:hover {
            background: var(--bg-main);
            color: var(--primary);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border);
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        /* Detail View */
        .detail-view {
            display: none;
            animation: fadeInUp 0.5s ease;
        }
        
        .detail-view.active {
            display: block;
        }
        
        .detail-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }
        
        .detail-title {
            font-family: 'Epilogue', sans-serif;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 12px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .detail-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            color: var(--primary);
            transform: translateX(-4px);
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            font-family: 'Epilogue', sans-serif;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-state-subtext {
            font-size: 14px;
        }
        
        /* List View */
        .list-view {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .list-header {
            display: grid;
            grid-template-columns: 40px 2fr 2fr 1.5fr 1.5fr 1fr 80px;
            gap: 20px;
            padding: 16px 24px;
            background: var(--bg-main);
            border-bottom: 2px solid var(--border);
            font-weight: 700;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .list-item {
            display: grid;
            grid-template-columns: 40px 2fr 2fr 1.5fr 1.5fr 1fr 80px;
            gap: 20px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
            align-items: center;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:hover {
            background: var(--bg-main);
        }
        
        .list-item-clickable {
            cursor: pointer;
            display: contents;
        }
        
        .list-item-clickable > *:not(.list-item-actions) {
            cursor: pointer;
        }
        
        .list-item-clickable:hover > *:not(.list-item-actions) {
            transform: translateX(4px);
        }
        
        .list-item-main {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }
        
        .list-item-sub {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 4px;
        }
        
        .list-item-services {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .service-tag {
            padding: 3px 10px;
            background: var(--bg-main);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        /* Company List Specific */
        .company-list-header {
            display: grid;
            grid-template-columns: 40px 2.5fr 1.5fr 1fr 1fr 1fr 80px;
            gap: 20px;
            padding: 16px 24px;
            background: var(--bg-main);
            border-bottom: 2px solid var(--border);
            font-weight: 700;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .company-list-item {
            display: grid;
            grid-template-columns: 40px 2.5fr 1.5fr 1fr 1fr 1fr 80px;
            gap: 20px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
            align-items: center;
        }
        
        .company-list-item:last-child {
            border-bottom: none;
        }
        
        .company-list-item:hover {
            background: var(--bg-main);
        }
        
        .list-item-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background: #FFEBEE;
            color: #C62828;
            transform: scale(1.1);
        }
        
        /* Bulk Selection */
        .bulk-actions {
            display: none;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }
        
        .bulk-actions.active {
            display: flex;
        }
        
        .bulk-actions-text {
            flex: 1;
            font-weight: 600;
        }
        
        .bulk-action-btn {
            background: white;
            color: var(--primary);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bulk-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .bulk-action-btn.delete {
            background: #C62828;
            color: white;
        }
        
        .select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }
        
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--bg-main);
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .select-all-container:hover {
            background: #E8EAED;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .filter-input {
            flex: 1;
            min-width: 250px;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        
        /* Settings Tabs */
        .settings-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
        }
        
        .settings-tab:hover {
            color: var(--primary);
        }
        
        .settings-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .settings-tab-content {
            animation: fadeIn 0.3s ease;
        }
        
        /* Employee Card */
        .employee-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .employee-card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .employee-info {
            flex: 1;
        }
        
        .employee-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .employee-meta {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .employee-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Dashboard Styles */
        .kpi-card {
            padding: 20px;
            border-radius: 6px;
            background: white;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .kpi-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
            color: var(--primary);
            opacity: 0.8;
        }
        
        .kpi-icon svg {
            width: 100%;
            height: 100%;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .kpi-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .kpi-sub {
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }
        
        .goal-item {
            margin-bottom: 24px;
        }
        
        .goal-item:last-child {
            margin-bottom: 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-main);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.2s ease;
        }
        
        .activity-item:hover {
            background: var(--bg-main);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .activity-time {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                padding: 20px 10px;
            }
            
            .logo {
                font-size: 20px;
                text-align: center;
            }
            
            .nav-item span {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
                padding: 20px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .pipeline-container {
                flex-direction: column;
            }
            
            .pipeline-column {
                min-width: 100%;
            }
        }
        
        /* Voice Recording Indicator */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .stat-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 42px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .stat-change {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
    </style>
    
    <!-- Speech Recognition System -->
    <script>
        // Global Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let currentRecognition = null;
        let currentTargetElement = null;
        
        function initSpeechRecognition() {
            if (!SpeechRecognition) {
                console.warn('Browser unterst√ºtzt keine Spracherkennung');
                return null;
            }
            
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'de-DE';
            
            return recognition;
        }
        
        function startVoiceInput(targetElementId, isAppend = false) {
            // Stop any existing recognition
            if (currentRecognition) {
                currentRecognition.stop();
            }
            
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement) {
                console.error('Target element not found:', targetElementId);
                return;
            }
            
            currentTargetElement = targetElement;
            currentRecognition = initSpeechRecognition();
            
            if (!currentRecognition) {
                alert('Ihr Browser unterst√ºtzt leider keine Spracherkennung. Bitte verwenden Sie Chrome, Edge oder Safari.');
                return;
            }
            
            let finalTranscript = isAppend ? (targetElement.value || '') : '';
            
            currentRecognition.onresult = (event) => {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript = transcript;
                    }
                }
                
                targetElement.value = finalTranscript + interimTranscript;
                
                // Auto-resize textarea if needed
                if (targetElement.tagName === 'TEXTAREA') {
                    targetElement.style.height = 'auto';
                    targetElement.style.height = targetElement.scrollHeight + 'px';
                }
            };
            
            currentRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopVoiceInput();
                
                if (event.error === 'not-allowed') {
                    alert('Mikrofon-Zugriff wurde verweigert. Bitte erlauben Sie den Zugriff in Ihren Browser-Einstellungen.');
                } else if (event.error === 'no-speech') {
                    showNotification('Keine Sprache erkannt', 'Bitte sprechen Sie deutlich ins Mikrofon.', 3000);
                }
            };
            
            currentRecognition.onend = () => {
                stopVoiceInput();
            };
            
            try {
                currentRecognition.start();
                
                // Show recording indicator
                const voiceBtn = document.querySelector(`[data-voice-target="${targetElementId}"]`);
                if (voiceBtn) {
                    voiceBtn.innerHTML = '‚èπÔ∏è';
                    voiceBtn.style.background = '#ef4444';
                    voiceBtn.classList.add('recording');
                    voiceBtn.setAttribute('data-recording', 'true');
                }
                
                showNotification('üé§ Aufnahme l√§uft', 'Sprechen Sie jetzt... Klicken Sie erneut zum Stoppen.', 2000);
            } catch (error) {
                console.error('Error starting recognition:', error);
                alert('Fehler beim Starten der Spracherkennung. Bitte √ºberpr√ºfen Sie Ihre Mikrofon-Berechtigung.');
            }
        }
        
        function stopVoiceInput() {
            if (currentRecognition) {
                currentRecognition.stop();
                currentRecognition = null;
            }
            
            // Reset all voice buttons
            document.querySelectorAll('[data-recording="true"]').forEach(btn => {
                btn.innerHTML = 'üé§';
                btn.style.background = '';
                btn.classList.remove('recording');
                btn.removeAttribute('data-recording');
            });
        }
        
        function toggleVoiceInput(targetElementId, isAppend = false) {
            const isRecording = currentRecognition !== null;
            
            if (isRecording) {
                stopVoiceInput();
            } else {
                startVoiceInput(targetElementId, isAppend);
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo" style="padding: 24px 16px; display: flex; flex-direction: column; align-items: center; gap: 0;">
                <div style="font-size: 48px; font-weight: 900; letter-spacing: -2px; line-height: 1;">
                    <span style="color: #00BCD4;">BBC</span>
                </div>
                <div style="font-size: 32px; font-weight: 700; letter-spacing: 2px; color: #64748b; margin-top: -8px;">
                    CRM
                </div>
            </div>
            <nav>
                <div class="nav-item active" data-view="dashboard">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-view="contacts">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span>Kontakte</span>
                </div>
                <div class="nav-item" data-view="companies">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span>Unternehmen</span>
                </div>
                <div class="nav-item" data-view="deals">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Deals</span>
                </div>
                <div class="nav-item" data-view="orders">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span>Auftr√§ge</span>
                </div>
                <div class="nav-item" data-view="tasks">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <span>Aufgaben</span>
                </div>
                <div class="nav-item" data-view="analytics">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" data-view="inactive">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Inaktive Kontakte</span>
                </div>
                <div class="nav-item" data-view="settings">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Einstellungen</span>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view-content">
                <div class="header">
                    <h1>Dashboard</h1>
                    <p style="color: var(--text-secondary); margin-top: 8px;">Willkommen zur√ºck! Hier ist Ihre √úbersicht.</p>
                </div>

                <!-- KPI Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="kpi-card">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="kpi-label">Jahresumsatz</div>
                        <div class="kpi-value" id="kpiYearRevenue">‚Ç¨ 0</div>
                        <div class="kpi-sub" id="kpiYearProgress">0% vom Ziel</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="kpi-label">Gewonnene Deals</div>
                        <div class="kpi-value" id="kpiWonDeals">0</div>
                        <div class="kpi-sub" id="kpiWonDealsValue">‚Ç¨ 0</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                        </div>
                        <div class="kpi-label">Deals in Pipeline</div>
                        <div class="kpi-value" id="kpiDealsCount">0</div>
                        <div class="kpi-sub" id="kpiDealsValue">‚Ç¨ 0</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </div>
                        <div class="kpi-label">Verlorene Deals</div>
                        <div class="kpi-value" id="kpiLostDeals">0</div>
                        <div class="kpi-sub" id="kpiLostDealsValue">‚Ç¨ 0</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div class="kpi-label">Kontakte</div>
                        <div class="kpi-value" id="kpiContactsCount">0</div>
                        <div class="kpi-sub" id="kpiNewContacts">+0 diese Woche</div>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                        </div>
                        <div class="kpi-label">Offene Aufgaben</div>
                        <div class="kpi-value" id="kpiTasksCount">0</div>
                        <div class="kpi-sub" id="kpiOverdueTasks">0 √ºberf√§llig</div>
                    </div>
                </div>

                <!-- Jahresziele & Umsatz -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px;">
                    <!-- Jahresziele -->
                    <div class="dashboard-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title" style="margin: 0;">Jahresziele 2026</h3>
                            <button class="btn btn-secondary" onclick="openGoalsModal()">Bearbeiten</button>
                        </div>
                        
                        <div id="goalsContent">
                            <div class="goal-item">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">Umsatzziel</span>
                                    <span id="goalRevenueText">‚Ç¨ 0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="goalRevenueProgress" style="width: 0%"></div>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;" id="goalRevenueStatus">0% erreicht</div>
                            </div>
                            
                            <div class="goal-item">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">Neue Kontakte</span>
                                    <span id="goalContactsText">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="goalContactsProgress" style="width: 0%; background: var(--success);"></div>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;" id="goalContactsStatus">0% erreicht</div>
                            </div>
                            
                            <div class="goal-item">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">Abgeschlossene Deals</span>
                                    <span id="goalDealsText">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="goalDealsProgress" style="width: 0%; background: var(--secondary);"></div>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;" id="goalDealsStatus">0% erreicht</div>
                            </div>
                        </div>
                    </div>

                    <!-- Umsatz Ist/Soll -->
                    <div class="dashboard-card">
                        <h3 class="section-title" style="margin-bottom: 20px;">üí∏ Umsatz-√úbersicht</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Ist-Umsatz</div>
                                <div style="font-size: 28px; font-weight: 700; color: var(--success);" id="revenueActual">‚Ç¨ 0</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Soll-Umsatz</div>
                                <div style="font-size: 28px; font-weight: 700; color: var(--secondary);" id="revenueTarget">‚Ç¨ 0</div>
                            </div>
                        </div>
                        
                        <div class="progress-bar" style="height: 12px;">
                            <div class="progress-fill" id="revenueProgress" style="width: 0%"></div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px; text-align: center;" id="revenuePercentage">0%</div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
                                <div>
                                    <div style="color: var(--text-secondary);">Noch zu erreichen</div>
                                    <div style="font-weight: 600; margin-top: 4px;" id="revenueRemaining">‚Ç¨ 0</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary);">Durchschn./Monat</div>
                                    <div style="font-weight: 600; margin-top: 4px;" id="revenueMonthly">‚Ç¨ 0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pipeline & Aufgaben -->
                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; margin-bottom: 30px;">
                    <!-- Pipeline √úbersicht -->
                    <div class="dashboard-card">
                        <h3 class="section-title" style="margin-bottom: 20px;">Pipeline-√úbersicht</h3>
                        <div id="pipelineChart"></div>
                    </div>

                    <!-- Offene Aufgaben -->
                    <div class="dashboard-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title" style="margin: 0;">Offene Aufgaben</h3>
                            <button class="btn btn-secondary" onclick="showView('tasks')">Alle</button>
                        </div>
                        <div id="dashboardTasks"></div>
                    </div>
                    
                    <!-- Anstehende Wiedervorlagen -->
                    <div class="dashboard-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 class="section-title" style="margin: 0;">Anstehende Wiedervorlagen</h3>
                        </div>
                        <div id="dashboardReminders"></div>
                    </div>
                </div>

                <!-- Aktuelle Aktivit√§ten -->
                <div class="dashboard-card">
                    <h3 class="section-title" style="margin-bottom: 20px;">Aktuelle Aktivit√§ten</h3>
                    <div id="activityFeed"></div>
                </div>
            </div>

            <!-- Contacts View -->
            <div id="contacts-view" class="view-content hidden">
                <div class="header">
                    <h1>Kontakte</h1>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportContactsCSV()">üì• CSV Export</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('csvImportFile').click()">üì§ CSV Import</button>
                        <input type="file" id="csvImportFile" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
                        <button class="btn btn-primary" onclick="openContactModal()">+ Neuer Kontakt</button>
                    </div>
                </div>
                
                <div id="contactsBulkActions" class="bulk-actions">
                    <span class="bulk-actions-text"><span id="contactsSelectedCount">0</span> ausgew√§hlt</span>
                    <button class="bulk-action-btn" onclick="deselectAllContacts()">Abw√§hlen</button>
                    <button class="bulk-action-btn delete" onclick="bulkDeleteContacts()">L√∂schen</button>
                </div>
                
                <div class="filters">
                    <input type="text" class="form-input filter-input" id="contactSearch" placeholder="Kontakte durchsuchen..." onkeyup="filterContacts()">
                    <select class="form-select" id="contactStatusFilter" onchange="filterContacts()">
                        <option value="">Alle Status</option>
                        <option value="Kunde">Kunde</option>
                        <option value="Ehemaliger Kunde">Ehemaliger Kunde</option>
                        <option value="Partner">Partner</option>
                        <option value="In Bearbeitung">In Bearbeitung</option>
                        <option value="Akquise">Akquise</option>
                        <option value="Einfacher Kontakt">Einfacher Kontakt</option>
                    </select>
                </div>
                
                <div class="select-all-container" onclick="toggleSelectAllContacts()">
                    <input type="checkbox" id="selectAllContacts" class="select-checkbox" onclick="event.stopPropagation(); toggleSelectAllContacts()">
                    <label for="selectAllContacts" style="cursor: pointer; user-select: none;">Alle ausw√§hlen</label>
                </div>
                
                <div id="contactsList" class="list-view"></div>
            </div>

            <!-- Companies View -->
            <div id="companies-view" class="view-content hidden">
                <div class="header">
                    <h1>Unternehmen</h1>
                </div>
                
                <div id="companiesBulkActions" class="bulk-actions">
                    <span class="bulk-actions-text"><span id="companiesSelectedCount">0</span> ausgew√§hlt</span>
                    <button class="bulk-action-btn" onclick="deselectAllCompanies()">Abw√§hlen</button>
                    <button class="bulk-action-btn delete" onclick="bulkDeleteCompanies()">L√∂schen</button>
                </div>
                
                <div class="filters">
                    <input type="text" class="form-input filter-input" id="companySearch" placeholder="Unternehmen durchsuchen..." onkeyup="filterCompanies()">
                </div>
                
                <div class="select-all-container" onclick="toggleSelectAllCompanies()">
                    <input type="checkbox" id="selectAllCompanies" class="select-checkbox" onclick="event.stopPropagation(); toggleSelectAllCompanies()">
                    <label for="selectAllCompanies" style="cursor: pointer; user-select: none;">Alle ausw√§hlen</label>
                </div>
                
                <div id="companiesList" class="list-view"></div>
            </div>

            <!-- Deals View -->
            <div id="deals-view" class="view-content hidden">
                <div class="header">
                    <h1>Deal Pipeline</h1>
                </div>
                
                <div class="pipeline-container" id="pipelineContainer"></div>
            </div>

            <!-- Orders View -->
            <div id="orders-view" class="view-content hidden">
                <div class="header">
                    <h1>Auftr√§ge</h1>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <select class="form-select" id="orderStatusFilter" onchange="renderOrders()" style="width: 180px;">
                            <option value="">Alle Status</option>
                            <option value="Neu">Neu</option>
                            <option value="In Bearbeitung">In Bearbeitung</option>
                            <option value="Abgeschlossen">Abgeschlossen</option>
                            <option value="Storniert">Storniert</option>
                        </select>
                        <select class="form-select" id="orderPaymentFilter" onchange="renderOrders()" style="width: 180px;">
                            <option value="">Alle Zahlungsmodelle</option>
                            <option value="one-time">Einmalzahlung</option>
                            <option value="monthly">Monatlich</option>
                            <option value="quarterly">Viertelj√§hrlich</option>
                            <option value="yearly">J√§hrlich</option>
                        </select>
                        <select class="form-select" id="orderSortBy" onchange="renderOrders()" style="width: 180px;">
                            <option value="date-desc">Neueste zuerst</option>
                            <option value="date-asc">√Ñlteste zuerst</option>
                            <option value="value-desc">H√∂chster Wert</option>
                            <option value="value-asc">Niedrigster Wert</option>
                            <option value="company">Nach Unternehmen</option>
                        </select>
                        <input type="text" class="form-input" id="orderSearch" placeholder="Suchen..." onkeyup="renderOrders()" style="width: 200px;">
                    </div>
                </div>
                
                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Gesamt Auftr√§ge</div>
                        <div class="stat-value" id="ordersTotal">0</div>
                        <div class="stat-change">Alle Status</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Gesamtumsatz</div>
                        <div class="stat-value" id="ordersValue">‚Ç¨ 0</div>
                        <div class="stat-change">Alle Auftr√§ge</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">In Bearbeitung</div>
                        <div class="stat-value" id="ordersActive">0</div>
                        <div class="stat-change" id="ordersActiveValue">‚Ç¨ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">MRR/ARR</div>
                        <div class="stat-value" id="ordersMRR">‚Ç¨ 0</div>
                        <div class="stat-change" id="ordersARR">‚Ç¨ 0/Jahr</div>
                    </div>
                </div>
                
                <div id="ordersList"></div>
            </div>

            <!-- Analytics View -->
            <div id="analytics-view" class="view-content hidden">
                <div class="header">
                    <h1>Analytics & Reporting</h1>
                    <div style="display: flex; gap: 12px;">
                        <select id="analyticsTimeframe" class="form-select" style="width: 200px;" onchange="updateAnalytics()">
                            <option value="month">Dieser Monat</option>
                            <option value="quarter">Dieses Quartal</option>
                            <option value="year" selected>Dieses Jahr</option>
                            <option value="all">Gesamt</option>
                        </select>
                        <button class="btn btn-secondary" onclick="updateAnalytics()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            Aktualisieren
                        </button>
                        <button class="btn btn-secondary" onclick="exportAnalyticsPDF()">PDF Export</button>
                    </div>
                </div>

                <!-- KPI Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="card">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">MRR (Monthly)</div>
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="analyticsMRR">‚Ç¨ 0</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Wiederkehrend/Monat</div>
                    </div>
                    <div class="card">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">ARR (Yearly)</div>
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="analyticsARR">‚Ç¨ 0</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Hochgerechnet/Jahr</div>
                    </div>
                    <div class="card">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Conversion Rate</div>
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="analyticsConversionRate">0%</div>
                        <div style="font-size: 12px; color: var(--accent); margin-top: 4px;" id="analyticsConversionChange">-</div>
                    </div>
                    <div class="card">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">√ò Deal Velocity</div>
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="analyticsDealVelocity">0 Tage</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Bis Abschluss</div>
                    </div>
                    <div class="card">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">√ò Deal Wert</div>
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="analyticsAvgDealValue">‚Ç¨ 0</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Pro Deal</div>
                    </div>
                    <div class="card">
                        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Win Rate</div>
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);" id="analyticsWinRate">0%</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="analyticsWinRateDetails">-</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 30px;">
                    <!-- Revenue Timeline -->
                    <div class="card">
                        <h3 class="section-title" style="margin-bottom: 20px;">Umsatzentwicklung</h3>
                        <div id="revenueTimelineChart" style="min-height: 300px;"></div>
                    </div>

                    <!-- Top Performers -->
                    <div class="card">
                        <h3 class="section-title" style="margin-bottom: 20px;">Top Performer</h3>
                        <div id="topPerformersChart"></div>
                    </div>
                </div>

                <!-- Analysis Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px;">
                    <!-- Deal Funnel -->
                    <div class="card">
                        <h3 class="section-title" style="margin-bottom: 20px;">Sales Funnel</h3>
                        <div id="salesFunnelChart"></div>
                    </div>

                    <!-- Loss Reasons -->
                    <div class="card">
                        <h3 class="section-title" style="margin-bottom: 20px;">Verlustgr√ºnde</h3>
                        <div id="lossReasonsChart"></div>
                    </div>
                </div>

                <!-- Forecast -->
                <div class="card">
                    <h3 class="section-title" style="margin-bottom: 20px;">Umsatz-Forecast (N√§chste 3 Monate)</h3>
                    <div id="forecastChart" style="min-height: 250px;"></div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view-content hidden">
                <div class="header">
                    <h1>Einstellungen</h1>
                </div>

                <!-- Settings Navigation -->
                <div style="display: flex; gap: 12px; margin-bottom: 30px; border-bottom: 2px solid var(--border);">
                    <button class="settings-tab active" data-tab="employees" onclick="switchSettingsTab('employees')">Mitarbeiter</button>
                    <button class="settings-tab" data-tab="services" onclick="switchSettingsTab('services')">Leistungen</button>
                    <button class="settings-tab" data-tab="stages" onclick="switchSettingsTab('stages')">Deal-Phasen</button>
                    <button class="settings-tab" data-tab="statuses" onclick="switchSettingsTab('statuses')">Lead-Status</button>
                    <button class="settings-tab" data-tab="general" onclick="switchSettingsTab('general')">Allgemein</button>
                    <button class="settings-tab" data-tab="backup" onclick="switchSettingsTab('backup')">Datensicherung</button>
                </div>

                <!-- Employees Tab -->
                <div id="settings-employees" class="settings-tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Mitarbeiter verwalten</h2>
                            <p style="color: var(--text-secondary);">F√ºgen Sie Mitarbeiter hinzu und verwalten Sie deren Informationen</p>
                        </div>
                        <button class="btn btn-primary" onclick="openEmployeeModal()">+ Neuer Mitarbeiter</button>
                    </div>

                    <div id="employeesList"></div>
                </div>

                <!-- Services Tab -->
                <div id="settings-services" class="settings-tab-content hidden">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Eigene Leistungen</h2>
                        <p style="color: var(--text-secondary);">Verwalten Sie Ihre individuellen Dienstleistungen zus√§tzlich zu den Standard-Kategorien</p>
                    </div>

                    <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                        <div class="form-group">
                            <label class="form-label">Neue Leistung hinzuf√ºgen</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="text" class="form-input" id="newServiceInput" placeholder="z.B. Workshops, Schulungen, etc." style="flex: 1;">
                                <button class="btn btn-primary" onclick="addCustomServiceSetting()">Hinzuf√ºgen</button>
                            </div>
                        </div>
                    </div>

                    <div id="customServicesSettings"></div>
                </div>

                <!-- Deal Stages Tab -->
                <div id="settings-stages" class="settings-tab-content hidden">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Deal-Phasen</h2>
                        <p style="color: var(--text-secondary);">Verwalten Sie die Phasen Ihrer Sales-Pipeline</p>
                    </div>

                    <div style="background: white; padding: 24px; border-radius: 12px;">
                        <div id="dealStagesList"></div>
                        <button class="btn btn-secondary mt-3" onclick="addDealStage()">+ Neue Phase hinzuf√ºgen</button>
                    </div>
                </div>

                <!-- Lead Statuses Tab -->
                <div id="settings-statuses" class="settings-tab-content hidden">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Lead-Status</h2>
                        <p style="color: var(--text-secondary);">Verwalten Sie die verf√ºgbaren Lead-Status f√ºr Kontakte und Unternehmen</p>
                    </div>

                    <div style="background: white; padding: 24px; border-radius: 12px;">
                        <div id="leadStatusesList"></div>
                        <button class="btn btn-secondary mt-3" onclick="addLeadStatus()">+ Neuer Status hinzuf√ºgen</button>
                    </div>
                </div>

                <!-- General Settings Tab -->
                <div id="settings-general" class="settings-tab-content hidden">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Allgemeine Einstellungen</h2>
                        <p style="color: var(--text-secondary);">Konfigurieren Sie grundlegende CRM-Einstellungen</p>
                    </div>

                    <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 16px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Unternehmensinfo</h3>
                        <div class="form-group">
                            <label class="form-label">Firmenname</label>
                            <input type="text" class="form-input" id="companyNameSetting" placeholder="Ihr Firmenname">
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-Mail</label>
                            <input type="email" class="form-input" id="companyEmailSetting" placeholder="info@firma.de">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefon</label>
                            <input type="tel" class="form-input" id="companyPhoneSetting" placeholder="+49 123 456789">
                        </div>
                        <button class="btn btn-primary" onclick="saveGeneralSettings()">Speichern</button>
                    </div>

                    <div style="background: white; padding: 24px; border-radius: 12px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Erinnerungen</h3>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="enableReminders" class="select-checkbox">
                                <span>Aufgaben-Erinnerungen aktivieren</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Erinnerung vor F√§lligkeit (Tage)</label>
                            <input type="number" class="form-input" id="reminderDays" value="1" min="0" max="30">
                        </div>
                        <button class="btn btn-primary" onclick="saveGeneralSettings()">Speichern</button>
                    </div>
                </div>

                <!-- Backup Tab -->
                <div id="settings-backup" class="settings-tab-content hidden">
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Datensicherung</h2>
                        <p style="color: var(--text-secondary);">Sichern und wiederherstellen Sie Ihre CRM-Daten</p>
                    </div>

                    <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 16px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Backup erstellen</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">
                            Exportieren Sie alle Ihre CRM-Daten als JSON-Datei. Diese Datei kann sp√§ter wiederhergestellt werden.
                        </p>
                        <button class="btn btn-primary" onclick="createBackup()">üì• Backup herunterladen</button>
                    </div>

                    <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 16px;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Backup wiederherstellen</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">
                            Laden Sie eine zuvor erstellte Backup-Datei hoch. <strong>Achtung:</strong> Dies √ºberschreibt alle aktuellen Daten!
                        </p>
                        <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="restoreBackup(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('backupFileInput').click()">üì§ Backup hochladen</button>
                    </div>

                    <div style="background: #FFEBEE; padding: 24px; border-radius: 12px; border-left: 4px solid #C62828;">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #C62828;">Alle Daten l√∂schen</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">
                            L√∂scht alle Kontakte, Unternehmen, Deals, Aufgaben und Einstellungen unwiderruflich.
                        </p>
                        <button class="btn btn-secondary" style="background: #C62828; color: white;" onclick="deleteAllData()">üóëÔ∏è Alle Daten l√∂schen</button>
                    </div>
                </div>
            </div>

            <!-- Inactive Customers View -->
            <div id="inactive-view" class="view-content hidden">
                <div class="header">
                    <h1>Inaktive Kontakte</h1>
                    <button class="btn btn-secondary" onclick="updateInactiveCustomers()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                        </svg>
                        Aktualisieren
                    </button>
                </div>

                <div style="background: #fef3c7; padding: 16px; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <div style="font-size: 24px;">‚ö†Ô∏è</div>
                        <div>
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">Kontaktpflege-Monitor</div>
                            <div style="color: #78350f; font-size: 14px;">
                                Diese √úbersicht zeigt Kontakte bei denen l√§ngere Zeit keine Aktivit√§t stattgefunden hat. 
                                Nutzen Sie diese Liste f√ºr proaktives Follow-up und Kontaktpflege.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter & Settings -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Inaktivit√§tsschwelle</label>
                            <select id="inactivityThreshold" onchange="updateInactiveCustomers()" class="form-select">
                                <option value="7">7 Tage</option>
                                <option value="14">14 Tage</option>
                                <option value="30" selected>30 Tage</option>
                                <option value="60">60 Tage</option>
                                <option value="90">90 Tage</option>
                                <option value="180">6 Monate</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Sortierung</label>
                            <select id="inactivitySort" onchange="updateInactiveCustomers()" class="form-select">
                                <option value="oldest">√Ñlteste zuerst</option>
                                <option value="newest">Neueste zuerst</option>
                                <option value="value">Nach Umsatz</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Typ</label>
                            <select id="inactivityType" onchange="updateInactiveCustomers()" class="form-select">
                                <option value="all">Alle</option>
                                <option value="companies">Nur Unternehmen</option>
                                <option value="contacts">Nur Kontakte</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444;">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">INAKTIVE GESAMT</div>
                        <div id="inactiveSummaryCount" style="font-size: 32px; font-weight: 700; color: #ef4444;">0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">√ò TAGE INAKTIV</div>
                        <div id="inactiveSummaryAvgDays" style="font-size: 32px; font-weight: 700; color: #f59e0b;">0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #1e40af;">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">UMSATZ-RISIKO</div>
                        <div id="inactiveSummaryRisk" style="font-size: 32px; font-weight: 700; color: #1e40af;">‚Ç¨ 0</div>
                    </div>
                </div>

                <!-- Inactive Customers List -->
                <div id="inactiveCustomersContainer"></div>
            </div>

            <!-- Tasks View -->
            <div id="tasks-view" class="view-content hidden">
                <div class="header">
                    <h1>Aufgaben</h1>
                    <button class="btn btn-primary" onclick="openTaskModal()">+ Neue Aufgabe</button>
                </div>
                
                <div id="tasksBulkActions" class="bulk-actions">
                    <span class="bulk-actions-text"><span id="tasksSelectedCount">0</span> ausgew√§hlt</span>
                    <button class="bulk-action-btn" onclick="deselectAllTasks()">Abw√§hlen</button>
                    <button class="bulk-action-btn delete" onclick="bulkDeleteTasks()">L√∂schen</button>
                </div>
                
                <div class="filters">
                    <select class="form-select" id="taskEmployeeFilter" onchange="filterTasks()">
                        <option value="">Alle Mitarbeiter</option>
                    </select>
                    <select class="form-select" id="taskStatusFilter" onchange="filterTasks()">
                        <option value="">Alle Status</option>
                        <option value="offen">Offen</option>
                        <option value="erledigt">Erledigt</option>
                    </select>
                </div>
                
                <div class="select-all-container" onclick="toggleSelectAllTasks()">
                    <input type="checkbox" id="selectAllTasks" class="select-checkbox" onclick="event.stopPropagation(); toggleSelectAllTasks()">
                    <label for="selectAllTasks" style="cursor: pointer; user-select: none;">Alle ausw√§hlen</label>
                </div>
                
                <div id="tasksContainer"></div>
            </div>

            <!-- Contact Detail View -->
            <div id="contact-detail-view" class="detail-view"></div>

            <!-- Company Detail View -->
            <div id="company-detail-view" class="detail-view"></div>
            
            <!-- Deal Detail View -->
            <div id="deal-detail-view" class="detail-view"></div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="contactModalTitle">Neuer Kontakt</h2>
                <button class="close-btn" onclick="closeContactModal()">&times;</button>
            </div>
            
            <form id="contactForm">
                <input type="hidden" id="contactId">
                
                <div class="form-group">
                    <label class="form-label">Vorname</label>
                    <input type="text" class="form-input" id="contactFirstName">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nachname</label>
                    <input type="text" class="form-input" id="contactLastName">
                </div>
                
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" class="form-input" id="contactEmail">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telefonnummer</label>
                    <input type="tel" class="form-input" id="contactPhone">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Position</label>
                    <select class="form-select" id="contactPosition" onchange="toggleCustomPosition()">
                        <option value="">Keine Angabe</option>
                        <option value="Gesch√§ftsf√ºhrer">Gesch√§ftsf√ºhrer</option>
                        <option value="CEO">CEO</option>
                        <option value="CFO">CFO</option>
                        <option value="CTO">CTO</option>
                        <option value="Marketing Manager">Marketing Manager</option>
                        <option value="Sales Manager">Sales Manager</option>
                        <option value="Vertriebsleiter">Vertriebsleiter</option>
                        <option value="Einkaufsleiter">Einkaufsleiter</option>
                        <option value="HR Manager">HR Manager</option>
                        <option value="Projektmanager">Projektmanager</option>
                        <option value="__custom__">+ Eigene Position hinzuf√ºgen</option>
                    </select>
                </div>
                
                <div id="customPositionField" class="form-group hidden">
                    <label class="form-label">Eigene Position</label>
                    <input type="text" class="form-input" id="customPositionInput">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;" id="selectedTags"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="newTagInput" placeholder="Neues Tag hinzuf√ºgen" style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="addTag()">+</button>
                    </div>
                    ${availableTags.length > 0 ? `
                        <div style="margin-top: 12px;">
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Vorhandene Tags:</div>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;" id="availableTagsList">
                                ${availableTags.map(tag => `
                                    <span class="badge badge-kontakt" style="cursor: pointer;" onclick="selectExistingTag('${tag}')">${tag}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Unternehmen</label>
                    <select class="form-select" id="contactCompany" onchange="toggleNewCompany()">
                        <option value="">Kein Unternehmen</option>
                        <option value="__new__">+ Neues Unternehmen erstellen</option>
                    </select>
                </div>
                
                <div id="newCompanyFields" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Unternehmensname</label>
                        <input type="text" class="form-input" id="newCompanyName">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Branche</label>
                        <input type="text" class="form-input" id="newCompanyIndustry">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Lead Status</label>
                    <select class="form-select" id="contactStatus">
                        <option value="Einfacher Kontakt">Einfacher Kontakt</option>
                        <option value="Akquise">Akquise</option>
                        <option value="In Bearbeitung">In Bearbeitung</option>
                        <option value="Kunde">Kunde</option>
                        <option value="Ehemaliger Kunde">Ehemaliger Kunde</option>
                        <option value="Partner">Partner</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Leistungen</label>
                    <div class="checkbox-group">
                        <div class="services-section">
                            <div class="service-category">Marketing</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-seo" value="Marketing - SEO" name="service">
                                <label for="service-seo">SEO</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-seoblog" value="Marketing - SEO Blog" name="service">
                                <label for="service-seoblog">SEO Blog</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-sea" value="Marketing - SEA" name="service">
                                <label for="service-sea">SEA</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-social" value="Marketing - Social Media" name="service">
                                <label for="service-social">Social Media</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-rundummarketing" value="Marketing - Rundum Marketing" name="service">
                                <label for="service-rundummarketing">Rundum Marketing</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-website" value="Marketing - Website" name="service">
                                <label for="service-website">Website</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-webshop" value="Marketing - Webshop" name="service">
                                <label for="service-webshop">Webshop</label>
                            </div>
                        </div>
                        
                        <div class="services-section">
                            <div class="service-category">Unternehmensberatung</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-vertriebsopt" value="Unternehmensberatung - Vertriebsoptimierung" name="service">
                                <label for="service-vertriebsopt">Vertriebsoptimierung</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-vertriebsber" value="Unternehmensberatung - Vertriebsberatung" name="service">
                                <label for="service-vertriebsber">Vertriebsberatung</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-crmber" value="Unternehmensberatung - CRM Beratung" name="service">
                                <label for="service-crmber">CRM Beratung</label>
                            </div>
                        </div>
                        
                        <div class="services-section">
                            <div class="service-category">Leadinfo</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-testphase" value="Leadinfo - Testphase" name="service">
                                <label for="service-testphase">Testphase</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-einrichten" value="Leadinfo - Einrichten" name="service">
                                <label for="service-einrichten">Einrichten</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-controlling" value="Leadinfo - Vertriebscontrolling" name="service">
                                <label for="service-controlling">Vertriebscontrolling</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-marathon" value="Leadinfo - Leadmarathon" name="service">
                                <label for="service-marathon">Leadmarathon</label>
                            </div>
                        </div>
                        
                        <div class="custom-service">
                            <input type="text" class="form-input" id="customService" placeholder="Eigene Leistung hinzuf√ºgen">
                            <button type="button" class="btn btn-secondary" onclick="addCustomService()">+</button>
                        </div>
                        <div id="customServicesList"></div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveContact()">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeContactModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Deal Modal -->
    <div id="dealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Neuer Deal</h2>
                <button class="close-btn" onclick="closeDealModal()">&times;</button>
            </div>
            
            <form id="dealForm">
                <input type="hidden" id="dealCompanyId">
                <input type="hidden" id="dealPdfData">
                
                <div class="form-group">
                    <label class="form-label">Deal Name</label>
                    <input type="text" class="form-input" id="dealName">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Deal Wert (‚Ç¨)</label>
                    <input type="number" class="form-input" id="dealValue" step="0.01" onchange="updateDealValuePreview()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Zahlungsmodell</label>
                    <select class="form-select" id="dealPaymentModel" onchange="togglePaymentFields()">
                        <option value="one-time">Einmalzahlung</option>
                        <option value="monthly">Monatlich (Abo/Vertrag)</option>
                        <option value="quarterly">Viertelj√§hrlich</option>
                        <option value="yearly">J√§hrlich</option>
                    </select>
                </div>
                
                <div id="recurringFields" class="form-group hidden">
                    <label class="form-label">Vertragslaufzeit (Monate)</label>
                    <input type="number" class="form-input" id="dealContractDuration" min="1" value="12" onchange="updateDealValuePreview()">
                    <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-left: 4px solid #1e40af; border-radius: 4px;">
                        <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">Umsatz√ºbersicht</div>
                        <div id="dealValuePreview" style="font-size: 13px; color: #64748b;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hauptverantwortlicher (BBC Mitarbeiter)</label>
                    <select class="form-select" id="dealResponsiblePerson">
                        <option value="">Nicht zugewiesen</option>
                    </select>
                    <small style="color: #64748b; font-size: 12px; display: block; margin-top: 6px;">
                        üí° Wird f√ºr Top Performer Ranking verwendet
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Angebot als PDF hochladen</label>
                    <input type="file" class="form-input" id="dealPdfFile" accept=".pdf" onchange="handlePdfUpload(event)">
                    <div id="pdfFileName" style="margin-top: 8px; font-size: 13px; color: var(--text-secondary);"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Leistungen</label>
                    <div class="checkbox-group" id="dealServicesCheckboxes"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Unternehmensbewertung (Score)</label>
                    <div class="score-stars" id="dealScore">
                        <span class="star" data-score="1">‚òÖ</span>
                        <span class="star" data-score="2">‚òÖ</span>
                        <span class="star" data-score="3">‚òÖ</span>
                        <span class="star" data-score="4">‚òÖ</span>
                        <span class="star" data-score="5">‚òÖ</span>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveDeal()">Deal erstellen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeDealModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Neue Aufgabe</h2>
                <button class="close-btn" onclick="closeTaskModal()">&times;</button>
            </div>
            
            <form id="taskForm">
                <input type="hidden" id="taskContactId">
                
                <div class="form-group">
                    <label class="form-label">Aufgabe *</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <div style="position: relative;">
                        <textarea class="form-input" id="taskDescription" rows="3" style="padding-right: 50px;"></textarea>
                        <button type="button"
                                class="btn btn-secondary"
                                data-voice-target="taskDescription"
                                onclick="toggleVoiceInput('taskDescription', true)"
                                style="position: absolute; right: 8px; top: 8px; padding: 8px 12px; min-width: auto; background: #667eea;"
                                title="Spracherkennung">
                            üé§
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">F√§lligkeitsdatum</label>
                    <input type="date" class="form-input" id="taskDueDate">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Zugewiesen an (BBC Mitarbeiter)</label>
                    <select class="form-select" id="taskAssignee">
                        <option value="">Nicht zugewiesen</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Unternehmen</label>
                    <select class="form-select" id="taskCompany" onchange="updateTaskContactDropdown()">
                        <option value="">Kein Unternehmen</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ansprechpartner (im Unternehmen)</label>
                    <select class="form-select" id="taskContact">
                        <option value="">Kein Ansprechpartner</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Deal zuordnen</label>
                    <select class="form-select" id="taskDeal">
                        <option value="">Kein Deal</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Priorit√§t</label>
                    <select class="form-select" id="taskPriority">
                        <option value="niedrig">Niedrig</option>
                        <option value="mittel" selected>Mittel</option>
                        <option value="hoch">Hoch</option>
                    </select>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveTask()">Aufgabe erstellen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Best√§tigung</h2>
            </div>
            
            <p id="confirmMessage" style="margin-bottom: 24px; color: var(--text-primary);"></p>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Abbrechen</button>
                <button type="button" class="btn btn-primary" style="background: #C62828;" onclick="confirmDelete()">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Protocol Entry Modal -->
    <div id="protocolModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Protokolleintrag hinzuf√ºgen</h2>
                <button class="close-btn" onclick="closeProtocolModal()">&times;</button>
            </div>
            
            <form id="protocolForm">
                <input type="hidden" id="protocolEntityType">
                <input type="hidden" id="protocolEntityId">
                
                <!-- Aktivit√§tstyp Auswahl -->
                <div class="form-group">
                    <label class="form-label">Aktivit√§tstyp</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 16px;">
                        <button type="button" class="activity-type-btn" data-type="call" onclick="selectActivityType('call')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            <span>Telefonat</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="meeting" onclick="selectActivityType('meeting')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <span>Meeting</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="email" onclick="selectActivityType('email')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <span>E-Mail</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="video" onclick="selectActivityType('video')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="23 7 16 12 23 17 23 7"/>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                            </svg>
                            <span>Video-Call</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="visit" onclick="selectActivityType('visit')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                            <span>Besuch</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="note" onclick="selectActivityType('note')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                            <span>Notiz</span>
                        </button>
                    </div>
                    <input type="hidden" id="protocolActivityType" value="note">
                </div>
                
                <!-- Quick Templates -->
                <div id="protocolTemplates" class="form-group" style="display: none;">
                    <label class="form-label">Schnellvorlagen</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;" id="protocolTemplateButtons"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notiz</label>
                    <div style="position: relative;">
                        <textarea class="form-input" id="protocolNote" rows="6" placeholder="Was wurde besprochen? Welche Vereinbarungen wurden getroffen?" style="padding-right: 50px;"></textarea>
                        <button type="button" 
                                class="btn btn-secondary" 
                                data-voice-target="protocolNote"
                                onclick="toggleVoiceInput('protocolNote', true)" 
                                style="position: absolute; right: 8px; top: 8px; padding: 8px 12px; min-width: auto; background: #667eea;"
                                title="Spracherkennung starten/stoppen">
                            üé§
                        </button>
                    </div>
                    <small style="color: #64748b; font-size: 12px; display: block; margin-top: 6px;">
                        üí° Tipp: W√§hlen Sie einen Aktivit√§tstyp f√ºr Schnellvorlagen oder nutzen Sie Spracherkennung
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Autor (optional)</label>
                    <input type="text" class="form-input" id="protocolAuthor" placeholder="Ihr Name">
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveProtocolEntry()">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProtocolModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
    
    <style>
        .activity-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }
        
        .activity-type-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            color: #667eea;
        }
        
        .activity-type-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .activity-type-btn svg {
            stroke: currentColor;
        }
        
        .template-btn {
            padding: 6px 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #475569;
            transition: all 0.2s;
        }
        
        .template-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }
    </style>

    <!-- Company Edit Modal -->
    <div id="companyEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="companyEditModalTitle">Unternehmen bearbeiten</h2>
                <button class="close-btn" onclick="closeCompanyEditModal()">&times;</button>
            </div>
            
            <form id="companyEditForm">
                <input type="hidden" id="companyEditId">
                
                <div class="form-group">
                    <label class="form-label">Unternehmensname</label>
                    <input type="text" class="form-input" id="companyEditName">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Branche</label>
                    <input type="text" class="form-input" id="companyEditIndustry">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stra√üe & Hausnummer</label>
                    <input type="text" class="form-input" id="companyEditStreet" placeholder="Musterstra√üe 123">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">PLZ</label>
                        <input type="text" class="form-input" id="companyEditZip" placeholder="12345">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Stadt</label>
                        <input type="text" class="form-input" id="companyEditCity" placeholder="Berlin">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Land</label>
                    <input type="text" class="form-input" id="companyEditCountry" placeholder="Deutschland">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telefon</label>
                    <input type="tel" class="form-input" id="companyEditPhone" placeholder="+49 123 456789">
                </div>
                
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" class="form-input" id="companyEditEmail" placeholder="info@unternehmen.de">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" class="form-input" id="companyEditWebsite" placeholder="https://www.unternehmen.de">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Umsatzsteuer-ID</label>
                    <input type="text" class="form-input" id="companyEditVatId" placeholder="DE123456789">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Handelsregisternummer</label>
                    <input type="text" class="form-input" id="companyEditRegisterNumber" placeholder="HRB 12345">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-input" id="companyEditNotes" rows="4" placeholder="Weitere Informationen zum Unternehmen..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Lead Status</label>
                    <select class="form-select" id="companyEditStatus">
                        <option value="Einfacher Kontakt">Einfacher Kontakt</option>
                        <option value="Akquise">Akquise</option>
                        <option value="In Bearbeitung">In Bearbeitung</option>
                        <option value="Kunde">Kunde</option>
                        <option value="Ehemaliger Kunde">Ehemaliger Kunde</option>
                        <option value="Partner">Partner</option>
                    </select>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveCompanyEdit()">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCompanyEditModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSV Import Mapping Modal -->
    <div id="csvMappingModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">CSV-Import: Felder zuordnen</h2>
                <button class="close-btn" onclick="closeCsvMappingModal()">&times;</button>
            </div>
            
            <p style="margin-bottom: 24px; color: var(--text-secondary);">
                Ordnen Sie die Spalten Ihrer CSV-Datei den CRM-Feldern zu. Felder die Sie nicht zuordnen werden ignoriert.
            </p>
            
            <div style="background: var(--bg-main); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="font-weight: 600; margin-bottom: 8px;">Gefundene Zeilen: <span id="csvRowCount">0</span></div>
                <div style="font-size: 13px; color: var(--text-secondary);">Erste Zeile wird als Kopfzeile verwendet</div>
            </div>
            
            <div class="form-group" style="margin-bottom: 24px;">
                <label class="form-label">Tag f√ºr alle importierten Kontakte (optional)</label>
                <input type="text" class="form-input" id="csvImportTag" placeholder="z.B. 'Import 2026', 'Messe M√ºnchen', 'Neukunden'">
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">
                    Wenn Sie hier einen Tag eingeben, wird dieser automatisch allen importierten Kontakten zugeordnet.
                </div>
            </div>
            
            <div id="csvMappingFields" style="max-height: 400px; overflow-y: auto;"></div>
            
            <div style="margin-top: 24px; padding: 16px; background: #FFF3E0; border-radius: 8px; border-left: 4px solid #FF9800;">
                <div style="font-weight: 600; margin-bottom: 8px;">Hinweis:</div>
                <div style="font-size: 13px; color: var(--text-primary);">
                    Wenn ein Unternehmensname angegeben ist, wird automatisch ein neues Unternehmen erstellt oder ein bestehendes Unternehmen mit gleichem Namen verwendet.
                </div>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="executeCSVImport()">Importieren</button>
                <button type="button" class="btn btn-secondary" onclick="closeCsvMappingModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Employee Edit Modal -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="employeeModalTitle">Mitarbeiter bearbeiten</h2>
                <button class="close-btn" onclick="closeEmployeeModal()">&times;</button>
            </div>
            
            <form id="employeeForm">
                <input type="hidden" id="employeeId">
                
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="employeeName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Position</label>
                    <input type="text" class="form-input" id="employeePosition" placeholder="z.B. Sales Manager, Marketing Leiter">
                </div>
                
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" class="form-input" id="employeeEmail" placeholder="mitarbeiter@firma.de">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telefon</label>
                    <input type="tel" class="form-input" id="employeePhone" placeholder="+49 123 456789">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select class="form-select" id="employeeDepartment">
                        <option value="">Keine Abteilung</option>
                        <option value="Vertrieb">Vertrieb</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Kundenservice">Kundenservice</option>
                        <option value="Management">Management</option>
                        <option value="IT">IT</option>
                        <option value="Beratung">Beratung</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-input" id="employeeNotes" rows="3" placeholder="Weitere Informationen..."></textarea>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveEmployee()">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Services Edit Modal -->
    <div id="servicesEditModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="servicesEditModalTitle">Leistungen bearbeiten</h2>
                <button class="close-btn" onclick="closeServicesEditModal()">&times;</button>
            </div>
            
            <input type="hidden" id="servicesEditEntityType">
            <input type="hidden" id="servicesEditEntityId">
            
            <div class="form-group">
                <label class="form-label">Ausgew√§hlte Leistungen</label>
                <div id="currentServicesList" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; padding: 12px; background: var(--bg-main); border-radius: 8px; margin-bottom: 16px;">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Leistungen hinzuf√ºgen/entfernen</label>
                <div style="max-height: 400px; overflow-y: auto; border: 2px solid var(--border); border-radius: 8px; padding: 16px;">
                    <div class="services-section">
                        <div class="service-category">Marketing</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-seo" value="Marketing - SEO" name="edit-service">
                            <label for="edit-service-seo">SEO</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-seoblog" value="Marketing - SEO Blog" name="edit-service">
                            <label for="edit-service-seoblog">SEO Blog</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-sea" value="Marketing - SEA" name="edit-service">
                            <label for="edit-service-sea">SEA</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-social" value="Marketing - Social Media" name="edit-service">
                            <label for="edit-service-social">Social Media</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-rundummarketing" value="Marketing - Rundum Marketing" name="edit-service">
                            <label for="edit-service-rundummarketing">Rundum Marketing</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-website" value="Marketing - Website" name="edit-service">
                            <label for="edit-service-website">Website</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-webshop" value="Marketing - Webshop" name="edit-service">
                            <label for="edit-service-webshop">Webshop</label>
                        </div>
                    </div>
                    
                    <div class="services-section">
                        <div class="service-category">Unternehmensberatung</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-vertriebsopt" value="Unternehmensberatung - Vertriebsoptimierung" name="edit-service">
                            <label for="edit-service-vertriebsopt">Vertriebsoptimierung</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-vertriebsber" value="Unternehmensberatung - Vertriebsberatung" name="edit-service">
                            <label for="edit-service-vertriebsber">Vertriebsberatung</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-crmber" value="Unternehmensberatung - CRM Beratung" name="edit-service">
                            <label for="edit-service-crmber">CRM Beratung</label>
                        </div>
                    </div>
                    
                    <div class="services-section">
                        <div class="service-category">Leadinfo</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="edit-service-leadinfo" value="Leadinfo - Leadinfo" name="edit-service">
                            <label for="edit-service-leadinfo">Leadinfo</label>
                        </div>
                    </div>
                    
                    <div id="editCustomServicesList"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Eigene Leistung hinzuf√ºgen</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-input" id="editNewServiceInput" placeholder="Neue Leistung" style="flex: 1;">
                    <button type="button" class="btn btn-secondary" onclick="addCustomServiceToEdit()">+</button>
                </div>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="saveServicesEdit()">Speichern</button>
                <button type="button" class="btn btn-secondary" onclick="closeServicesEditModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Employee Edit Modal -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="employeeModalTitle">Mitarbeiter bearbeiten</h2>
                <button class="close-btn" onclick="closeEmployeeModal()">&times;</button>
            </div>
            
            <form id="employeeForm">
                <input type="hidden" id="employeeId">
                
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="employeeName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Position</label>
                    <input type="text" class="form-input" id="employeePosition" placeholder="z.B. Sales Manager, Marketing Leiter">
                </div>
                
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" class="form-input" id="employeeEmail" placeholder="mitarbeiter@firma.de">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telefon</label>
                    <input type="tel" class="form-input" id="employeePhone" placeholder="+49 123 456789">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select class="form-select" id="employeeDepartment">
                        <option value="">Keine Abteilung</option>
                        <option value="Vertrieb">Vertrieb</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Kundenservice">Kundenservice</option>
                        <option value="Management">Management</option>
                        <option value="IT">IT</option>
                        <option value="Beratung">Beratung</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-input" id="employeeNotes" rows="3" placeholder="Weitere Informationen..."></textarea>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="saveEmployee()">Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEmployeeModal()">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSV Import Mapping Modal -->
    <div id="csvMappingModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">CSV-Import: Felder zuordnen</h2>
                <button class="close-btn" onclick="closeCsvMappingModal()">&times;</button>
            </div>
            
            <p style="margin-bottom: 24px; color: var(--text-secondary);">
                Ordnen Sie die Spalten Ihrer CSV-Datei den CRM-Feldern zu. Felder die Sie nicht zuordnen werden ignoriert.
            </p>
            
            <div style="background: var(--bg-main); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="font-weight: 600; margin-bottom: 8px;">Gefundene Zeilen: <span id="csvRowCount">0</span></div>
                <div style="font-size: 13px; color: var(--text-secondary);">Erste Zeile wird als Kopfzeile verwendet</div>
            </div>
            
            <div class="form-group" style="margin-bottom: 24px;">
                <label class="form-label">Tag f√ºr alle importierten Kontakte (optional)</label>
                <input type="text" class="form-input" id="csvImportTag" placeholder="z.B. 'Import 2026', 'Messe M√ºnchen', 'Neukunden'">
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">
                    Wenn Sie hier einen Tag eingeben, wird dieser automatisch allen importierten Kontakten zugeordnet.
                </div>
            </div>
            
            <div id="csvMappingFields" style="max-height: 400px; overflow-y: auto;"></div>
            
            <div style="margin-top: 24px; padding: 16px; background: #FFF3E0; border-radius: 8px; border-left: 4px solid #FF9800;">
                <div style="font-weight: 600; margin-bottom: 8px;">Hinweis:</div>
                <div style="font-size: 13px; color: var(--text-primary);">
                    Wenn ein Unternehmensname angegeben ist, wird automatisch ein neues Unternehmen erstellt oder ein bestehendes Unternehmen mit gleichem Namen verwendet.
                </div>
            </div>
            
            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="executeCSVImport()">Importieren</button>
                <button type="button" class="btn btn-secondary" onclick="closeCsvMappingModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        // ==========================================
        // STORAGE SYSTEM (funktioniert auch auf GitHub Pages)
        // ==========================================
        
        const Storage = {
            // Test ob localStorage verf√ºgbar ist
            isAvailable: function() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch(e) {
                    return false;
                }
            },
            
            // Speichern mit Fallback
            setItem: function(key, value) {
                try {
                    if (this.isAvailable()) {
                        localStorage.setItem(key, value);
                        return true;
                    } else {
                        // Fallback: Daten im Memory speichern
                        if (!window._fallbackStorage) window._fallbackStorage = {};
                        window._fallbackStorage[key] = value;
                        console.warn('localStorage nicht verf√ºgbar - verwende Fallback');
                        return true;
                    }
                } catch(e) {
                    console.error('Speichern fehlgeschlagen:', e);
                    // Notfall-Fallback
                    if (!window._fallbackStorage) window._fallbackStorage = {};
                    window._fallbackStorage[key] = value;
                    return false;
                }
            },
            
            // Laden mit Fallback
            getItem: function(key) {
                try {
                    if (this.isAvailable()) {
                        return localStorage.getItem(key);
                    } else {
                        // Fallback: Aus Memory laden
                        if (window._fallbackStorage && window._fallbackStorage[key]) {
                            return window._fallbackStorage[key];
                        }
                        return null;
                    }
                } catch(e) {
                    console.error('Laden fehlgeschlagen:', e);
                    // Notfall-Fallback
                    if (window._fallbackStorage && window._fallbackStorage[key]) {
                        return window._fallbackStorage[key];
                    }
                    return null;
                }
            },
            
            // L√∂schen mit Fallback
            removeItem: function(key) {
                try {
                    if (this.isAvailable()) {
                        localStorage.removeItem(key);
                    }
                    if (window._fallbackStorage) {
                        delete window._fallbackStorage[key];
                    }
                } catch(e) {
                    console.error('L√∂schen fehlgeschlagen:', e);
                }
            }
        };
        
        // Warnung anzeigen wenn localStorage nicht verf√ºgbar
        if (!Storage.isAvailable()) {
            console.warn('localStorage ist nicht verf√ºgbar!');
            console.warn('üìù Verwende Fallback-Speicher (Session)');
            console.warn('üí° WICHTIG: Daten gehen beim Schlie√üen verloren!');
            console.warn('üîß L√∂sung: Verwenden Sie eine eigene Domain oder Netlify');
        }
        
        // Daten laden (mit Storage-System)
        let contacts = JSON.parse(Storage.getItem('bbc_contacts') || '[]');
        let companies = JSON.parse(Storage.getItem('bbc_companies') || '[]');
        let deals = JSON.parse(Storage.getItem('bbc_deals') || '[]');
        let tasks = JSON.parse(Storage.getItem('bbc_tasks') || '[]');
        let employees = JSON.parse(Storage.getItem('bbc_employees') || '[]');
        
        // Initialize default employees if empty
        if (employees.length === 0) {
            employees = [
                { id: '1', name: 'Max Mustermann' },
                { id: '2', name: 'Anna Schmidt' },
                { id: '3', name: 'Tom Krause' }
            ];
            Storage.setItem('bbc_employees', JSON.stringify(employees));
        }
        
        let customServices = JSON.parse(Storage.getItem('bbc_custom_services') || '[]');
        let availableTags = JSON.parse(Storage.getItem('bbc_available_tags') || '[]');
        let orders = JSON.parse(Storage.getItem('bbc_orders') || '[]');
        let reminders = JSON.parse(Storage.getItem('bbc_reminders') || '[]');
        let emailTemplates = JSON.parse(Storage.getItem('bbc_email_templates') || '[]');
        
        // Initialize default email templates if empty
        if (emailTemplates.length === 0) {
            emailTemplates = [
                {
                    id: '1',
                    name: 'Angebot',
                    subject: 'Ihr Angebot von BBC',
                    body: `Sehr geehrte/r [Name],

vielen Dank f√ºr Ihr Interesse an unseren Leistungen.

Anbei erhalten Sie unser Angebot f√ºr:
[Leistungen]

Gesamtpreis: [Preis]

Bei Fragen stehen wir Ihnen jederzeit gerne zur Verf√ºgung.

Mit freundlichen Gr√º√üen
Ihr BBC Team`
                },
                {
                    id: '2',
                    name: 'Follow-Up',
                    subject: 'Nachfrage zu unserem Angebot',
                    body: `Sehr geehrte/r [Name],

ich m√∂chte mich bez√ºglich unseres Angebots vom [Datum] bei Ihnen melden.

Haben Sie bereits Gelegenheit gehabt, unser Angebot zu pr√ºfen? Gerne beantworte ich offene Fragen oder vereinbare einen Termin f√ºr ein pers√∂nliches Gespr√§ch.

Ich freue mich auf Ihre R√ºckmeldung.

Mit freundlichen Gr√º√üen
Ihr BBC Team`
                },
                {
                    id: '3',
                    name: 'Auftragsbest√§tigung',
                    subject: 'Auftragsbest√§tigung',
                    body: `Sehr geehrte/r [Name],

vielen Dank f√ºr Ihren Auftrag!

Wir best√§tigen hiermit die Beauftragung f√ºr:
[Leistungen]

Auftragsnummer: [Auftragsnummer]
Projektstart: [Datum]

Wir freuen uns auf die Zusammenarbeit!

Mit freundlichen Gr√º√üen
Ihr BBC Team`
                },
                {
                    id: '4',
                    name: 'Terminbest√§tigung',
                    subject: 'Terminbest√§tigung',
                    body: `Sehr geehrte/r [Name],

hiermit best√§tige ich unseren Termin am [Datum] um [Uhrzeit] Uhr.

Thema: [Thema]
Ort: [Ort]

Bei Fragen melden Sie sich gerne.

Mit freundlichen Gr√º√üen
Ihr BBC Team`
                },
                {
                    id: '5',
                    name: 'Danke f√ºr Gespr√§ch',
                    subject: 'Vielen Dank f√ºr das Gespr√§ch',
                    body: `Sehr geehrte/r [Name],

vielen Dank f√ºr das interessante Gespr√§ch heute.

Wie besprochen sende ich Ihnen [Details] bis [Datum] zu.

Falls Sie noch Fragen haben, melden Sie sich gerne jederzeit.

Mit freundlichen Gr√º√üen
Ihr BBC Team`
                }
            ];
            Storage.setItem('bbc_email_templates', JSON.stringify(emailTemplates));
        }
        
        // Initialize employees with default structure if empty
        if (employees.length === 0) {
            employees = [
                { id: '1', name: 'Mitarbeiter 1', position: '', email: '', phone: '', notes: '' },
                { id: '2', name: 'Mitarbeiter 2', position: '', email: '', phone: '', notes: '' },
                { id: '3', name: 'Mitarbeiter 3', position: '', email: '', phone: '', notes: '' },
                { id: '4', name: 'Mitarbeiter 4', position: '', email: '', phone: '', notes: '' },
                { id: '5', name: 'Mitarbeiter 5', position: '', email: '', phone: '', notes: '' }
            ];
            Storage.setItem('bbc_employees', JSON.stringify(employees));
        }
        
        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Check reminders every minute
        setInterval(checkReminders, 60000);
        checkReminders(); // Check immediately on load
        
        // ==========================================
        // E-MAIL SYSTEM
        // ==========================================
        
        function openEmailModal(entityType, entityId) {
            let entity, email, name;
            
            if (entityType === 'contact') {
                entity = contacts.find(c => c.id === entityId);
                email = entity?.email;
                name = entity?.name;
            } else if (entityType === 'company') {
                entity = companies.find(c => c.id === entityId);
                // Use first contact of company
                const firstContact = contacts.find(c => c.companyId === entityId);
                email = firstContact?.email;
                name = entity?.name;
            } else if (entityType === 'deal') {
                entity = deals.find(d => d.id === entityId);
                const company = companies.find(c => c.id === entity?.companyId);
                const firstContact = contacts.find(c => c.companyId === entity?.companyId);
                email = firstContact?.email;
                name = company?.name || entity?.name;
            }
            
            if (!email) {
                alert('Keine E-Mail-Adresse vorhanden!');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'emailModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2 class="modal-title">E-Mail senden</h2>
                        <button class="close-btn" onclick="closeEmailModal()">&times;</button>
                    </div>
                    
                    <div style="padding: 8px 0; margin-bottom: 16px; background: var(--bg-main); border-radius: 8px; padding: 12px;">
                        <strong>An:</strong> ${email} (${name})
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Vorlage ausw√§hlen (optional)</label>
                        <select id="emailTemplate" class="form-select" onchange="loadEmailTemplate('${entityType}', '${entityId}')">
                            <option value="">Keine Vorlage - Leere E-Mail</option>
                            ${emailTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Betreff *</label>
                        <input type="text" id="emailSubject" class="form-input" placeholder="E-Mail Betreff">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nachricht *</label>
                        <textarea id="emailBody" class="form-input" rows="12" placeholder="E-Mail Text"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="emailSaveProtocol" checked>
                            <span>Automatisch Protokoll-Eintrag erstellen</span>
                        </label>
                    </div>
                    
                    <div style="background: #e0f2fe; border-left: 4px solid #0284c7; padding: 12px; border-radius: 4px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: #075985;">
                            <strong>Hinweis:</strong> Die E-Mail wird in Ihrem Standard-E-Mail-Programm ge√∂ffnet. Sie k√∂nnen dort weitere Anpassungen vornehmen, bevor Sie die E-Mail senden.
                        </div>
                    </div>
                    
                    <div class="mt-3" style="display: flex; gap: 12px;">
                        <button type="button" class="btn btn-primary" onclick="sendEmail('${entityType}', '${entityId}', '${email}', '${name}')">
                            E-Mail √∂ffnen
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            if (modal) modal.remove();
        }
        
        function loadEmailTemplate(entityType, entityId) {
            const templateId = document.getElementById('emailTemplate').value;
            if (!templateId) {
                document.getElementById('emailSubject').value = '';
                document.getElementById('emailBody').value = '';
                return;
            }
            
            const template = emailTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            let entity, name, services = '', price = '', orderNumber = '';
            
            // Get entity data
            if (entityType === 'contact') {
                entity = contacts.find(c => c.id === entityId);
                name = entity?.name || '[Name]';
                if (entity?.services) services = entity.services.join(', ');
            } else if (entityType === 'company') {
                entity = companies.find(c => c.id === entityId);
                name = entity?.name || '[Name]';
                if (entity?.services) services = entity.services.join(', ');
            } else if (entityType === 'deal') {
                entity = deals.find(d => d.id === entityId);
                const company = companies.find(c => c.id === entity?.companyId);
                name = company?.name || '[Name]';
                if (entity?.services) services = entity.services.join(', ');
                if (entity?.value) price = '‚Ç¨ ' + parseFloat(entity.value).toLocaleString('de-DE');
            }
            
            // Replace placeholders
            let subject = template.subject;
            let body = template.body;
            
            body = body.replace(/\[Name\]/g, name);
            body = body.replace(/\[Leistungen\]/g, services || '[Leistungen]');
            body = body.replace(/\[Preis\]/g, price || '[Preis]');
            body = body.replace(/\[Datum\]/g, new Date().toLocaleDateString('de-DE'));
            body = body.replace(/\[Auftragsnummer\]/g, orderNumber || '[Auftragsnummer]');
            
            document.getElementById('emailSubject').value = subject;
            document.getElementById('emailBody').value = body;
        }
        
        function sendEmail(entityType, entityId, email, name) {
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            const saveProtocol = document.getElementById('emailSaveProtocol').checked;
            
            if (!subject) {
                alert('Bitte geben Sie einen Betreff ein.');
                return;
            }
            
            if (!body) {
                alert('Bitte geben Sie eine Nachricht ein.');
                return;
            }
            
            // Create mailto link
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            // Save to protocol if requested
            if (saveProtocol) {
                const protocolEntry = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    note: `E-Mail gesendet: ${subject}\n\n${body.substring(0, 200)}${body.length > 200 ? '...' : ''}`,
                    author: 'System'
                };
                
                if (entityType === 'contact') {
                    const contact = contacts.find(c => c.id === entityId);
                    if (contact) {
                        if (!contact.protocol) contact.protocol = [];
                        contact.protocol.unshift(protocolEntry);
                        Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                    }
                } else if (entityType === 'company') {
                    const company = companies.find(c => c.id === entityId);
                    if (company) {
                        if (!company.protocol) company.protocol = [];
                        company.protocol.unshift(protocolEntry);
                        Storage.setItem('bbc_companies', JSON.stringify(companies));
                    }
                } else if (entityType === 'deal') {
                    const deal = deals.find(d => d.id === entityId);
                    if (deal) {
                        if (!deal.protocol) deal.protocol = [];
                        deal.protocol.unshift(protocolEntry);
                        Storage.setItem('bbc_deals', JSON.stringify(deals));
                    }
                }
            }
            
            closeEmailModal();
            showNotification('E-Mail ge√∂ffnet', 'Die E-Mail wurde in Ihrem E-Mail-Programm ge√∂ffnet.');
            
            // Refresh view
            if (entityType === 'contact') showContactDetail(entityId);
            else if (entityType === 'company') showCompanyDetail(entityId);
            else if (entityType === 'deal') showDealDetail(entityId);
        }
        
        // ==========================================
        // WIEDERVORLAGEN / ERINNERUNGEN
        // ==========================================
        
        function openReminderModal(entityType, entityId, entityName) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'reminderModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Wiedervorlage erstellen</h2>
                        <button class="close-btn" onclick="closeReminderModal()">&times;</button>
                    </div>
                    
                    <div style="padding: 8px 0; margin-bottom: 16px; background: var(--bg-main); border-radius: 8px; padding: 12px;">
                        <strong>F√ºr:</strong> ${entityName}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Zeitpunkt *</label>
                        <select id="reminderTime" class="form-select" onchange="toggleCustomReminderDate()">
                            <option value="1h">In 1 Stunde</option>
                            <option value="3h">In 3 Stunden</option>
                            <option value="1d">Morgen</option>
                            <option value="3d">In 3 Tagen</option>
                            <option value="1w">In 1 Woche</option>
                            <option value="2w">In 2 Wochen</option>
                            <option value="1m">In 1 Monat</option>
                            <option value="custom">Benutzerdefiniert...</option>
                        </select>
                    </div>
                    
                    <div id="customReminderDate" class="form-group" style="display: none;">
                        <label class="form-label">Datum & Uhrzeit</label>
                        <input type="datetime-local" id="reminderDateTime" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Erinnerungstext *</label>
                        <textarea id="reminderText" class="form-input" rows="3" placeholder="z.B. Kunde anrufen wegen Angebot"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reminderCreateTask" checked>
                            <span>Automatisch Aufgabe erstellen</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="reminderBrowserNotification" checked>
                            <span>Browser-Benachrichtigung anzeigen</span>
                        </label>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="createReminder('${entityType}', '${entityId}', '${entityName}')">
                            Wiedervorlage erstellen
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeReminderModal()">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            if (modal) modal.remove();
        }
        
        function toggleCustomReminderDate() {
            const timeSelect = document.getElementById('reminderTime');
            const customDiv = document.getElementById('customReminderDate');
            
            if (timeSelect.value === 'custom') {
                customDiv.style.display = 'block';
                // Set default to tomorrow 9:00
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);
                document.getElementById('reminderDateTime').value = tomorrow.toISOString().slice(0, 16);
            } else {
                customDiv.style.display = 'none';
            }
        }
        
        function createReminder(entityType, entityId, entityName) {
            const timeSelect = document.getElementById('reminderTime').value;
            const reminderText = document.getElementById('reminderText').value.trim();
            const createTask = document.getElementById('reminderCreateTask').checked;
            const browserNotification = document.getElementById('reminderBrowserNotification').checked;
            
            if (!reminderText) {
                alert('Bitte geben Sie einen Erinnerungstext ein.');
                return;
            }
            
            // Calculate reminder date
            let reminderDate;
            if (timeSelect === 'custom') {
                const customDateTime = document.getElementById('reminderDateTime').value;
                if (!customDateTime) {
                    alert('Bitte w√§hlen Sie ein Datum und eine Uhrzeit.');
                    return;
                }
                reminderDate = new Date(customDateTime);
            } else {
                reminderDate = new Date();
                switch(timeSelect) {
                    case '1h': reminderDate.setHours(reminderDate.getHours() + 1); break;
                    case '3h': reminderDate.setHours(reminderDate.getHours() + 3); break;
                    case '1d': reminderDate.setDate(reminderDate.getDate() + 1); break;
                    case '3d': reminderDate.setDate(reminderDate.getDate() + 3); break;
                    case '1w': reminderDate.setDate(reminderDate.getDate() + 7); break;
                    case '2w': reminderDate.setDate(reminderDate.getDate() + 14); break;
                    case '1m': reminderDate.setMonth(reminderDate.getMonth() + 1); break;
                }
            }
            
            const reminder = {
                id: Date.now().toString(),
                entityType: entityType,
                entityId: entityId,
                entityName: entityName,
                text: reminderText,
                reminderDate: reminderDate.toISOString(),
                createTask: createTask,
                browserNotification: browserNotification,
                triggered: false,
                createdAt: new Date().toISOString()
            };
            
            reminders.push(reminder);
            Storage.setItem('bbc_reminders', JSON.stringify(reminders));
            
            closeReminderModal();
            showNotification('Wiedervorlage erstellt', `Erinnerung f√ºr ${reminderDate.toLocaleDateString('de-DE')} um ${reminderDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})} Uhr`);
            
            // Update view if needed
            if (entityType === 'contact') {
                showContactDetail(entityId);
            } else if (entityType === 'company') {
                showCompanyDetail(entityId);
            } else if (entityType === 'deal') {
                showDealDetail(entityId);
            }
        }
        
        function checkReminders() {
            const now = new Date();
            let triggeredCount = 0;
            
            reminders.forEach(reminder => {
                if (reminder.triggered) return;
                
                const reminderDate = new Date(reminder.reminderDate);
                
                // Check if reminder time has passed
                if (now >= reminderDate) {
                    reminder.triggered = true;
                    triggeredCount++;
                    
                    // Create task if requested
                    if (reminder.createTask) {
                        const task = {
                            id: Date.now().toString() + Math.random(),
                            title: reminder.text,
                            description: `Wiedervorlage f√ºr: ${reminder.entityName}`,
                            dueDate: new Date().toISOString().split('T')[0],
                            assignee: '',
                            companyId: reminder.entityType === 'company' ? reminder.entityId : null,
                            contactId: reminder.entityType === 'contact' ? reminder.entityId : null,
                            dealId: reminder.entityType === 'deal' ? reminder.entityId : null,
                            priority: 'hoch',
                            status: 'offen',
                            createdAt: new Date().toISOString(),
                            overdue: false,
                            reminderSent: false
                        };
                        tasks.push(task);
                        Storage.setItem('bbc_tasks', JSON.stringify(tasks));
                    }
                    
                    // Show browser notification if requested
                    if (reminder.browserNotification && 'Notification' in window && Notification.permission === 'granted') {
                        new Notification('BBC CRM Erinnerung', {
                            body: reminder.text + '\n\nF√ºr: ' + reminder.entityName,
                            icon: '/favicon.ico',
                            tag: reminder.id
                        });
                    }
                    
                    // Show in-app notification
                    showNotification('Wiedervorlage f√§llig', reminder.text + ' - ' + reminder.entityName);
                }
            });
            
            if (triggeredCount > 0) {
                Storage.setItem('bbc_reminders', JSON.stringify(reminders));
                renderTasks();
                updateDashboard();
            }
        }
        
        function deleteReminder(reminderId) {
            const index = reminders.findIndex(r => r.id === reminderId);
            if (index > -1) {
                reminders.splice(index, 1);
                Storage.setItem('bbc_reminders', JSON.stringify(reminders));
                showNotification('Wiedervorlage gel√∂scht', 'Die Erinnerung wurde entfernt.');
            }
        }
        
        function getActiveReminders(entityType, entityId) {
            return reminders.filter(r => 
                r.entityType === entityType && 
                r.entityId === entityId && 
                !r.triggered
            );
        }
        
        // CSV Import Data
        let csvImportData = null;
        
        // Contact model now includes: position, tags
        // Task model now includes: reminderDate, reminderSent
        // Employee model: {id, name, position, email, phone, notes}
        
        // Deal model now includes:
        // - pdfUrl: URL/base64 of uploaded offer PDF
        // - pdfName: Name of uploaded PDF file
        // - protocol: Array of {date, note, author} entries
        
        // Company model now includes:
        // - protocol: Array of {date, note, author} entries
        
        // Confirmation Modal State
        let pendingDeleteAction = null;
        
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            pendingDeleteAction = onConfirm;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingDeleteAction = null;
        }
        
        function confirmDelete() {
            if (pendingDeleteAction) {
                pendingDeleteAction();
            }
            closeConfirmModal();
        }
        
        // Protocol Modal Functions
        // Protocol Activity Templates
        const protocolTemplates = {
            call: [
                "Telefonat gef√ºhrt. Kunde interessiert an...",
                "Anruf beantwortet. Fragen zu...",
                "R√ºckruf vereinbart f√ºr...",
                "Preisverhandlung besprochen.",
                "Technische Fragen gekl√§rt."
            ],
            meeting: [
                "Meeting durchgef√ºhrt. Besprochene Themen:",
                "Kick-off Meeting. N√§chste Schritte:",
                "Pr√§sentation vorgestellt. Feedback:",
                "Workshop durchgef√ºhrt. Ergebnisse:",
                "Quarterly Review. Status:"
            ],
            email: [
                "E-Mail versendet mit Informationen zu...",
                "Angebot per E-Mail √ºbermittelt.",
                "Dokumente per E-Mail nachgereicht.",
                "Follow-up E-Mail versendet.",
                "Best√§tigung per E-Mail erhalten."
            ],
            video: [
                "Video-Call durchgef√ºhrt. Themen:",
                "Online-Demo pr√§sentiert.",
                "Virtuelles Meeting abgehalten.",
                "Screen-Sharing Session.",
                "Remote-Beratung durchgef√ºhrt."
            ],
            visit: [
                "Kundenbesuch vor Ort.",
                "Standortbesichtigung durchgef√ºhrt.",
                "Vor-Ort-Termin wahrgenommen.",
                "Pers√∂nliches Treffen im B√ºro.",
                "Besuch auf Messe/Event."
            ],
            note: [
                "Interne Notiz:",
                "Wichtiger Hinweis:",
                "Follow-up erforderlich:",
                "Deadline beachten:",
                "Entscheidung getroffen:"
            ]
        };
        
        function getActivityIcon(activityType) {
            const icons = {
                call: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
                meeting: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
                email: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
                video: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`,
                visit: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
                note: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`
            };
            return icons[activityType] || icons.note;
        }
        
        function getActivityLabel(activityType) {
            const labels = {
                call: 'Telefonat',
                meeting: 'Meeting',
                email: 'E-Mail',
                video: 'Video-Call',
                visit: 'Besuch',
                note: 'Notiz'
            };
            return labels[activityType] || 'Notiz';
        }
        
        function getActivityColor(activityType) {
            const colors = {
                call: '#10b981',
                meeting: '#667eea',
                email: '#f59e0b',
                video: '#8b5cf6',
                visit: '#ef4444',
                note: '#64748b'
            };
            return colors[activityType] || '#64748b';
        }
        
        function openProtocolModal(entityType, entityId) {
            document.getElementById('protocolEntityType').value = entityType;
            document.getElementById('protocolEntityId').value = entityId;
            document.getElementById('protocolNote').value = '';
            document.getElementById('protocolAuthor').value = '';
            document.getElementById('protocolActivityType').value = 'note';
            
            // Reset activity type buttons
            document.querySelectorAll('.activity-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.activity-type-btn[data-type="note"]').classList.add('active');
            
            // Hide templates initially
            document.getElementById('protocolTemplates').style.display = 'none';
            
            document.getElementById('protocolModal').classList.add('active');
        }
        
        function selectActivityType(type) {
            // Update hidden field
            document.getElementById('protocolActivityType').value = type;
            
            // Update button states
            document.querySelectorAll('.activity-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.activity-type-btn[data-type="${type}"]`).classList.add('active');
            
            // Show templates for this type
            const templatesContainer = document.getElementById('protocolTemplates');
            const templateButtonsContainer = document.getElementById('protocolTemplateButtons');
            
            if (protocolTemplates[type]) {
                templateButtonsContainer.innerHTML = protocolTemplates[type].map(template => 
                    `<button type="button" class="template-btn" onclick="applyProtocolTemplate('${template.replace(/'/g, "\\'")}')">${template.split('.')[0]}...</button>`
                ).join('');
                templatesContainer.style.display = 'block';
            } else {
                templatesContainer.style.display = 'none';
            }
        }
        
        function applyProtocolTemplate(template) {
            const noteField = document.getElementById('protocolNote');
            const currentValue = noteField.value.trim();
            
            if (currentValue) {
                // Append if there's already content
                noteField.value = currentValue + '\n\n' + template;
            } else {
                // Replace if empty
                noteField.value = template;
            }
            
            // Focus on textarea and move cursor to end
            noteField.focus();
            noteField.setSelectionRange(noteField.value.length, noteField.value.length);
        }
        
        function closeProtocolModal() {
            document.getElementById('protocolModal').classList.remove('active');
        }
        
        function saveProtocolEntry() {
            const entityType = document.getElementById('protocolEntityType').value;
            const entityId = document.getElementById('protocolEntityId').value;
            const note = document.getElementById('protocolNote').value.trim();
            const author = document.getElementById('protocolAuthor').value.trim() || 'Benutzer';
            const activityType = document.getElementById('protocolActivityType').value || 'note';
            
            if (!note) {
                alert('Bitte geben Sie eine Notiz ein.');
                return;
            }
            
            const entry = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                note: note,
                author: author,
                activityType: activityType
            };
            
            if (entityType === 'deal') {
                const deal = deals.find(d => d.id === entityId);
                if (!deal) return;
                
                if (!deal.protocol) {
                    deal.protocol = [];
                }
                
                deal.protocol.unshift(entry);
                Storage.setItem('bbc_deals', JSON.stringify(deals));
                
                closeProtocolModal();
                showDealDetail(entityId);
            } else if (entityType === 'company') {
                const company = companies.find(c => c.id === entityId);
                if (!company) return;
                
                if (!company.protocol) {
                    company.protocol = [];
                }
                
                company.protocol.unshift(entry);
                Storage.setItem('bbc_companies', JSON.stringify(companies));
                
                // Track activity
                trackActivity('company', entityId, 'protocol');
                
                closeProtocolModal();
                showCompanyDetail(entityId);
            } else if (entityType === 'contact') {
                const contact = contacts.find(c => c.id === entityId);
                if (!contact) return;
                
                if (!contact.protocol) {
                    contact.protocol = [];
                }
                
                contact.protocol.unshift(entry);
                Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                
                // Track activity
                trackActivity('contact', entityId, 'protocol');
                
                closeProtocolModal();
                showContactDetail(entityId);
            }
        }
        
        // PDF Upload Handler
        function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                alert('Bitte w√§hlen Sie eine PDF-Datei aus.');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('dealPdfData').value = e.target.result;
                document.getElementById('pdfFileName').innerHTML = `üìÑ ${file.name}`;
            };
            reader.readAsDataURL(file);
        }
        
        const pipelineStages = [
            'Lead',
            'Erster Termin',
            'Angebot',
            'R√ºckfragen',
            'Hohe Wahrscheinlichkeit',
            'Deal gewonnen',
            'Verloren',
            'Sp√§ter kontaktieren'
        ];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initNavigation();
            loadEmployees();
            renderContacts();
            renderCompanies();
            renderPipeline();
            renderTasks();
            populateCompanyDropdown();
            populateRelatedDropdown();
        });
        
        // Navigation
        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    const view = this.getAttribute('data-view');
                    showView(view);
                });
            });
        }
        
        function showView(view) {
            document.querySelectorAll('.view-content, .detail-view').forEach(v => v.classList.add('hidden'));
            
            const viewMap = {
                'dashboard': 'dashboard-view',
                'contacts': 'contacts-view',
                'companies': 'companies-view',
                'deals': 'deals-view',
                'orders': 'orders-view',
                'tasks': 'tasks-view',
                'analytics': 'analytics-view',
                'inactive': 'inactive-view',
                'settings': 'settings-view'
            };
            
            const viewId = viewMap[view];
            if (viewId) {
                const element = document.getElementById(viewId);
                if (element) {
                    element.classList.remove('hidden');
                    
                    // Render content for each view
                    switch(view) {
                        case 'dashboard':
                            renderDashboard();
                            break;
                        case 'contacts':
                            renderContacts();
                            break;
                        case 'companies':
                            renderCompanies();
                            break;
                        case 'deals':
                            renderDeals();
                            break;
                        case 'orders':
                            renderOrders();
                            break;
                        case 'tasks':
                            renderTasks();
                            break;
                        case 'analytics':
                            updateAnalytics();
                            break;
                        case 'inactive':
                            updateInactiveCustomers();
                            break;
                        case 'settings':
                            switchSettingsTab('employees');
                            break;
                    }
                }
            }
        }
        
        // Contacts
        function openContactModal(contactId = null) {
            const modal = document.getElementById('contactModal');
            const form = document.getElementById('contactForm');
            form.reset();
            document.getElementById('newCompanyFields').classList.add('hidden');
            document.getElementById('customServicesList').innerHTML = '';
            document.getElementById('customPositionField').classList.add('hidden');
            selectedContactTags = [];
            
            // Populate companies dropdown
            const companySelect = document.getElementById('contactCompany');
            companySelect.innerHTML = '<option value="">Kein Unternehmen</option>';
            
            console.log('=== POPULATING COMPANY DROPDOWN ===');
            console.log('Available companies:', companies.length);
            
            companies.forEach(company => {
                console.log('Adding company:', company.name, 'ID:', company.id);
                companySelect.innerHTML += `<option value="${company.id}">${company.name}</option>`;
            });
            companySelect.innerHTML += '<option value="__new__">+ Neues Unternehmen erstellen</option>';
            
            console.log('Dropdown options:', companySelect.options.length);
            
            // Render available tags list
            const availableTagsHTML = availableTags.length > 0 ? `
                <div style="margin-top: 12px;">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Vorhandene Tags:</div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;" id="availableTagsList">
                        ${availableTags.map(tag => `
                            <span class="badge badge-kontakt" style="cursor: pointer;" onclick="selectExistingTag('${tag}')">${tag}</span>
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            // Add available tags to the tags form group if not already there
            const tagsFormGroup = form.querySelector('#newTagInput').closest('.form-group');
            const existingAvailableTags = tagsFormGroup.querySelector('#availableTagsList');
            if (existingAvailableTags) {
                existingAvailableTags.parentElement.remove();
            }
            if (availableTagsHTML) {
                tagsFormGroup.insertAdjacentHTML('beforeend', availableTagsHTML);
            }
            
            if (contactId) {
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    document.getElementById('contactModalTitle').textContent = 'Kontakt bearbeiten';
                    document.getElementById('contactId').value = contact.id;
                    
                    // Split name into firstName and lastName
                    if (contact.name) {
                        const nameParts = contact.name.split(' ');
                        const firstName = nameParts[0] || '';
                        const lastName = nameParts.slice(1).join(' ') || '';
                        document.getElementById('contactFirstName').value = firstName;
                        document.getElementById('contactLastName').value = lastName;
                    }
                    // If contact already has firstName/lastName properties
                    if (contact.firstName) {
                        document.getElementById('contactFirstName').value = contact.firstName;
                    }
                    if (contact.lastName) {
                        document.getElementById('contactLastName').value = contact.lastName;
                    }
                    
                    document.getElementById('contactEmail').value = contact.email;
                    document.getElementById('contactPhone').value = contact.phone || '';
                    
                    // Set company - IMPORTANT: Do this AFTER populating the dropdown
                    console.log('=== SETTING COMPANY FOR CONTACT ===');
                    console.log('Contact company ID:', contact.companyId);
                    
                    if (contact.companyId) {
                        // Check if company exists in dropdown
                        const optionExists = Array.from(companySelect.options).some(opt => opt.value === contact.companyId);
                        console.log('Company option exists in dropdown:', optionExists);
                        
                        if (optionExists) {
                            companySelect.value = contact.companyId;
                            console.log('Set dropdown to:', contact.companyId);
                        } else {
                            console.warn('Company ID not found in dropdown!', contact.companyId);
                            // Try to find company by checking if it exists
                            const company = companies.find(c => c.id === contact.companyId);
                            if (company) {
                                console.log('Company exists but not in dropdown:', company.name);
                            } else {
                                console.error('Company does not exist at all!');
                            }
                        }
                    } else {
                        console.log('Contact has no company assigned');
                    }
                    
                    document.getElementById('contactStatus').value = contact.status;
                    
                    // Set position
                    if (contact.position) {
                        const positionSelect = document.getElementById('contactPosition');
                        const optionExists = Array.from(positionSelect.options).some(opt => opt.value === contact.position);
                        if (optionExists) {
                            positionSelect.value = contact.position;
                        } else {
                            positionSelect.value = '__custom__';
                            document.getElementById('customPositionField').classList.remove('hidden');
                            document.getElementById('customPositionInput').value = contact.position;
                        }
                    }
                    
                    // Set tags
                    if (contact.tags) {
                        selectedContactTags = [...contact.tags];
                        renderSelectedTags();
                    }
                    
                    // Set services
                    contact.services.forEach(service => {
                        const checkbox = Array.from(document.querySelectorAll('input[type="checkbox"][name="service"]'))
                            .find(cb => cb.value === service);
                        if (checkbox) {
                            checkbox.checked = true;
                        } else {
                            addCustomServiceToList(service);
                        }
                    });
                }
            } else {
                document.getElementById('contactModalTitle').textContent = 'Neuer Kontakt';
            }
            
            renderSelectedTags();
            modal.classList.add('active');
        }
        
        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
        }
        
        function toggleNewCompany() {
            const select = document.getElementById('contactCompany');
            const fields = document.getElementById('newCompanyFields');
            
            if (select.value === '__new__') {
                fields.classList.remove('hidden');
            } else {
                fields.classList.add('hidden');
            }
        }
        
        function saveContact() {
            const contactId = document.getElementById('contactId').value;
            const firstName = document.getElementById('contactFirstName').value;
            const lastName = document.getElementById('contactLastName').value;
            const name = `${firstName} ${lastName}`.trim();
            const email = document.getElementById('contactEmail').value;
            const phone = document.getElementById('contactPhone').value;
            const status = document.getElementById('contactStatus').value;
            
            // Position
            let position = document.getElementById('contactPosition').value;
            if (position === '__custom__') {
                position = document.getElementById('customPositionInput').value;
            }
            
            let companyId = document.getElementById('contactCompany').value;
            
            console.log('=== SAVE CONTACT DEBUG ===');
            console.log('Contact ID:', contactId);
            console.log('Company ID from dropdown:', companyId);
            console.log('Available companies:', companies.length);
            
            // Create new company if needed
            if (companyId === '__new__') {
                const companyName = document.getElementById('newCompanyName').value;
                const industry = document.getElementById('newCompanyIndustry').value;
                
                if (companyName) {
                    const newCompany = {
                        id: Date.now().toString(),
                        name: companyName,
                        industry: industry,
                        createdAt: new Date().toISOString(),
                        status: status,
                        services: getSelectedServices(),
                        score: 3,
                        protocol: []
                    };
                    companies.push(newCompany);
                    Storage.setItem('bbc_companies', JSON.stringify(companies));
                    companyId = newCompany.id;
                    console.log('New company created:', newCompany.name);
                }
            }
            
            const services = getSelectedServices();
            
            // Get existing contact for createdAt or use current time
            const existingContact = contactId ? contacts.find(c => c.id === contactId) : null;
            const createdAt = existingContact ? existingContact.createdAt : new Date().toISOString();
            
            // Determine final companyId
            let finalCompanyId = null;
            
            if (companyId === '' || companyId === null) {
                // Empty string or null means "Kein Unternehmen" selected
                finalCompanyId = null;
                console.log('No company selected - setting to null');
            } else if (companyId && companyId !== '__new__') {
                // A company was selected from the dropdown
                finalCompanyId = companyId;
                console.log('Using selected company:', companyId);
            } else if (existingContact && existingContact.companyId && !companyId) {
                // If no selection but contact had a company, keep it (shouldn't happen with dropdown)
                finalCompanyId = existingContact.companyId;
                console.log('Keeping existing company:', existingContact.companyId);
            }
            
            console.log('Final company ID:', finalCompanyId);
            
            const contact = {
                id: contactId || Date.now().toString(),
                firstName: firstName,
                lastName: lastName,
                name: name,
                email,
                phone,
                position: position || '',
                tags: selectedContactTags || [],
                companyId: finalCompanyId,
                status,
                services,
                createdAt: createdAt
            };
            
            console.log('Contact to save:', contact);
            
            if (contactId) {
                const index = contacts.findIndex(c => c.id === contactId);
                if (index !== -1) {
                    contacts[index] = contact;
                } else {
                    contacts.push(contact);
                }
            } else {
                contacts.push(contact);
            }
            
            // Update company status and services if contact is linked to a company
            if (companyId && companyId !== '__new__') {
                const company = companies.find(c => c.id === companyId);
                if (company) {
                    company.status = status;
                    updateCompanyServices(companyId);
                    Storage.setItem('bbc_companies', JSON.stringify(companies));
                }
            }
            
            Storage.setItem('bbc_contacts', JSON.stringify(contacts));
            closeContactModal();
            renderContacts();
            renderCompanies();
            populateCompanyDropdown();
            populateRelatedDropdown();
        }
        
        function updateCompanyServices(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            const companyContacts = contacts.filter(c => c.companyId === companyId);
            const allServices = new Set();
            
            if (company.services) {
                company.services.forEach(service => allServices.add(service));
            }
            
            companyContacts.forEach(contact => {
                if (contact.services) {
                    contact.services.forEach(service => allServices.add(service));
                }
            });
            
            company.services = Array.from(allServices);
        }
        
        function getSelectedServices() {
            const services = [];
            
            document.querySelectorAll('#contactForm input[type="checkbox"][name="service"]:checked').forEach(cb => {
                services.push(cb.value);
            });
            
            document.querySelectorAll('#customServicesList .badge').forEach(badge => {
                services.push(badge.textContent.replace(' √ó', ''));
            });
            
            return services;
        }
        
        function addCustomService() {
            const input = document.getElementById('customService');
            const service = input.value.trim();
            
            if (service) {
                if (!customServices.includes(service)) {
                    customServices.push(service);
                    Storage.setItem('bbc_custom_services', JSON.stringify(customServices));
                }
                addCustomServiceToList(service);
                input.value = '';
            }
        }
        
        function addCustomServiceToList(service) {
            const container = document.getElementById('customServicesList');
            const badge = document.createElement('span');
            badge.className = 'badge badge-kontakt';
            badge.style.marginRight = '8px';
            badge.style.marginTop = '8px';
            badge.style.cursor = 'pointer';
            badge.textContent = service + ' √ó';
            badge.onclick = function() {
                this.remove();
            };
            container.appendChild(badge);
        }
        
        function renderContacts() {
            const container = document.getElementById('contactsList');
            
            if (contacts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                        <div class="empty-state-text">Keine Kontakte vorhanden</div>
                        <div class="empty-state-subtext">Erstellen Sie Ihren ersten Kontakt</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="list-header">
                    <div style="width: 40px;"></div>
                    <div>Name</div>
                    <div>Unternehmen</div>
                    <div>Status</div>
                    <div>Leistungen</div>
                    <div>Erstellt</div>
                    <div></div>
                </div>
            `;
            
            html += contacts.map(contact => {
                const company = companies.find(c => c.id === contact.companyId);
                
                return `
                    <div class="list-item">
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <input type="checkbox" class="select-checkbox contact-checkbox" data-id="${contact.id}" onchange="updateContactsBulkActions()">
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;">
                            <div class="list-item-main">${contact.name}</div>
                            <div class="list-item-sub">${contact.email}</div>
                            ${contact.phone ? `<div class="list-item-sub">üìû ${contact.phone}</div>` : ''}
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;" class="list-item-main">
                            ${company ? company.name : '-'}
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;">
                            <span class="badge badge-${getBadgeClass(contact.status)}">${contact.status}</span>
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;" class="list-item-services">
                            ${contact.services.slice(0, 2).map(s => {
                                const shortName = s.split(' - ')[1] || s;
                                return `<span class="service-tag">${shortName}</span>`;
                            }).join('')}
                            ${contact.services.length > 2 ? `<span class="service-tag">+${contact.services.length - 2}</span>` : ''}
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;" class="list-item-sub">
                            ${new Date(contact.createdAt).toLocaleDateString('de-DE')}
                        </div>
                        <div class="list-item-actions">
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteContact('${contact.id}');" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            updateContactsBulkActions();
        }
        
        function getBadgeClass(status) {
            const map = {
                'Kunde': 'kunde',
                'Ehemaliger Kunde': 'ehemalig',
                'Partner': 'partner',
                'In Bearbeitung': 'bearbeitung',
                'Akquise': 'bearbeitung',
                'Einfacher Kontakt': 'kontakt'
            };
            return map[status] || 'kontakt';
        }
        
        function filterContacts() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
            const statusFilter = document.getElementById('contactStatusFilter').value;
            
            const filtered = contacts.filter(contact => {
                const matchesSearch = contact.name.toLowerCase().includes(searchTerm) || 
                                    contact.email.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || contact.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            const container = document.getElementById('contactsList');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                        <div class="empty-state-text">Keine Ergebnisse</div>
                        <div class="empty-state-subtext">Versuchen Sie einen anderen Suchbegriff</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="list-header">
                    <div style="width: 40px;"></div>
                    <div>Name</div>
                    <div>Unternehmen</div>
                    <div>Status</div>
                    <div>Leistungen</div>
                    <div>Erstellt</div>
                    <div></div>
                </div>
            `;
            
            html += filtered.map(contact => {
                const company = companies.find(c => c.id === contact.companyId);
                
                return `
                    <div class="list-item">
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <input type="checkbox" class="select-checkbox contact-checkbox" data-id="${contact.id}" onchange="updateContactsBulkActions()">
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;">
                            <div class="list-item-main">${contact.name}</div>
                            <div class="list-item-sub">${contact.email}</div>
                            ${contact.phone ? `<div class="list-item-sub">üìû ${contact.phone}</div>` : ''}
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;" class="list-item-main">
                            ${company ? company.name : '-'}
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;">
                            <span class="badge badge-${getBadgeClass(contact.status)}">${contact.status}</span>
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;" class="list-item-services">
                            ${contact.services.slice(0, 2).map(s => {
                                const shortName = s.split(' - ')[1] || s;
                                return `<span class="service-tag">${shortName}</span>`;
                            }).join('')}
                            ${contact.services.length > 2 ? `<span class="service-tag">+${contact.services.length - 2}</span>` : ''}
                        </div>
                        <div onclick="showContactDetail('${contact.id}')" style="cursor: pointer;" class="list-item-sub">
                            ${new Date(contact.createdAt).toLocaleDateString('de-DE')}
                        </div>
                        <div class="list-item-actions">
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteContact('${contact.id}');" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            updateContactsBulkActions();
        }
        
        function showContactDetail(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            // Track activity: Viewing contact detail
            trackActivity('contact', contactId, 'view');
            
            // Track last viewed activity (legacy)
            contact.lastViewed = new Date().toISOString();
            updateContactActivity(contactId, 'viewed');
            Storage.setItem('bbc_contacts', JSON.stringify(contacts));
            
            // Initialize protocol if not exists
            if (!contact.protocol) {
                contact.protocol = [];
            }
            
            const company = companies.find(c => c.id === contact.companyId);
            const contactTasks = tasks.filter(t => t.contactId === contactId);
            
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            const detailView = document.getElementById('contact-detail-view');
            detailView.classList.remove('hidden');
            detailView.classList.add('active');
            
            detailView.innerHTML = `
                <a href="#" class="back-btn" onclick="backToContacts(); return false;">‚Üê Zur√ºck zu Kontakten</a>
                
                <div class="detail-header">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div class="detail-title">${contact.name}</div>
                            <span class="badge badge-${getBadgeClass(contact.status)}">${contact.status}</span>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="openEmailModal('contact', '${contact.id}')">E-Mail senden</button>
                            <button class="btn btn-primary" onclick="openReminderModal('contact', '${contact.id}', '${contact.name}')" style="background: #667eea;">Wiedervorlage</button>
                            <button class="btn btn-secondary" onclick="openContactModal('${contact.id}')">Bearbeiten</button>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">E-Mail</div>
                            <div class="detail-value">${contact.email}</div>
                        </div>
                        ${contact.phone ? `
                        <div class="detail-item">
                            <div class="detail-label">Telefon</div>
                            <div class="detail-value">${contact.phone}</div>
                        </div>
                        ` : ''}
                        ${company ? `
                        <div class="detail-item">
                            <div class="detail-label">Unternehmen</div>
                            <div class="detail-value">
                                <a href="#" onclick="showCompanyDetail('${company.id}'); return false;" style="color: var(--primary); text-decoration: none;">
                                    ${company.name}
                                </a>
                            </div>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-label">Erstellt am</div>
                            <div class="detail-value">${new Date(contact.createdAt).toLocaleDateString('de-DE')}</div>
                        </div>
                    </div>
                </div>
                
                ${contact.services && contact.services.length > 0 ? `
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title" style="margin: 0;">Leistungen</h3>
                        <button class="btn btn-secondary" onclick="openServicesEditModal('contact', '${contact.id}')">Bearbeiten</button>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${contact.services.map(s => `<span class="badge badge-kontakt">${s}</span>`).join('')}
                    </div>
                </div>
                ` : `
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title" style="margin: 0;">Leistungen</h3>
                        <button class="btn btn-secondary" onclick="openServicesEditModal('contact', '${contact.id}')">Hinzuf√ºgen</button>
                    </div>
                    <p style="color: var(--text-secondary);">Keine Leistungen zugeordnet</p>
                </div>
                `}
                
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="section-title" style="margin: 0;">Aufgaben</h3>
                        <button class="btn btn-primary" onclick="openTaskModalForContact('${contact.id}')">+ Aufgabe hinzuf√ºgen</button>
                    </div>
                    ${contactTasks.length > 0 ? `
                        ${contactTasks.map(task => renderTaskItem(task)).join('')}
                    ` : '<p style="color: var(--text-secondary);">Keine Aufgaben vorhanden</p>'}
                </div>
                
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="section-title" style="margin: 0;">Protokoll</h3>
                        <button class="btn btn-primary" onclick="openProtocolModal('contact', '${contact.id}')">+ Eintrag hinzuf√ºgen</button>
                    </div>
                    ${contact.protocol && contact.protocol.length > 0 ? `
                        <div class="protocol-list">
                            ${contact.protocol.sort((a, b) => new Date(b.date) - new Date(a.date)).map(entry => {
                                const activityType = entry.activityType || 'note';
                                const activityColor = getActivityColor(activityType);
                                const activityLabel = getActivityLabel(activityType);
                                const activityIcon = getActivityIcon(activityType);
                                
                                return `
                                <div class="protocol-entry" style="border-left-color: ${activityColor};">
                                    <div class="protocol-header">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="display: inline-flex; align-items: center; gap: 6px; background: white; padding: 4px 10px; border-radius: 6px; border: 1px solid ${activityColor};">
                                                <span style="color: ${activityColor};">${activityIcon}</span>
                                                <span style="font-size: 12px; font-weight: 600; color: ${activityColor};">${activityLabel}</span>
                                            </div>
                                            <div>
                                                <strong>${entry.author || 'Unbekannt'}</strong>
                                                <span style="color: var(--text-secondary); margin-left: 12px;">
                                                    ${new Date(entry.date).toLocaleDateString('de-DE')} um ${new Date(entry.date).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}
                                                </span>
                                            </div>
                                        </div>
                                        <button class="icon-btn" onclick="deleteProtocolEntry('contact', '${contact.id}', '${entry.id}')" title="L√∂schen">üóëÔ∏è</button>
                                    </div>
                                    <div class="protocol-content">${entry.note}</div>
                                </div>
                            `}).join('')}
                        </div>
                    ` : '<p style="color: var(--text-secondary);">Keine Protokolleintr√§ge vorhanden</p>'}
                </div>
            `;
        }
        
        function backToContacts() {
            document.getElementById('contact-detail-view').classList.remove('active');
            document.getElementById('contact-detail-view').classList.add('hidden');
            document.getElementById('contacts-view').classList.remove('hidden');
        }
        
        // Companies
        function populateCompanyDropdown() {
            const select = document.getElementById('contactCompany');
            const currentValue = select.value;
            
            select.innerHTML = `
                <option value="">Kein Unternehmen</option>
                <option value="__new__">+ Neues Unternehmen erstellen</option>
                ${companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
            `;
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        function renderCompanies() {
            const container = document.getElementById('companiesList');
            
            if (companies.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18"></path><path d="M9 8h1"></path><path d="M9 12h1"></path><path d="M9 16h1"></path><path d="M14 8h1"></path><path d="M14 12h1"></path><path d="M14 16h1"></path><path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"></path></svg></div>
                        <div class="empty-state-text">Keine Unternehmen vorhanden</div>
                        <div class="empty-state-subtext">Unternehmen werden beim Erstellen von Kontakten angelegt</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="company-list-header">
                    <div style="width: 40px;"></div>
                    <div>Unternehmen</div>
                    <div>Status</div>
                    <div>Kontakte</div>
                    <div>Score</div>
                    <div>Erstellt</div>
                    <div></div>
                </div>
            `;
            
            html += companies.map(company => {
                const companyContacts = contacts.filter(c => c.companyId === company.id);
                const companyDeals = deals.filter(d => d.companyId === company.id);
                
                return `
                    <div class="company-list-item">
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <input type="checkbox" class="select-checkbox company-checkbox" data-id="${company.id}" onchange="updateCompaniesBulkActions()">
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;">
                            <div class="list-item-main">${company.name}</div>
                            <div class="list-item-sub">${company.industry || 'Keine Branche'}</div>
                            <div class="list-item-sub" style="margin-top: 6px;">${companyDeals.length} Deal(s)</div>
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;">
                            <span class="badge badge-${getBadgeClass(company.status)}">${company.status}</span>
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;" class="list-item-main">
                            ${companyContacts.length}
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer; color: #FFB800; font-size: 18px;">
                            ${'‚òÖ'.repeat(company.score || 3)}${'‚òÜ'.repeat(5 - (company.score || 3))}
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;" class="list-item-sub">
                            ${new Date(company.createdAt).toLocaleDateString('de-DE')}
                        </div>
                        <div class="list-item-actions">
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteCompany('${company.id}');" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            updateCompaniesBulkActions();
        }
        
        function filterCompanies() {
            const searchTerm = document.getElementById('companySearch').value.toLowerCase();
            
            const filtered = companies.filter(company => 
                company.name.toLowerCase().includes(searchTerm) ||
                (company.industry && company.industry.toLowerCase().includes(searchTerm))
            );
            
            const container = document.getElementById('companiesList');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                        <div class="empty-state-text">Keine Ergebnisse</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="company-list-header">
                    <div style="width: 40px;"></div>
                    <div>Unternehmen</div>
                    <div>Status</div>
                    <div>Kontakte</div>
                    <div>Score</div>
                    <div>Erstellt</div>
                    <div></div>
                </div>
            `;
            
            html += filtered.map(company => {
                const companyContacts = contacts.filter(c => c.companyId === company.id);
                const companyDeals = deals.filter(d => d.companyId === company.id);
                
                return `
                    <div class="company-list-item">
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <input type="checkbox" class="select-checkbox company-checkbox" data-id="${company.id}" onchange="updateCompaniesBulkActions()">
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;">
                            <div class="list-item-main">${company.name}</div>
                            <div class="list-item-sub">${company.industry || 'Keine Branche'}</div>
                            <div class="list-item-sub" style="margin-top: 6px;">${companyDeals.length} Deal(s)</div>
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;">
                            <span class="badge badge-${getBadgeClass(company.status)}">${company.status}</span>
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;" class="list-item-main">
                            ${companyContacts.length}
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer; color: #FFB800; font-size: 18px;">
                            ${'‚òÖ'.repeat(company.score || 3)}${'‚òÜ'.repeat(5 - (company.score || 3))}
                        </div>
                        <div onclick="showCompanyDetail('${company.id}')" style="cursor: pointer;" class="list-item-sub">
                            ${new Date(company.createdAt).toLocaleDateString('de-DE')}
                        </div>
                        <div class="list-item-actions">
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteCompany('${company.id}');" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            updateCompaniesBulkActions();
        }
        
        function showCompanyDetail(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            // Track last viewed activity
            company.lastViewed = new Date().toISOString();
            updateCompanyActivity(companyId, 'viewed');
            Storage.setItem('bbc_companies', JSON.stringify(companies));
            
            // Initialize protocol if not exists
            if (!company.protocol) {
                company.protocol = [];
            }
            
            const companyContacts = contacts.filter(c => c.companyId === companyId);
            const companyDeals = deals.filter(d => d.companyId === companyId);
            const companyTasks = tasks.filter(t => {
                // Direct company assignment OR contact belongs to company
                if (t.companyId === companyId) return true;
                const contact = contacts.find(c => c.id === t.contactId);
                return contact && contact.companyId === companyId;
            });
            
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            const detailView = document.getElementById('company-detail-view');
            detailView.classList.remove('hidden');
            detailView.classList.add('active');
            
            detailView.innerHTML = `
                <a href="#" class="back-btn" onclick="backToCompanies(); return false;">‚Üê Zur√ºck zu Unternehmen</a>
                
                <div class="detail-header">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div class="detail-title">${company.name}</div>
                            <span class="badge badge-${getBadgeClass(company.status)}">${company.status}</span>
                            <div style="margin-top: 12px;">
                                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">Score:</div>
                                <div style="font-size: 24px; color: #FFB800;">${'‚òÖ'.repeat(company.score || 3)}${'‚òÜ'.repeat(5 - (company.score || 3))}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="openEmailModal('company', '${company.id}')">E-Mail</button>
                            <button class="btn btn-primary" onclick="openReminderModal('company', '${company.id}', '${company.name}')" style="background: #667eea;">Wiedervorlage</button>
                            <button class="btn btn-secondary" onclick="openCompanyEditModal('${company.id}')">Bearbeiten</button>
                            <button class="btn btn-secondary" onclick="openTaskModalForCompany('${company.id}')">+ Aufgabe</button>
                            <button class="btn btn-primary" onclick="openDealModalForCompany('${company.id}')">+ Neuer Deal</button>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Branche</div>
                            <div class="detail-value">${company.industry || 'Nicht angegeben'}</div>
                        </div>
                        ${company.phone ? `
                        <div class="detail-item">
                            <div class="detail-label">Telefon</div>
                            <div class="detail-value">${company.phone}</div>
                        </div>
                        ` : ''}
                        ${company.email ? `
                        <div class="detail-item">
                            <div class="detail-label">E-Mail</div>
                            <div class="detail-value">${company.email}</div>
                        </div>
                        ` : ''}
                        ${company.website ? `
                        <div class="detail-item">
                            <div class="detail-label">Website</div>
                            <div class="detail-value"><a href="${company.website}" target="_blank" style="color: var(--primary);">${company.website}</a></div>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-label">Kontakte</div>
                            <div class="detail-value">${companyContacts.length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Deals</div>
                            <div class="detail-value">${companyDeals.length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Erstellt am</div>
                            <div class="detail-value">${new Date(company.createdAt).toLocaleDateString('de-DE')}</div>
                        </div>
                    </div>
                </div>
                
                ${company.street || company.zip || company.city || company.country ? `
                <div class="section">
                    <h3 class="section-title">Adresse</h3>
                    <div style="color: var(--text-primary); line-height: 1.8;">
                        ${company.street ? `<div>${company.street}</div>` : ''}
                        ${company.zip || company.city ? `<div>${company.zip || ''} ${company.city || ''}</div>` : ''}
                        ${company.country ? `<div>${company.country}</div>` : ''}
                    </div>
                </div>
                ` : ''}
                
                ${company.vatId || company.registerNumber || company.notes ? `
                <div class="section">
                    <h3 class="section-title">Weitere Informationen</h3>
                    <div class="detail-grid">
                        ${company.vatId ? `
                        <div class="detail-item">
                            <div class="detail-label">Umsatzsteuer-ID</div>
                            <div class="detail-value">${company.vatId}</div>
                        </div>
                        ` : ''}
                        ${company.registerNumber ? `
                        <div class="detail-item">
                            <div class="detail-label">Handelsregister</div>
                            <div class="detail-value">${company.registerNumber}</div>
                        </div>
                        ` : ''}
                    </div>
                    ${company.notes ? `<div style="margin-top: 16px; padding: 16px; background: var(--bg-main); border-radius: 8px; white-space: pre-wrap;">${company.notes}</div>` : ''}
                </div>
                ` : ''}
                
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="section-title" style="margin: 0;">Leistungen</h3>
                        <button class="btn btn-secondary" onclick="openServicesEditModal('company', '${company.id}')">${company.services && company.services.length > 0 ? 'Bearbeiten' : 'Hinzuf√ºgen'}</button>
                    </div>
                    ${company.services && company.services.length > 0 ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${company.services.map(s => `<span class="badge badge-kontakt">${s}</span>`).join('')}
                        </div>
                    ` : '<p style="color: var(--text-secondary);">Keine Leistungen zugeordnet</p>'}
                </div>
                
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="section-title" style="margin: 0;">Unternehmens-Protokoll</h3>
                        <button class="btn btn-primary" onclick="openProtocolModal('company', '${company.id}')">+ Eintrag hinzuf√ºgen</button>
                    </div>
                    
                    <div id="companyProtocolEntries">
                        ${company.protocol && company.protocol.length > 0 ? `
                            ${company.protocol.map((entry, index) => {
                                const activityType = entry.activityType || 'note';
                                const activityColor = getActivityColor(activityType);
                                const activityLabel = getActivityLabel(activityType);
                                const activityIcon = getActivityIcon(activityType);
                                
                                return `
                                <div style="background: var(--bg-main); border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${activityColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: inline-flex; align-items: center; gap: 6px; background: white; padding: 4px 10px; border-radius: 6px; border: 1px solid ${activityColor};">
                                                <span style="color: ${activityColor};">${activityIcon}</span>
                                                <span style="font-size: 12px; font-weight: 600; color: ${activityColor};">${activityLabel}</span>
                                            </div>
                                            <span style="font-size: 13px; color: var(--text-secondary);">
                                                ${new Date(entry.date).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}
                                                ${entry.author ? ` ‚Ä¢ ${entry.author}` : ''}
                                            </span>
                                        </div>
                                        <button class="icon-btn" onclick="deleteCompanyProtocolEntry('${company.id}', ${index})" title="L√∂schen">üóë</button>
                                    </div>
                                    <div style="white-space: pre-wrap;">${entry.note}</div>
                                </div>
                            `}).join('')}
                        ` : '<p style="color: var(--text-secondary);">Noch keine Protokolleintr√§ge vorhanden</p>'}
                    </div>
                </div>
                
                <div class="section">
                    <h3 class="section-title">Kontakte</h3>
                    ${companyContacts.length > 0 ? `
                        <div class="cards-grid">
                            ${companyContacts.map(contact => `
                                <div class="card" onclick="showContactDetail('${contact.id}')">
                                    <div class="card-title">${contact.name}</div>
                                    <div class="card-subtitle">${contact.email}</div>
                                    ${contact.phone ? `<div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">üìû ${contact.phone}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: var(--text-secondary);">Keine Kontakte vorhanden</p>'}
                </div>
                
                <div class="section">
                    <h3 class="section-title">Deals</h3>
                    ${companyDeals.length > 0 ? `
                        <div class="cards-grid">
                            ${companyDeals.map(deal => `
                                <div class="card">
                                    <div class="card-title">${deal.name}</div>
                                    <div class="deal-value">‚Ç¨ ${parseFloat(deal.value || 0).toLocaleString('de-DE', {minimumFractionDigits: 2})}</div>
                                    <div style="margin-top: 8px;">
                                        <span class="badge badge-partner">${deal.stage}</span>
                                    </div>
                                    ${deal.services && deal.services.length > 0 ? `
                                        <div style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">
                                            ${deal.services.slice(0, 2).join(', ')}${deal.services.length > 2 ? ` +${deal.services.length - 2}` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: var(--text-secondary);">Keine Deals vorhanden</p>'}
                </div>
                
                <div class="section">
                    <h3 class="section-title">Aufgaben</h3>
                    ${companyTasks.length > 0 ? `
                        ${companyTasks.map(task => {
                            const contact = contacts.find(c => c.id === task.contactId);
                            return renderTaskItem(task, contact);
                        }).join('')}
                    ` : '<p style="color: var(--text-secondary);">Keine Aufgaben vorhanden</p>'}
                </div>
            `;
        }
        
        function backToCompanies() {
            document.getElementById('company-detail-view').classList.remove('active');
            document.getElementById('company-detail-view').classList.add('hidden');
            document.getElementById('companies-view').classList.remove('hidden');
        }
        
        // Deal Detail Functions
        function showDealDetail(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            const company = companies.find(c => c.id === deal.companyId);
            const dealTasks = tasks.filter(t => t.dealId === dealId);
            
            // Initialize protocol if not exists
            if (!deal.protocol) {
                deal.protocol = [];
            }
            
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            const detailView = document.getElementById('deal-detail-view');
            detailView.classList.remove('hidden');
            detailView.classList.add('active');
            
            detailView.innerHTML = `
                <a href="#" class="back-btn" onclick="backToDeals(); return false;">‚Üê Zur√ºck zu Deals</a>
                
                <div class="detail-header">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div class="detail-title">${deal.name}</div>
                            <div style="margin-top: 12px;">
                                <span class="badge badge-partner">${deal.stage}</span>
                                ${deal.wonConfirmed ? '<span class="badge badge-kunde" style="margin-left: 8px;">‚úì Deal gewonnen</span>' : ''}
                                ${deal.lostConfirmed ? '<span class="badge badge-verloren" style="margin-left: 8px;">‚úì Deal verloren</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            ${!deal.wonConfirmed && !deal.lostConfirmed ? `
                                <button class="btn btn-secondary" onclick="openEditDealModal('${deal.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Bearbeiten
                                </button>
                            ` : ''}
                            <button class="btn btn-primary" onclick="openEmailModal('deal', '${deal.id}')">E-Mail</button>
                            <button class="btn btn-primary" onclick="openReminderModal('deal', '${deal.id}', '${deal.name}')" style="background: #667eea;">Wiedervorlage</button>
                            ${!deal.wonConfirmed && !deal.lostConfirmed ? `
                                <button onclick="confirmDealWon('${deal.id}')" style="padding: 12px 24px; font-size: 15px; font-weight: 600; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'IBM Plex Sans', sans-serif; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                                    <span>‚úì</span>
                                    <span>Deal gewonnen</span>
                                </button>
                                <button onclick="confirmDealLost('${deal.id}')" style="padding: 12px 24px; font-size: 15px; font-weight: 600; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'IBM Plex Sans', sans-serif; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">
                                    <span>‚úó</span>
                                    <span>Deal verloren</span>
                                </button>
                            ` : ''}
                            ${deal.wonConfirmed && orders.find(o => o.dealId === deal.id) ? `
                                <button onclick="showView('orders')" style="padding: 12px 24px; font-size: 15px; font-weight: 600; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'IBM Plex Sans', sans-serif;">
                                    Zu den Auftr√§gen
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Deal Wert</div>
                            <div class="detail-value" style="color: var(--accent); font-size: 24px; font-weight: 700;">
                                ‚Ç¨ ${parseFloat(deal.value).toLocaleString('de-DE', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                        ${company ? `
                        <div class="detail-item">
                            <div class="detail-label">Unternehmen</div>
                            <div class="detail-value">
                                <a href="#" onclick="showCompanyDetail('${company.id}'); return false;" style="color: var(--primary); text-decoration: none;">
                                    ${company.name}
                                </a>
                            </div>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-label">Hauptverantwortlicher</div>
                            <div class="detail-value">
                                ${deal.responsiblePerson ? `
                                    <span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: #f0f9ff; border-radius: 6px; color: #1e40af; font-weight: 600;">
                                        üë§ ${deal.responsiblePerson}
                                    </span>
                                ` : '<span style="color: var(--text-secondary);">Nicht zugewiesen</span>'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Score</div>
                            <div class="detail-value" style="color: #FFB800; font-size: 20px;">
                                ${'‚òÖ'.repeat(deal.score || 3)}${'‚òÜ'.repeat(5 - (deal.score || 3))}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Erstellt am</div>
                            <div class="detail-value">${new Date(deal.createdAt).toLocaleDateString('de-DE')}</div>
                        </div>
                    </div>
                </div>
                
                ${deal.pdfData ? `
                <div class="section">
                    <h3 class="section-title">Angebot</h3>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 48px;">üìÑ</span>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${deal.pdfName}</div>
                            <button class="btn btn-secondary" onclick="downloadDealPdf('${deal.id}')">PDF herunterladen</button>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${deal.services && deal.services.length > 0 ? `
                <div class="section">
                    <h3 class="section-title">Leistungen</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${deal.services.map(s => `<span class="badge badge-kontakt">${s}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="section-title" style="margin: 0;">Deal-Protokoll</h3>
                        <button class="btn btn-primary" onclick="addProtocolEntry('${deal.id}')">+ Eintrag hinzuf√ºgen</button>
                    </div>
                    
                    <div id="protocolEntries">
                        ${deal.protocol && deal.protocol.length > 0 ? `
                            ${deal.protocol.map((entry, index) => {
                                const activityType = entry.activityType || 'note';
                                const activityColor = getActivityColor(activityType);
                                const activityLabel = getActivityLabel(activityType);
                                const activityIcon = getActivityIcon(activityType);
                                
                                return `
                                <div style="background: var(--bg-main); border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${activityColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="display: inline-flex; align-items: center; gap: 6px; background: white; padding: 4px 10px; border-radius: 6px; border: 1px solid ${activityColor};">
                                                <span style="color: ${activityColor};">${activityIcon}</span>
                                                <span style="font-size: 12px; font-weight: 600; color: ${activityColor};">${activityLabel}</span>
                                            </div>
                                            <span style="font-size: 13px; color: var(--text-secondary);">
                                                ${new Date(entry.date).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}
                                                ${entry.author ? ` ‚Ä¢ ${entry.author}` : ''}
                                            </span>
                                        </div>
                                        <button class="icon-btn" onclick="deleteProtocolEntry('${deal.id}', ${index})" title="L√∂schen">üóë</button>
                                    </div>
                                    <div style="white-space: pre-wrap;">${entry.note}</div>
                                </div>
                            `}).join('')}
                        ` : '<p style="color: var(--text-secondary);">Noch keine Protokolleintr√§ge vorhanden</p>'}
                    </div>
                </div>
                
                <div class="section">
                    <h3 class="section-title">Zugeh√∂rige Aufgaben</h3>
                    ${dealTasks.length > 0 ? `
                        ${dealTasks.map(task => renderTaskItem(task)).join('')}
                    ` : '<p style="color: var(--text-secondary);">Keine Aufgaben vorhanden</p>'}
                </div>
            `;
        }
        
        function backToDeals() {
            document.getElementById('deal-detail-view').classList.remove('active');
            document.getElementById('deal-detail-view').classList.add('hidden');
            document.getElementById('deals-view').classList.remove('hidden');
        }
        
        function downloadDealPdf(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal || !deal.pdfData) return;
            
            const link = document.createElement('a');
            link.href = deal.pdfData;
            link.download = deal.pdfName || 'angebot.pdf';
            link.click();
        }
        
        function addProtocolEntry(dealId) {
            openProtocolModal('deal', dealId);
        }
        
        function deleteProtocolEntry(entityTypeOrDealId, entityIdOrIndex, entryId = null) {
            // Backwards compatibility: If only 2 parameters, it's the old deal format
            if (entryId === null) {
                // Old format: deleteProtocolEntry(dealId, index)
                const dealId = entityTypeOrDealId;
                const index = entityIdOrIndex;
                
                showConfirmModal(
                    'M√∂chten Sie diesen Protokolleintrag wirklich l√∂schen?',
                    function() {
                        const deal = deals.find(d => d.id === dealId);
                        if (!deal || !deal.protocol) return;
                        
                        deal.protocol.splice(index, 1);
                        Storage.setItem('bbc_deals', JSON.stringify(deals));
                        showDealDetail(dealId);
                    }
                );
                return;
            }
            
            // New format: deleteProtocolEntry(entityType, entityId, entryId)
            const entityType = entityTypeOrDealId;
            const entityId = entityIdOrIndex;
            
            showConfirmModal(
                'M√∂chten Sie diesen Protokolleintrag wirklich l√∂schen?',
                function() {
                    if (entityType === 'contact') {
                        const contact = contacts.find(c => c.id === entityId);
                        if (!contact || !contact.protocol) return;
                        
                        const index = contact.protocol.findIndex(e => e.id === entryId);
                        if (index > -1) {
                            contact.protocol.splice(index, 1);
                            Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                            showContactDetail(entityId);
                        }
                    } else if (entityType === 'company') {
                        const company = companies.find(c => c.id === entityId);
                        if (!company || !company.protocol) return;
                        
                        const index = company.protocol.findIndex(e => e.id === entryId);
                        if (index > -1) {
                            company.protocol.splice(index, 1);
                            Storage.setItem('bbc_companies', JSON.stringify(companies));
                            showCompanyDetail(entityId);
                        }
                    } else if (entityType === 'deal') {
                        const deal = deals.find(d => d.id === entityId);
                        if (!deal || !deal.protocol) return;
                        
                        const index = deal.protocol.findIndex(e => e.id === entryId);
                        if (index > -1) {
                            deal.protocol.splice(index, 1);
                            Storage.setItem('bbc_deals', JSON.stringify(deals));
                            showDealDetail(entityId);
                        }
                    }
                }
            );
        }
        
        function deleteCompanyProtocolEntry(companyId, index) {
            showConfirmModal(
                'M√∂chten Sie diesen Protokolleintrag wirklich l√∂schen?',
                function() {
                    const company = companies.find(c => c.id === companyId);
                    if (!company || !company.protocol) return;
                    
                    company.protocol.splice(index, 1);
                    Storage.setItem('bbc_companies', JSON.stringify(companies));
                    showCompanyDetail(companyId);
                }
            );
        }
        
        // Tags Functions
        function toggleCustomPosition() {
            const select = document.getElementById('contactPosition');
            const customField = document.getElementById('customPositionField');
            if (select && customField) {
                if (select.value === '__custom__') {
                    customField.classList.remove('hidden');
                } else {
                    customField.classList.add('hidden');
                }
            }
        }
        
        function addTag() {
            const input = document.getElementById('newTagInput');
            if (!input) return;
            
            const tag = input.value.trim();
            if (!tag) return;
            
            if (!selectedContactTags.includes(tag)) {
                selectedContactTags.push(tag);
                
                if (!availableTags.includes(tag)) {
                    availableTags.push(tag);
                    Storage.setItem('bbc_available_tags', JSON.stringify(availableTags));
                }
                
                renderSelectedTags();
            }
            
            input.value = '';
        }
        
        function selectExistingTag(tag) {
            if (!selectedContactTags.includes(tag)) {
                selectedContactTags.push(tag);
                renderSelectedTags();
            }
        }
        
        function removeTag(tag) {
            selectedContactTags = selectedContactTags.filter(t => t !== tag);
            renderSelectedTags();
        }
        
        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            if (!container) return;
            
            container.innerHTML = selectedContactTags.map(tag => {
                const escapedTag = tag.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `<span class="badge badge-primary" style="display: inline-flex; align-items: center; gap: 6px;">
                    ${tag}
                    <span onclick="removeTag('${escapedTag}'); event.stopPropagation();" style="cursor: pointer; font-weight: bold;">&times;</span>
                </span>`;
            }).join('');
        }
        
        // Company Services Update
        function updateCompanyServices(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            const companyContacts = contacts.filter(c => c.companyId === companyId);
            const allServices = new Set();
            
            if (company.services) {
                company.services.forEach(service => allServices.add(service));
            }
            
            companyContacts.forEach(contact => {
                if (contact.services) {
                    contact.services.forEach(service => allServices.add(service));
                }
            });
            
            company.services = Array.from(allServices);
        }
        
        // Task Edit Functions
        let currentEditingTaskId = null;
        
        function openTaskEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentEditingTaskId = taskId;
            
            // Populate dropdowns
            populateEmployeeDropdown();
            populateCompanyDropdown();
            populateDealDropdown();
            
            // Fill form with null-checks
            const titleInput = document.getElementById('taskTitle');
            const descInput = document.getElementById('taskDescription');
            const dateInput = document.getElementById('taskDueDate');
            const assigneeSelect = document.getElementById('taskAssignee');
            const companySelect = document.getElementById('taskCompany');
            const dealSelect = document.getElementById('taskDeal');
            const prioritySelect = document.getElementById('taskPriority');
            const contactSelect = document.getElementById('taskContact');
            
            if (titleInput) titleInput.value = task.title;
            if (descInput) descInput.value = task.description || '';
            if (dateInput) dateInput.value = task.dueDate || '';
            if (assigneeSelect) assigneeSelect.value = task.assignee || '';
            if (companySelect) companySelect.value = task.companyId || '';
            if (dealSelect) dealSelect.value = task.dealId || '';
            if (prioritySelect) prioritySelect.value = task.priority || 'mittel';
            
            // Update contact dropdown based on company
            updateTaskContactDropdown();
            if (contactSelect) contactSelect.value = task.contactId || '';
            
            // Change modal title
            const modalTitle = document.querySelector('#taskModal .modal-title');
            if (modalTitle) modalTitle.textContent = 'Aufgabe bearbeiten';
            
            document.getElementById('taskModal').classList.add('active');
        }
        
        // Overdue Tasks
        function checkOverdueTasks() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            tasks.forEach(task => {
                if (task.dueDate && task.status === 'offen') {
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    task.overdue = dueDate < now;
                } else {
                    task.overdue = false;
                }
            });
            
            Storage.setItem('bbc_tasks', JSON.stringify(tasks));
        }
        
        function sortTasksByPriority(tasksArray) {
            return tasksArray.sort((a, b) => {
                if (a.overdue && !b.overdue) return -1;
                if (!a.overdue && b.overdue) return 1;
                if (a.dueDate && b.dueDate) {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                if (a.dueDate) return -1;
                if (b.dueDate) return 1;
                return 0;
            });
        }
        
        // Company Edit Functions
        function openCompanyEditModal(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            document.getElementById('companyEditId').value = company.id;
            document.getElementById('companyEditName').value = company.name || '';
            document.getElementById('companyEditIndustry').value = company.industry || '';
            document.getElementById('companyEditStreet').value = company.street || '';
            document.getElementById('companyEditZip').value = company.zip || '';
            document.getElementById('companyEditCity').value = company.city || '';
            document.getElementById('companyEditCountry').value = company.country || '';
            document.getElementById('companyEditPhone').value = company.phone || '';
            document.getElementById('companyEditEmail').value = company.email || '';
            document.getElementById('companyEditWebsite').value = company.website || '';
            document.getElementById('companyEditVatId').value = company.vatId || '';
            document.getElementById('companyEditRegisterNumber').value = company.registerNumber || '';
            document.getElementById('companyEditNotes').value = company.notes || '';
            document.getElementById('companyEditStatus').value = company.status || 'Einfacher Kontakt';
            
            document.getElementById('companyEditModal').classList.add('active');
        }
        
        function closeCompanyEditModal() {
            document.getElementById('companyEditModal').classList.remove('active');
        }
        
        function saveCompanyEdit() {
            const companyId = document.getElementById('companyEditId').value;
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            company.name = document.getElementById('companyEditName').value;
            company.industry = document.getElementById('companyEditIndustry').value;
            company.street = document.getElementById('companyEditStreet').value;
            company.zip = document.getElementById('companyEditZip').value;
            company.city = document.getElementById('companyEditCity').value;
            company.country = document.getElementById('companyEditCountry').value;
            company.phone = document.getElementById('companyEditPhone').value;
            company.email = document.getElementById('companyEditEmail').value;
            company.website = document.getElementById('companyEditWebsite').value;
            company.vatId = document.getElementById('companyEditVatId').value;
            company.registerNumber = document.getElementById('companyEditRegisterNumber').value;
            company.notes = document.getElementById('companyEditNotes').value;
            company.status = document.getElementById('companyEditStatus').value;
            
            Storage.setItem('bbc_companies', JSON.stringify(companies));
            
            closeCompanyEditModal();
            showCompanyDetail(companyId);
            renderCompanies();
        }
        
        // Deals
        function openDealModalForCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            const modal = document.getElementById('dealModal');
            const form = document.getElementById('dealForm');
            form.reset();
            
            document.getElementById('dealCompanyId').value = companyId;
            
            // Populate services
            const servicesContainer = document.getElementById('dealServicesCheckboxes');
            servicesContainer.innerHTML = company.services.map(service => `
                <div class="checkbox-item">
                    <input type="checkbox" id="deal-service-${service}" value="${service}">
                    <label for="deal-service-${service}">${service}</label>
                </div>
            `).join('');
            
            // Populate responsible person dropdown
            const responsibleSelect = document.getElementById('dealResponsiblePerson');
            responsibleSelect.innerHTML = '<option value="">Nicht zugewiesen</option>';
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = emp.name;
                responsibleSelect.appendChild(option);
            });
            
            // Initialize score
            initDealScore();
            
            modal.classList.add('active');
        }
        
        function closeDealModal() {
            const modal = document.getElementById('dealModal');
            modal.style.display = 'none';
        }
        
        function togglePaymentFields() {
            const paymentModel = document.getElementById('dealPaymentModel').value;
            const recurringFields = document.getElementById('recurringFields');
            
            if (paymentModel !== 'one-time') {
                recurringFields.classList.remove('hidden');
                updateDealValuePreview();
            } else {
                recurringFields.classList.add('hidden');
            }
        }
        
        function updateDealValuePreview() {
            const value = parseFloat(document.getElementById('dealValue').value) || 0;
            const paymentModel = document.getElementById('dealPaymentModel').value;
            const duration = parseInt(document.getElementById('dealContractDuration').value) || 12;
            const preview = document.getElementById('dealValuePreview');
            
            if (!preview || paymentModel === 'one-time') return;
            
            let periodsPerYear, periodName;
            switch(paymentModel) {
                case 'monthly':
                    periodsPerYear = 12;
                    periodName = 'Monat';
                    break;
                case 'quarterly':
                    periodsPerYear = 4;
                    periodName = 'Quartal';
                    break;
                case 'yearly':
                    periodsPerYear = 1;
                    periodName = 'Jahr';
                    break;
            }
            
            const totalPeriods = Math.ceil((duration / 12) * periodsPerYear);
            const totalRevenue = value * totalPeriods;
            const mrr = paymentModel === 'monthly' ? value : (value / (12 / periodsPerYear));
            const arr = mrr * 12;
            
            preview.innerHTML = `
                <strong>‚Ç¨ ${value.toLocaleString('de-DE')}</strong> pro ${periodName}<br>
                <strong>${totalPeriods}x Zahlungen</strong> √ºber ${duration} Monate<br>
                <strong>Gesamtumsatz: ‚Ç¨ ${totalRevenue.toLocaleString('de-DE')}</strong><br>
                MRR: ‚Ç¨ ${Math.round(mrr).toLocaleString('de-DE')} | ARR: ‚Ç¨ ${Math.round(arr).toLocaleString('de-DE')}
            `;
        }
        
        function toggleOrderPaymentFields() {
            const paymentModel = document.getElementById('editOrderPaymentModel').value;
            const recurringFields = document.getElementById('editOrderRecurringFields');
            
            if (paymentModel !== 'one-time') {
                recurringFields.style.display = 'block';
                updateOrderValuePreview();
            } else {
                recurringFields.style.display = 'none';
            }
        }
        
        function updateOrderValuePreview() {
            const value = parseFloat(document.getElementById('editOrderValue').value) || 0;
            const paymentModel = document.getElementById('editOrderPaymentModel').value;
            const duration = parseInt(document.getElementById('editOrderContractDuration').value) || 12;
            const preview = document.getElementById('editOrderValuePreview');
            
            if (!preview || paymentModel === 'one-time') return;
            
            let periodsPerYear, periodName;
            switch(paymentModel) {
                case 'monthly':
                    periodsPerYear = 12;
                    periodName = 'Monat';
                    break;
                case 'quarterly':
                    periodsPerYear = 4;
                    periodName = 'Quartal';
                    break;
                case 'yearly':
                    periodsPerYear = 1;
                    periodName = 'Jahr';
                    break;
            }
            
            const totalPeriods = Math.ceil((duration / 12) * periodsPerYear);
            const totalRevenue = value * totalPeriods;
            const mrr = paymentModel === 'monthly' ? value : (value / (12 / periodsPerYear));
            const arr = mrr * 12;
            
            preview.innerHTML = `
                <strong>‚Ç¨ ${value.toLocaleString('de-DE')}</strong> pro ${periodName}<br>
                <strong>${totalPeriods}x Zahlungen</strong> √ºber ${duration} Monate<br>
                <strong>Gesamtumsatz: ‚Ç¨ ${totalRevenue.toLocaleString('de-DE')}</strong><br>
                MRR: ‚Ç¨ ${Math.round(mrr).toLocaleString('de-DE')} | ARR: ‚Ç¨ ${Math.round(arr).toLocaleString('de-DE')}
            `;
        }
        
        function closeDealModal() {
            document.getElementById('dealModal').classList.remove('active');
            document.getElementById('dealPdfFile').value = '';
            document.getElementById('dealPdfData').value = '';
            document.getElementById('pdfFileName').innerHTML = '';
        }
        
        function openEditDealModal(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.display = 'flex';
            
            const company = companies.find(c => c.id === deal.companyId);
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Deal bearbeiten</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Deal-Name</label>
                            <input type="text" class="form-input" id="editDealName" value="${deal.name}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Deal Wert (‚Ç¨)</label>
                            <input type="number" class="form-input" id="editDealValue" step="0.01" value="${deal.value}" onchange="updateEditDealValuePreview()">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Zahlungsmodell</label>
                            <select class="form-select" id="editDealPaymentModel" onchange="toggleEditDealPaymentFields()">
                                <option value="one-time" ${(deal.paymentModel || 'one-time') === 'one-time' ? 'selected' : ''}>Einmalzahlung</option>
                                <option value="monthly" ${deal.paymentModel === 'monthly' ? 'selected' : ''}>Monatlich (Abo/Vertrag)</option>
                                <option value="quarterly" ${deal.paymentModel === 'quarterly' ? 'selected' : ''}>Viertelj√§hrlich</option>
                                <option value="yearly" ${deal.paymentModel === 'yearly' ? 'selected' : ''}>J√§hrlich</option>
                            </select>
                        </div>
                        
                        <div id="editDealRecurringFields" class="form-group" style="${(deal.paymentModel && deal.paymentModel !== 'one-time') ? '' : 'display: none;'}">
                            <label class="form-label">Vertragslaufzeit (Monate)</label>
                            <input type="number" class="form-input" id="editDealContractDuration" min="1" value="${deal.contractDuration || 12}" onchange="updateEditDealValuePreview()">
                            <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-left: 4px solid #1e40af; border-radius: 4px;">
                                <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">Umsatz√ºbersicht</div>
                                <div id="editDealValuePreview" style="font-size: 13px; color: #64748b;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Hauptverantwortlicher (BBC Mitarbeiter)</label>
                            <select class="form-select" id="editDealResponsiblePerson">
                                <option value="">Nicht zugewiesen</option>
                                ${employees.map(emp => `
                                    <option value="${emp.name}" ${deal.responsiblePerson === emp.name ? 'selected' : ''}>${emp.name}</option>
                                `).join('')}
                            </select>
                            <small style="color: #64748b; font-size: 12px; display: block; margin-top: 6px;">
                                üí° Wird f√ºr Top Performer Ranking verwendet
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Unternehmen</label>
                            <div class="form-input" style="background: #f1f5f9; cursor: not-allowed;">
                                ${company ? company.name : 'Unbekannt'}
                            </div>
                            <small style="color: var(--text-secondary);">Unternehmen kann nachtr√§glich nicht ge√§ndert werden</small>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="saveEditedDeal('${dealId}')">√Ñnderungen speichern</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Abbrechen</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize preview if recurring
            if (deal.paymentModel && deal.paymentModel !== 'one-time') {
                updateEditDealValuePreview();
            }
        }
        
        function toggleEditDealPaymentFields() {
            const paymentModel = document.getElementById('editDealPaymentModel').value;
            const recurringFields = document.getElementById('editDealRecurringFields');
            
            if (paymentModel !== 'one-time') {
                recurringFields.style.display = 'block';
                updateEditDealValuePreview();
            } else {
                recurringFields.style.display = 'none';
            }
        }
        
        function updateEditDealValuePreview() {
            const value = parseFloat(document.getElementById('editDealValue').value) || 0;
            const paymentModel = document.getElementById('editDealPaymentModel').value;
            const duration = parseInt(document.getElementById('editDealContractDuration').value) || 12;
            const preview = document.getElementById('editDealValuePreview');
            
            if (!preview || paymentModel === 'one-time') return;
            
            let periodsPerYear, periodName;
            switch(paymentModel) {
                case 'monthly':
                    periodsPerYear = 12;
                    periodName = 'Monat';
                    break;
                case 'quarterly':
                    periodsPerYear = 4;
                    periodName = 'Quartal';
                    break;
                case 'yearly':
                    periodsPerYear = 1;
                    periodName = 'Jahr';
                    break;
            }
            
            const totalPeriods = Math.ceil((duration / 12) * periodsPerYear);
            const totalRevenue = value * totalPeriods;
            const mrr = paymentModel === 'monthly' ? value : (value / (12 / periodsPerYear));
            const arr = mrr * 12;
            
            preview.innerHTML = `
                <strong>‚Ç¨ ${value.toLocaleString('de-DE')}</strong> pro ${periodName}<br>
                <strong>${totalPeriods}x Zahlungen</strong> √ºber ${duration} Monate<br>
                <strong>Gesamtumsatz: ‚Ç¨ ${totalRevenue.toLocaleString('de-DE')}</strong><br>
                MRR: ‚Ç¨ ${Math.round(mrr).toLocaleString('de-DE')} | ARR: ‚Ç¨ ${Math.round(arr).toLocaleString('de-DE')}
            `;
        }
        
        function saveEditedDeal(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            const newName = document.getElementById('editDealName').value.trim();
            const newValue = parseFloat(document.getElementById('editDealValue').value);
            const newPaymentModel = document.getElementById('editDealPaymentModel').value;
            const newContractDuration = parseInt(document.getElementById('editDealContractDuration').value) || 12;
            const newResponsiblePerson = document.getElementById('editDealResponsiblePerson')?.value || '';
            
            if (!newName) {
                alert('Bitte geben Sie einen Deal-Namen ein.');
                return;
            }
            
            if (isNaN(newValue) || newValue < 0) {
                alert('Bitte geben Sie einen g√ºltigen Deal-Wert ein.');
                return;
            }
            
            // Update deal
            deal.name = newName;
            deal.value = newValue;
            deal.paymentModel = newPaymentModel;
            deal.contractDuration = newPaymentModel !== 'one-time' ? newContractDuration : null;
            deal.responsiblePerson = newResponsiblePerson;
            
            Storage.setItem('bbc_deals', JSON.stringify(deals));
            
            // Update linked order if exists
            const linkedOrder = orders.find(o => o.dealId === dealId);
            if (linkedOrder) {
                linkedOrder.dealName = newName;
                linkedOrder.value = newValue;
                linkedOrder.paymentModel = newPaymentModel;
                linkedOrder.contractDuration = newPaymentModel !== 'one-time' ? newContractDuration : null;
                Storage.setItem('bbc_orders', JSON.stringify(orders));
            }
            
            // Close modal
            document.querySelector('.modal.active').remove();
            
            // Refresh views
            showDealDetail(dealId);
            renderPipeline();
            updateKPICards();
            updateGoalsProgress();
            updateRevenueOverview();
            
            // Update Analytics if open
            if (!document.getElementById('analytics-view').classList.contains('hidden')) {
                updateAnalytics();
            }
            
            showNotification('Deal aktualisiert', `Die √Ñnderungen an "${newName}" wurden gespeichert und mit dem Auftrag synchronisiert.`);
        }
        
        function initDealScore() {
            const stars = document.querySelectorAll('#dealScore .star');
            let selectedScore = 3;
            
            // Set initial score
            updateStarDisplay(selectedScore);
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedScore = parseInt(this.getAttribute('data-score'));
                    updateStarDisplay(selectedScore);
                });
            });
            
            function updateStarDisplay(score) {
                stars.forEach(star => {
                    const starScore = parseInt(star.getAttribute('data-score'));
                    if (starScore <= score) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            }
        }
        
        function saveDeal() {
            const companyId = document.getElementById('dealCompanyId').value;
            const name = document.getElementById('dealName').value;
            const value = document.getElementById('dealValue').value || 0;
            const paymentModel = document.getElementById('dealPaymentModel').value;
            const contractDuration = document.getElementById('dealContractDuration').value || 12;
            const responsiblePerson = document.getElementById('dealResponsiblePerson').value;
            const pdfData = document.getElementById('dealPdfData').value;
            const pdfInput = document.getElementById('dealPdfFile');
            const pdfName = pdfInput.files[0] ? pdfInput.files[0].name : null;
            
            const selectedServices = [];
            document.querySelectorAll('#dealServicesCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                selectedServices.push(cb.value);
            });
            
            const score = document.querySelectorAll('#dealScore .star.active').length;
            
            const deal = {
                id: Date.now().toString(),
                companyId,
                name,
                value: parseFloat(value),
                paymentModel: paymentModel,
                contractDuration: paymentModel !== 'one-time' ? parseInt(contractDuration) : null,
                responsiblePerson: responsiblePerson || '',
                services: selectedServices,
                score,
                stage: 'Lead',
                createdAt: new Date().toISOString(),
                pdfData: pdfData || null,
                pdfName: pdfName || null,
                protocol: []
            };
            
            deals.push(deal);
            Storage.setItem('bbc_deals', JSON.stringify(deals));
            
            // Update company score
            const company = companies.find(c => c.id === companyId);
            if (company) {
                company.score = score;
                Storage.setItem('bbc_companies', JSON.stringify(companies));
            }
            
            closeDealModal();
            renderPipeline();
            renderCompanies();
            
            // Update Dashboard
            updateKPICards();
            updateGoalsProgress();
            updateRevenueOverview();
            
            // If on company detail, refresh it
            if (!document.getElementById('company-detail-view').classList.contains('hidden')) {
                showCompanyDetail(companyId);
            }
        }
        
        function renderPipeline() {
            const container = document.getElementById('pipelineContainer');
            
            if (deals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="width: 100%;">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg></div>
                        <div class="empty-state-text">Keine Deals vorhanden</div>
                        <div class="empty-state-subtext">Erstellen Sie Deals in der Unternehmensansicht</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pipelineStages.map(stage => {
                const stageDeals = deals.filter(d => d.stage === stage);
                const stageValue = stageDeals.reduce((sum, deal) => sum + (parseFloat(deal.value) || 0), 0);
                
                return `
                    <div class="pipeline-column" data-stage="${stage}" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                        <div class="pipeline-header">
                            <div style="font-weight: 700; margin-bottom: 4px;">${stage}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
                                <span>${stageDeals.length} Deal(s)</span>
                                <span style="font-weight: 600; color: var(--primary);">‚Ç¨ ${stageValue.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                        </div>
                        ${stageDeals.map(deal => renderDealCard(deal)).join('')}
                    </div>
                `;
            }).join('');
        }
        
        function renderDeals() {
            renderPipeline();
        }
        
        function renderDealCard(deal) {
            const company = companies.find(c => c.id === deal.companyId);
            
            return `
                <div class="pipeline-deal" draggable="true" data-deal-id="${deal.id}" ondragstart="handleDragStart(event)">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div class="deal-name" onclick="showDealDetail('${deal.id}')" style="cursor: pointer; flex: 1;">${deal.name}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteDeal('${deal.id}');" title="L√∂schen" style="padding: 4px 8px; font-size: 16px;">üóëÔ∏è</button>
                    </div>
                    
                    ${deal.wonConfirmed ? `
                        <div style="background: #d1fae5; color: #065f46; padding: 8px; border-radius: 6px; margin-bottom: 8px; font-size: 12px; font-weight: 600; text-align: center;">
                            ‚úì Deal gewonnen
                        </div>
                    ` : deal.lostConfirmed ? `
                        <div style="background: #fee2e2; color: #991b1b; padding: 8px; border-radius: 6px; margin-bottom: 8px; font-size: 12px; font-weight: 600; text-align: center;">
                            ‚úì Deal verloren
                        </div>
                    ` : `
                        <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                            <button onclick="event.stopPropagation(); confirmDealWon('${deal.id}');" style="flex: 1; padding: 8px 6px; font-size: 12px; font-weight: 600; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                                ‚úì Gewonnen
                            </button>
                            <button onclick="event.stopPropagation(); confirmDealLost('${deal.id}');" style="flex: 1; padding: 8px 6px; font-size: 12px; font-weight: 600; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                                ‚úó Verloren
                            </button>
                        </div>
                    `}
                    
                    <div class="deal-value" onclick="showDealDetail('${deal.id}')" style="cursor: pointer;">‚Ç¨ ${parseFloat(deal.value).toLocaleString('de-DE', {minimumFractionDigits: 2})}</div>
                    <div class="deal-info" onclick="showDealDetail('${deal.id}')" style="cursor: pointer;">${company ? company.name : 'Unbekannt'}</div>
                    ${deal.services && deal.services.length > 0 ? `
                        <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                            ${deal.services.slice(0, 2).join(', ')}${deal.services.length > 2 ? '...' : ''}
                        </div>
                    ` : ''}
                    ${deal.pdfName ? `
                        <div style="margin-top: 8px; font-size: 11px; color: var(--accent);">
                            üìÑ ${deal.pdfName}
                        </div>
                    ` : ''}
                    <div style="margin-top: 8px; font-size: 14px; color: #FFB800;">
                        ${'‚òÖ'.repeat(deal.score || 3)}${'‚òÜ'.repeat(5 - (deal.score || 3))}
                    </div>
                </div>
            `;
        }
        
        let draggedDealId = null;
        
        function handleDragStart(event) {
            draggedDealId = event.target.getAttribute('data-deal-id');
            event.target.classList.add('dragging');
        }
        
        function handleDragOver(event) {
            event.preventDefault();
        }
        
        function handleDrop(event) {
            event.preventDefault();
            
            const stage = event.currentTarget.getAttribute('data-stage');
            const deal = deals.find(d => d.id === draggedDealId);
            
            if (deal) {
                deal.stage = stage;
                Storage.setItem('bbc_deals', JSON.stringify(deals));
                renderPipeline();
                
                // Update Dashboard KPIs
                updateKPICards();
                updateGoalsProgress();
                updateRevenueOverview();
                
                // Update Analytics if visible
                if (!document.getElementById('analytics-view').classList.contains('hidden')) {
                    updateAnalytics();
                }
            }
            
            document.querySelectorAll('.pipeline-deal').forEach(el => el.classList.remove('dragging'));
            draggedDealId = null;
        }
        
        // Create Order from Deal
        function confirmDealWon(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Deal gewonnen</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <p style="font-size: 16px; margin-bottom: 16px;">
                            M√∂chten Sie den Deal <strong>"${deal.name}"</strong> als gewonnen markieren?
                        </p>
                        
                        <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #065f46;">Das wird automatisch durchgef√ºhrt:</div>
                            <div style="color: #065f46; line-height: 1.8;">
                                ‚úì Deal wird als "Abgeschlossen gewonnen" markiert<br>
                                ‚úì Umsatz von <strong>‚Ç¨ ${parseFloat(deal.value).toLocaleString('de-DE')}</strong> z√§hlt zum Jahresziel<br>
                                ‚úì Ein Auftrag wird automatisch erstellt<br>
                                ‚úì Das Unternehmen erh√§lt den Auftrag
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="executeDealWon('${dealId}'); this.closest('.modal').remove();" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                            Ja, Deal gewonnen
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function executeDealWon(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            console.log('Executing deal won for:', deal.name);
            
            // Set stage to won
            deal.stage = 'Abgeschlossen gewonnen';
            
            // Mark as confirmed
            deal.wonConfirmed = true;
            deal.confirmedAt = new Date().toISOString();
            
            console.log('Creating order...');
            
            // Create order
            createOrderFromDeal(deal);
            
            // Save
            Storage.setItem('bbc_deals', JSON.stringify(deals));
            
            console.log('Deal saved, refreshing views...');
            
            // Refresh views
            renderPipeline();
            renderDashboard();
            
            // Update Analytics if currently open
            if (!document.getElementById('analytics-view').classList.contains('hidden')) {
                updateAnalytics();
            }
            
            // Show success notification
            showNotification(
                'Deal gewonnen', 
                `Der Deal "${deal.name}" wurde als gewonnen markiert und ein Auftrag wurde erstellt.`
            );
            
            // If detail view is open, refresh it
            const detailView = document.getElementById('deal-detail-view');
            if (detailView && !detailView.classList.contains('hidden')) {
                showDealDetail(dealId);
            }
        }
        
        function confirmDealLost(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2 class="modal-title">‚ùå Deal verloren</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <p style="font-size: 16px; margin-bottom: 16px;">
                            M√∂chten Sie den Deal <strong>"${deal.name}"</strong> als verloren markieren?
                        </p>
                        
                        <div style="background: #fef2f2; padding: 16px; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #991b1b;">Das wird durchgef√ºhrt:</div>
                            <div style="color: #991b1b; line-height: 1.8;">
                                ‚úì Deal wird als "Abgeschlossen verloren" markiert<br>
                                ‚úì Wert von <strong>‚Ç¨ ${parseFloat(deal.value).toLocaleString('de-DE')}</strong> wird zu verlorenen Deals addiert<br>
                                ‚úì Dashboard wird aktualisiert
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="executeDealLost('${dealId}'); this.closest('.modal').remove();" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">
                            Ja, Deal verloren
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function executeDealLost(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            console.log('Executing deal lost for:', deal.name);
            
            // Set stage to lost
            deal.stage = 'Abgeschlossen verloren';
            
            // Mark as confirmed
            deal.lostConfirmed = true;
            deal.confirmedAt = new Date().toISOString();
            
            // Save
            Storage.setItem('bbc_deals', JSON.stringify(deals));
            
            console.log('Deal saved, refreshing views...');
            
            // Refresh views
            renderPipeline();
            renderDashboard();
            
            // Update Analytics if currently open
            if (!document.getElementById('analytics-view').classList.contains('hidden')) {
                updateAnalytics();
            }
            
            // Show notification
            showNotification('Deal verloren', `Der Deal "${deal.name}" wurde als verloren markiert.`);
            
            // If detail view is open, refresh it
            const detailView = document.getElementById('deal-detail-view');
            if (detailView && !detailView.classList.contains('hidden')) {
                showDealDetail(dealId);
            }
        }
        
        function createOrderFromDeal(deal) {
            const company = companies.find(c => c.id === deal.companyId);
            
            const order = {
                id: Date.now().toString(),
                orderNumber: 'AU-' + new Date().getFullYear() + '-' + (orders.length + 1).toString().padStart(4, '0'),
                dealId: deal.id,
                dealName: deal.name,
                companyId: deal.companyId,
                companyName: company ? company.name : 'Unbekannt',
                value: deal.value || 0,
                paymentModel: deal.paymentModel || 'one-time',
                contractDuration: deal.contractDuration || null,
                startDate: new Date().toISOString().split('T')[0], // Default: heute
                services: deal.services || [],
                status: 'Neu',
                responsiblePerson: '',
                createdAt: new Date().toISOString(),
                completedAt: null,
                notes: 'Automatisch erstellt aus Deal: ' + deal.name
            };
            
            orders.push(order);
            Storage.setItem('bbc_orders', JSON.stringify(orders));
            
            // Add order to company
            if (company) {
                if (!company.orders) company.orders = [];
                company.orders.push(order.id);
                Storage.setItem('bbc_companies', JSON.stringify(companies));
            }
            
            // Show success notification
            showNotification('Auftrag erstellt', `Auftrag ${order.orderNumber} wurde automatisch f√ºr ${company ? company.name : 'Unbekannt'} erstellt.`);
        }
        
        function showNotification(title, message, duration = 4000) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 350px;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${title}</div>
                <div style="color: var(--text-secondary); font-size: 14px;">${message}</div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }
        
        // Tasks
        function loadEmployees() {
            const select = document.getElementById('taskAssignee');
            const filterSelect = document.getElementById('taskEmployeeFilter');
            
            const options = employees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
            
            select.innerHTML = '<option value="">Nicht zugewiesen</option>' + options;
            filterSelect.innerHTML = '<option value="">Alle Mitarbeiter</option>' + options;
        }
        
        function openTaskModal(companyId = null) {
            const modal = document.getElementById('taskModal');
            if (!modal) {
                console.error('Task modal not found!');
                return;
            }
            
            const form = document.getElementById('taskForm');
            if (form) form.reset();
            
            // Reset modal title
            const modalTitle = modal.querySelector('.modal-title');
            if (modalTitle) modalTitle.textContent = 'Neue Aufgabe';
            
            currentEditingTaskId = null;
            
            // Populate dropdowns
            populateEmployeeDropdown();
            populateCompanyDropdown();
            populateDealDropdown();
            
            // Pre-select company if provided
            if (companyId) {
                const companySelect = document.getElementById('taskCompany');
                if (companySelect) {
                    companySelect.value = companyId;
                    updateTaskContactDropdown();
                }
            }
            
            modal.classList.add('active');
        }
        
        function openTaskModalForContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            openTaskModal(contact ? contact.companyId : null);
            
            if (contact && contact.companyId) {
                const companySelect = document.getElementById('taskCompany');
                const contactSelect = document.getElementById('taskContact');
                
                if (companySelect) companySelect.value = contact.companyId;
                updateTaskContactDropdown();
                if (contactSelect) contactSelect.value = contactId;
            }
        }
        
        function openTaskModalForCompany(companyId) {
            openTaskModal(companyId);
        }
        
        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            // Reset modal title
            const modalTitle = document.querySelector('#taskModal .modal-title');
            if (modalTitle) modalTitle.textContent = 'Neue Aufgabe';
            currentEditingTaskId = null;
        }
        
        function populateEmployeeDropdown() {
            const select = document.getElementById('taskAssignee');
            if (!select) return;
            
            select.innerHTML = '<option value="">Nicht zugewiesen</option>';
            
            employees.forEach(emp => {
                select.innerHTML += `<option value="${emp.name}">${emp.name}</option>`;
            });
        }
        
        function populateCompanyDropdown() {
            const select = document.getElementById('taskCompany');
            if (!select) return;
            
            select.innerHTML = '<option value="">Kein Unternehmen</option>';
            
            companies.forEach(company => {
                select.innerHTML += `<option value="${company.id}">${company.name}</option>`;
            });
        }
        
        function updateTaskContactDropdown() {
            const companySelect = document.getElementById('taskCompany');
            const contactSelect = document.getElementById('taskContact');
            
            if (!companySelect || !contactSelect) return;
            
            const companyId = companySelect.value;
            
            contactSelect.innerHTML = '<option value="">Kein Ansprechpartner</option>';
            
            if (companyId) {
                const companyContacts = contacts.filter(c => c.companyId === companyId);
                companyContacts.forEach(contact => {
                    contactSelect.innerHTML += `<option value="${contact.id}">${contact.name}</option>`;
                });
            }
        }
        
        function populateRelatedDropdown() {
            const select = document.getElementById('taskRelated');
            if (!select) return;
            
            let options = '<option value="">Keine Zuordnung</option>';
            
            options += '<optgroup label="Kontakte">';
            contacts.forEach(contact => {
                options += `<option value="${contact.id}">${contact.name}</option>`;
            });
            options += '</optgroup>';
            
            select.innerHTML = options;
        }
        
        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            const assignee = document.getElementById('taskAssignee').value;
            const companyId = document.getElementById('taskCompany').value;
            const contactId = document.getElementById('taskContact').value;
            const dealId = document.getElementById('taskDeal').value;
            const priority = document.getElementById('taskPriority').value;
            
            if (!title) {
                alert('Bitte geben Sie einen Titel f√ºr die Aufgabe ein.');
                return;
            }
            
            if (currentEditingTaskId) {
                // Bearbeiten
                const task = tasks.find(t => t.id === currentEditingTaskId);
                if (task) {
                    task.title = title;
                    task.description = description;
                    task.dueDate = dueDate;
                    task.assignee = assignee;
                    task.companyId = companyId || null;
                    task.contactId = contactId || null;
                    task.dealId = dealId || null;
                    task.priority = priority;
                }
                currentEditingTaskId = null;
            } else {
                // Neu erstellen
                const task = {
                    id: Date.now().toString(),
                    title,
                    description,
                    dueDate,
                    assignee,
                    companyId: companyId || null,
                    contactId: contactId || null,
                    dealId: dealId || null,
                    priority: priority || 'mittel',
                    status: 'offen',
                    createdAt: new Date().toISOString(),
                    overdue: false,
                    reminderSent: false
                };
                tasks.push(task);
            }
            
            Storage.setItem('bbc_tasks', JSON.stringify(tasks));
            closeTaskModal();
            renderTasks();
            checkOverdueTasks();
            
            // Refresh detail views if open
            if (!document.getElementById('contact-detail-view').classList.contains('hidden')) {
                const contact = contacts.find(c => c.id === contactId);
                if (contact) showContactDetail(contact.id);
            }
            if (!document.getElementById('company-detail-view').classList.contains('hidden')) {
                if (companyId) {
                    showCompanyDetail(companyId);
                }
            }
        }
        
        function populateDealDropdown() {
            const select = document.getElementById('taskDeal');
            if (!select) return;
            
            select.innerHTML = '<option value="">Kein Deal</option>';
            
            deals.forEach(deal => {
                const company = companies.find(c => c.id === deal.companyId);
                const companyName = company ? company.name : 'Unbekannt';
                select.innerHTML += `<option value="${deal.id}">${deal.name} (${companyName})</option>`;
            });
        }
        
        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            
            if (!container) {
                console.error('tasksContainer not found!');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                        <div class="empty-state-text">Keine Aufgaben vorhanden</div>
                        <div class="empty-state-subtext">Erstellen Sie Ihre erste Aufgabe</div>
                    </div>
                `;
                return;
            }
            
            checkOverdueTasks();
            const sortedTasks = sortTasksByPriority([...tasks]);
            
            container.innerHTML = sortedTasks.map(task => {
                const contact = contacts.find(c => c.id === task.contactId);
                const company = task.companyId ? companies.find(c => c.id === task.companyId) : null;
                const deal = task.dealId ? deals.find(d => d.id === task.dealId) : null;
                const overdueClass = task.overdue ? ' task-overdue' : '';
                
                const priorityColors = {
                    'hoch': '#ef4444',
                    'mittel': '#f59e0b',
                    'niedrig': '#10b981'
                };
                const priorityColor = priorityColors[task.priority] || priorityColors['mittel'];
                
                return `
                    <div class="task-item${overdueClass}">
                        <div style="width: 4px; height: 100%; background: ${priorityColor}; position: absolute; left: 0; top: 0; border-radius: 8px 0 0 8px;"></div>
                        <input type="checkbox" class="select-checkbox task-checkbox" data-id="${task.id}" onchange="updateTasksBulkActions()" style="margin-right: 16px; margin-left: 8px;">
                        <div class="task-content">
                            <div class="task-title">
                                ${task.overdue ? '' : ''}${task.title}
                            </div>
                            <div class="task-meta">
                                ${task.assignee ? `üë§ ${task.assignee} (BBC)` : ''}
                                ${task.dueDate ? ` ‚Ä¢ ${new Date(task.dueDate).toLocaleDateString('de-DE')}` : ''}
                                ${company ? ` ‚Ä¢ üè¢ ${company.name}` : ''}
                                ${contact ? ` ‚Ä¢ üë§ ${contact.name}` : ''}
                                ${deal ? ` ‚Ä¢ ${deal.name}` : ''}
                                ${task.overdue ? ' ‚Ä¢ <span style="color: var(--danger); font-weight: 600;">√úBERF√ÑLLIG</span>' : ''}
                            </div>
                            ${task.description ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">${task.description}</div>` : ''}
                        </div>
                        <div class="task-actions">
                            <button class="icon-btn" onclick="openTaskEditModal('${task.id}')" title="Bearbeiten">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="toggleTaskStatus('${task.id}')" title="${task.status === 'offen' ? 'Als erledigt markieren' : 'Als offen markieren'}">
                                ${task.status === 'offen' ? '‚òê' : '‚òë'}
                            </button>
                            <button class="icon-btn" onclick="deleteTask('${task.id}')" title="L√∂schen">üóë</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateTasksBulkActions();
        }
        
        function renderTaskItem(task, relatedContact = null) {
            const contact = relatedContact || contacts.find(c => c.id === task.contactId);
            const deal = task.dealId ? deals.find(d => d.id === task.dealId) : null;
            
            return `
                <div class="task-item">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            ${task.assignee ? `üë§ ${task.assignee}` : ''}
                            ${task.dueDate ? ` ‚Ä¢ ${new Date(task.dueDate).toLocaleDateString('de-DE')}` : ''}
                            ${contact ? ` ‚Ä¢ üë§ ${contact.name}` : ''}
                            ${deal ? ` ‚Ä¢ ${deal.name}` : ''}
                        </div>
                        ${task.description ? `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 6px;">${task.description}</div>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="icon-btn" onclick="toggleTaskStatus('${task.id}')" title="${task.status === 'offen' ? 'Als erledigt markieren' : 'Als offen markieren'}">
                            ${task.status === 'offen' ? '‚òê' : '‚òë'}
                        </button>
                        <button class="icon-btn" onclick="deleteTask('${task.id}')" title="L√∂schen">üóë</button>
                    </div>
                </div>
            `;
        }
        
        function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = task.status === 'offen' ? 'erledigt' : 'offen';
                Storage.setItem('bbc_tasks', JSON.stringify(tasks));
                renderTasks();
            }
        }
        
        function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            showConfirmModal(
                `M√∂chten Sie die Aufgabe "${task.title}" wirklich l√∂schen?`,
                function() {
                    tasks = tasks.filter(t => t.id !== taskId);
                    Storage.setItem('bbc_tasks', JSON.stringify(tasks));
                    renderTasks();
                }
            );
        }
        
        // Delete Functions
        function deleteContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            showConfirmModal(
                `M√∂chten Sie den Kontakt "${contact.name}" wirklich l√∂schen? Alle verkn√ºpften Aufgaben werden ebenfalls gel√∂scht.`,
                function() {
                    // Delete related tasks
                    tasks = tasks.filter(t => t.contactId !== contactId);
                    Storage.setItem('bbc_tasks', JSON.stringify(tasks));
                    
                    // Delete contact
                    contacts = contacts.filter(c => c.id !== contactId);
                    Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                    
                    renderContacts();
                    populateRelatedDropdown();
                    
                    // If on detail view, go back
                    if (!document.getElementById('contact-detail-view').classList.contains('hidden')) {
                        backToContacts();
                    }
                }
            );
        }
        
        function deleteCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            const companyContacts = contacts.filter(c => c.companyId === companyId);
            const companyDeals = deals.filter(d => d.companyId === companyId);
            
            let message = `M√∂chten Sie das Unternehmen "${company.name}" wirklich l√∂schen?`;
            if (companyContacts.length > 0) {
                message += `\n\n${companyContacts.length} Kontakt(e) werden von diesem Unternehmen getrennt.`;
            }
            if (companyDeals.length > 0) {
                message += `\n${companyDeals.length} Deal(s) werden ebenfalls gel√∂scht.`;
            }
            
            showConfirmModal(message, function() {
                // Unlink contacts from company
                contacts.forEach(contact => {
                    if (contact.companyId === companyId) {
                        contact.companyId = null;
                    }
                });
                Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                
                // Delete deals
                deals = deals.filter(d => d.companyId !== companyId);
                Storage.setItem('bbc_deals', JSON.stringify(deals));
                
                // Delete company
                companies = companies.filter(c => c.id !== companyId);
                Storage.setItem('bbc_companies', JSON.stringify(companies));
                
                renderCompanies();
                renderContacts();
                renderPipeline();
                populateCompanyDropdown();
                
                // If on detail view, go back
                if (!document.getElementById('company-detail-view').classList.contains('hidden')) {
                    backToCompanies();
                }
            });
        }
        
        function deleteDeal(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            showConfirmModal(
                `M√∂chten Sie den Deal "${deal.name}" wirklich l√∂schen?`,
                function() {
                    const companyId = deal.companyId;
                    
                    deals = deals.filter(d => d.id !== dealId);
                    Storage.setItem('bbc_deals', JSON.stringify(deals));
                    
                    renderPipeline();
                    renderCompanies();
                    
                    // Refresh company detail if open
                    if (!document.getElementById('company-detail-view').classList.contains('hidden') && companyId) {
                        showCompanyDetail(companyId);
                    }
                }
            );
        }
        
        function filterTasks() {
            const employeeFilter = document.getElementById('taskEmployeeFilter').value;
            const statusFilter = document.getElementById('taskStatusFilter').value;
            
            const filtered = tasks.filter(task => {
                const matchesEmployee = !employeeFilter || task.assignee === employeeFilter;
                const matchesStatus = !statusFilter || task.status === statusFilter;
                
                return matchesEmployee && matchesStatus;
            });
            
            const container = document.getElementById('tasksContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                        <div class="empty-state-text">Keine Ergebnisse</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(task => renderTaskItem(task)).join('');
        }
        
        // Bulk Actions for Contacts
        function updateContactsBulkActions() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            const count = checkboxes.length;
            const bulkBar = document.getElementById('contactsBulkActions');
            const selectAll = document.getElementById('selectAllContacts');
            
            document.getElementById('contactsSelectedCount').textContent = count;
            
            if (count > 0) {
                bulkBar.classList.add('active');
            } else {
                bulkBar.classList.remove('active');
            }
            
            const allCheckboxes = document.querySelectorAll('.contact-checkbox');
            selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }
        
        function toggleSelectAllContacts() {
            const selectAll = document.getElementById('selectAllContacts');
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateContactsBulkActions();
        }
        
        function deselectAllContacts() {
            document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllContacts').checked = false;
            updateContactsBulkActions();
        }
        
        function bulkDeleteContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            
            if (ids.length === 0) return;
            
            showConfirmModal(
                `M√∂chten Sie ${ids.length} Kontakt(e) wirklich l√∂schen? Alle verkn√ºpften Aufgaben werden ebenfalls gel√∂scht.`,
                function() {
                    // Delete related tasks
                    tasks = tasks.filter(t => !ids.includes(t.contactId));
                    Storage.setItem('bbc_tasks', JSON.stringify(tasks));
                    
                    // Delete contacts
                    contacts = contacts.filter(c => !ids.includes(c.id));
                    Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                    
                    deselectAllContacts();
                    renderContacts();
                    populateRelatedDropdown();
                }
            );
        }
        
        // Bulk Actions for Companies
        function updateCompaniesBulkActions() {
            const checkboxes = document.querySelectorAll('.company-checkbox:checked');
            const count = checkboxes.length;
            const bulkBar = document.getElementById('companiesBulkActions');
            const selectAll = document.getElementById('selectAllCompanies');
            
            document.getElementById('companiesSelectedCount').textContent = count;
            
            if (count > 0) {
                bulkBar.classList.add('active');
            } else {
                bulkBar.classList.remove('active');
            }
            
            const allCheckboxes = document.querySelectorAll('.company-checkbox');
            selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }
        
        function toggleSelectAllCompanies() {
            const selectAll = document.getElementById('selectAllCompanies');
            const checkboxes = document.querySelectorAll('.company-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateCompaniesBulkActions();
        }
        
        function deselectAllCompanies() {
            document.querySelectorAll('.company-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllCompanies').checked = false;
            updateCompaniesBulkActions();
        }
        
        function bulkDeleteCompanies() {
            const checkboxes = document.querySelectorAll('.company-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            
            if (ids.length === 0) return;
            
            let totalContacts = 0;
            let totalDeals = 0;
            
            ids.forEach(id => {
                totalContacts += contacts.filter(c => c.companyId === id).length;
                totalDeals += deals.filter(d => d.companyId === id).length;
            });
            
            let message = `M√∂chten Sie ${ids.length} Unternehmen wirklich l√∂schen?`;
            if (totalContacts > 0) {
                message += `\n\n${totalContacts} Kontakt(e) werden von diesen Unternehmen getrennt.`;
            }
            if (totalDeals > 0) {
                message += `\n${totalDeals} Deal(s) werden ebenfalls gel√∂scht.`;
            }
            
            showConfirmModal(message, function() {
                // Unlink contacts from companies
                contacts.forEach(contact => {
                    if (ids.includes(contact.companyId)) {
                        contact.companyId = null;
                    }
                });
                Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                
                // Delete deals
                deals = deals.filter(d => !ids.includes(d.companyId));
                Storage.setItem('bbc_deals', JSON.stringify(deals));
                
                // Delete companies
                companies = companies.filter(c => !ids.includes(c.id));
                Storage.setItem('bbc_companies', JSON.stringify(companies));
                
                deselectAllCompanies();
                renderCompanies();
                renderContacts();
                renderPipeline();
                populateCompanyDropdown();
            });
        }
        
        // Bulk Actions for Tasks
        function updateTasksBulkActions() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            const count = checkboxes.length;
            const bulkBar = document.getElementById('tasksBulkActions');
            const selectAll = document.getElementById('selectAllTasks');
            
            document.getElementById('tasksSelectedCount').textContent = count;
            
            if (count > 0) {
                bulkBar.classList.add('active');
            } else {
                bulkBar.classList.remove('active');
            }
            
            const allCheckboxes = document.querySelectorAll('.task-checkbox');
            selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }
        
        function toggleSelectAllTasks() {
            const selectAll = document.getElementById('selectAllTasks');
            const checkboxes = document.querySelectorAll('.task-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateTasksBulkActions();
        }
        
        function deselectAllTasks() {
            document.querySelectorAll('.task-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllTasks').checked = false;
            updateTasksBulkActions();
        }
        
        function bulkDeleteTasks() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            
            if (ids.length === 0) return;
            
            showConfirmModal(
                `M√∂chten Sie ${ids.length} Aufgabe(n) wirklich l√∂schen?`,
                function() {
                    tasks = tasks.filter(t => !ids.includes(t.id));
                    Storage.setItem('bbc_tasks', JSON.stringify(tasks));
                    
                    deselectAllTasks();
                    renderTasks();
                }
            );
        }
        
        // CSV Import/Export Functions
        function exportContactsCSV() {
            const headers = ['Vorname', 'Nachname', 'Email', 'Telefon', 'Unternehmensname', 'Branche', 'Lead Status'];
            const rows = [headers];
            
            contacts.forEach(contact => {
                const company = companies.find(c => c.id === contact.companyId);
                rows.push([
                    contact.firstName || '',
                    contact.lastName || '',
                    contact.email || '',
                    contact.phone || '',
                    company ? company.name : '',
                    company ? company.industry : '',
                    contact.status || ''
                ]);
            });
            
            const csvContent = rows.map(row => 
                row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma, quote, or newline
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',')
            ).join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `kontakte_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file, 'UTF-8');
            
            // Reset file input
            event.target.value = '';
        }
        
        function parseCSV(text) {
            const lines = [];
            let currentLine = [];
            let currentCell = '';
            let insideQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++; // Skip next quote
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentLine.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (currentCell || currentLine.length > 0) {
                        currentLine.push(currentCell.trim());
                        if (currentLine.some(cell => cell !== '')) {
                            lines.push(currentLine);
                        }
                        currentLine = [];
                        currentCell = '';
                    }
                    // Skip \r\n combinations
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                } else {
                    currentCell += char;
                }
            }
            
            // Add last cell and line
            if (currentCell || currentLine.length > 0) {
                currentLine.push(currentCell.trim());
                if (currentLine.some(cell => cell !== '')) {
                    lines.push(currentLine);
                }
            }
            
            if (lines.length < 2) {
                alert('Die CSV-Datei enth√§lt keine Daten.');
                return;
            }
            
            csvImportData = {
                headers: lines[0],
                rows: lines.slice(1)
            };
            
            showCsvMappingModal();
        }
        
        function showCsvMappingModal() {
            if (!csvImportData) return;
            
            document.getElementById('csvRowCount').textContent = csvImportData.rows.length;
            
            const fieldOptions = [
                { value: '', label: '-- Nicht importieren --' },
                { value: 'firstName', label: 'Vorname' },
                { value: 'lastName', label: 'Nachname' },
                { value: 'email', label: 'E-Mail' },
                { value: 'phone', label: 'Telefon' },
                { value: 'companyName', label: 'Unternehmensname' },
                { value: 'industry', label: 'Branche' },
                { value: 'status', label: 'Lead Status' }
            ];
            
            const mappingHTML = csvImportData.headers.map((header, index) => {
                // Try to auto-detect field
                let autoDetect = '';
                const lowerHeader = header.toLowerCase();
                if (lowerHeader.includes('vorname') || lowerHeader.includes('firstname') || lowerHeader.includes('first name')) {
                    autoDetect = 'firstName';
                } else if (lowerHeader.includes('nachname') || lowerHeader.includes('lastname') || lowerHeader.includes('last name')) {
                    autoDetect = 'lastName';
                } else if (lowerHeader.includes('name') && !lowerHeader.includes('company') && !lowerHeader.includes('unternehmen')) {
                    autoDetect = 'firstName';
                } else if (lowerHeader.includes('email') || lowerHeader.includes('e-mail') || lowerHeader.includes('mail')) {
                    autoDetect = 'email';
                } else if (lowerHeader.includes('phone') || lowerHeader.includes('telefon') || lowerHeader.includes('tel')) {
                    autoDetect = 'phone';
                } else if (lowerHeader.includes('company') || lowerHeader.includes('unternehmen') || lowerHeader.includes('firma')) {
                    autoDetect = 'companyName';
                } else if (lowerHeader.includes('branche') || lowerHeader.includes('industry')) {
                    autoDetect = 'industry';
                } else if (lowerHeader.includes('status')) {
                    autoDetect = 'status';
                }
                
                return `
                    <div style="display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 16px; padding: 16px; border-bottom: 1px solid var(--border); align-items: center;">
                        <div style="font-weight: 600; color: var(--text-primary);">
                            ${header || `Spalte ${index + 1}`}
                        </div>
                        <select class="form-select csv-field-mapping" data-column="${index}">
                            ${fieldOptions.map(opt => 
                                `<option value="${opt.value}" ${opt.value === autoDetect ? 'selected' : ''}>${opt.label}</option>`
                            ).join('')}
                        </select>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Beispiel: ${csvImportData.rows[0] && csvImportData.rows[0][index] ? csvImportData.rows[0][index] : '-'}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('csvMappingFields').innerHTML = mappingHTML;
            document.getElementById('csvMappingModal').classList.add('active');
        }
        
        function closeCsvMappingModal() {
            document.getElementById('csvMappingModal').classList.remove('active');
            csvImportData = null;
        }
        
        function executeCSVImport() {
            if (!csvImportData) return;
            
            const mappings = {};
            document.querySelectorAll('.csv-field-mapping').forEach(select => {
                const column = parseInt(select.getAttribute('data-column'));
                const field = select.value;
                if (field) {
                    mappings[column] = field;
                }
            });
            
            // Get import tag if specified
            const importTag = document.getElementById('csvImportTag').value.trim();
            
            let importedCount = 0;
            let createdCompanies = 0;
            
            csvImportData.rows.forEach(row => {
                const contactData = {
                    firstName: '',
                    lastName: '',
                    email: '',
                    phone: '',
                    companyName: '',
                    industry: '',
                    status: 'Einfacher Kontakt'
                };
                
                // Map data from CSV
                Object.keys(mappings).forEach(colIndex => {
                    const field = mappings[colIndex];
                    const value = row[colIndex] || '';
                    contactData[field] = value;
                });
                
                // Skip if no firstName/lastName or email
                if (!contactData.firstName && !contactData.lastName && !contactData.email) {
                    return;
                }
                
                // Build full name
                const name = `${contactData.firstName} ${contactData.lastName}`.trim();
                
                // Find or create company
                let companyId = null;
                if (contactData.companyName) {
                    let company = companies.find(c => 
                        c.name.toLowerCase() === contactData.companyName.toLowerCase()
                    );
                    
                    if (!company) {
                        company = {
                            id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                            name: contactData.companyName,
                            industry: contactData.industry || '',
                            status: contactData.status,
                            services: [],
                            score: 3,
                            createdAt: new Date().toISOString(),
                            protocol: []
                        };
                        companies.push(company);
                        createdCompanies++;
                    }
                    
                    companyId = company.id;
                }
                
                // Prepare tags array
                const tags = [];
                if (importTag) {
                    tags.push(importTag);
                    // Add to availableTags if not exists
                    if (!availableTags.includes(importTag)) {
                        availableTags.push(importTag);
                    }
                }
                
                // Create contact
                const contact = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    firstName: contactData.firstName,
                    lastName: contactData.lastName,
                    name: name || contactData.email,
                    email: contactData.email,
                    phone: contactData.phone,
                    companyId: companyId,
                    status: contactData.status,
                    services: [],
                    position: '',
                    tags: tags,
                    createdAt: new Date().toISOString()
                };
                
                contacts.push(contact);
                importedCount++;
            });
            
            // Save to localStorage
            Storage.setItem('bbc_contacts', JSON.stringify(contacts));
            Storage.setItem('bbc_companies', JSON.stringify(companies));
            Storage.setItem('bbc_available_tags', JSON.stringify(availableTags));
            
            closeCsvMappingModal();
            renderContacts();
            renderCompanies();
            populateCompanyDropdown();
            populateRelatedDropdown();
            
            let message = `Import erfolgreich!\n\n${importedCount} Kontakt(e) importiert\n${createdCompanies} Unternehmen erstellt`;
            if (importTag) {
                message += `\n\nTag "${importTag}" wurde allen Kontakten zugeordnet.`;
            }
            alert(message);
        }
        
        // ==========================================
        // SETTINGS FUNKTIONEN
        // ==========================================
        let currentSettingsTab = 'employees';
        let generalSettings = JSON.parse(Storage.getItem('bbc_general_settings') || '{}');
        let dealStages = JSON.parse(Storage.getItem('bbc_deal_stages') || '["Qualifizierung", "Angebot", "Verhandlung", "Abgeschlossen gewonnen", "Abgeschlossen verloren"]');
        let leadStatuses = JSON.parse(Storage.getItem('bbc_lead_statuses') || '["Einfacher Kontakt", "Akquise", "In Bearbeitung", "Kunde", "Ehemaliger Kunde", "Partner"]');

        function switchSettingsTab(tabName) {
            currentSettingsTab = tabName;
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`settings-${tabName}`).classList.remove('hidden');
            
            switch(tabName) {
                case 'employees': renderEmployeesList(); break;
                case 'services': renderCustomServicesSettings(); break;
                case 'stages': renderDealStagesList(); break;
                case 'statuses': renderLeadStatusesList(); break;
                case 'general': loadGeneralSettings(); break;
            }
        }

        function renderEmployeesList() {
            const container = document.getElementById('employeesList');
            if (!employees || employees.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div><div class="empty-state-text">Keine Mitarbeiter</div></div>';
                return;
            }
            container.innerHTML = employees.map(emp => `
                <div class="employee-card">
                    <div class="employee-info">
                        <div class="employee-name">${emp.name}</div>
                        ${emp.position ? `<div class="employee-meta">${emp.position}</div>` : ''}
                        ${emp.department ? `<div class="employee-meta">üè¢ ${emp.department}</div>` : ''}
                        ${emp.email ? `<div class="employee-meta">${emp.email}</div>` : ''}
                        ${emp.phone ? `<div class="employee-meta">üìû ${emp.phone}</div>` : ''}
                    </div>
                    <div class="employee-actions">
                        <button class="btn btn-secondary" onclick="openEmployeeModal('${emp.id}')">Bearbeiten</button>
                        <button class="delete-btn" onclick="deleteEmployee('${emp.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function openEmployeeModal(employeeId = null) {
            document.getElementById('employeeForm').reset();
            if (employeeId) {
                const emp = employees.find(e => e.id === employeeId);
                if (emp) {
                    document.getElementById('employeeModalTitle').textContent = 'Mitarbeiter bearbeiten';
                    document.getElementById('employeeId').value = emp.id;
                    document.getElementById('employeeName').value = emp.name || '';
                    document.getElementById('employeePosition').value = emp.position || '';
                    document.getElementById('employeeEmail').value = emp.email || '';
                    document.getElementById('employeePhone').value = emp.phone || '';
                    document.getElementById('employeeDepartment').value = emp.department || '';
                    document.getElementById('employeeNotes').value = emp.notes || '';
                }
            } else {
                document.getElementById('employeeModalTitle').textContent = 'Neuer Mitarbeiter';
            }
            document.getElementById('employeeModal').classList.add('active');
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.remove('active');
        }

        function saveEmployee() {
            const id = document.getElementById('employeeId').value;
            const name = document.getElementById('employeeName').value.trim();
            if (!name) { alert('Bitte Namen eingeben'); return; }
            
            const emp = {
                id: id || Date.now().toString(),
                name: name,
                position: document.getElementById('employeePosition').value,
                email: document.getElementById('employeeEmail').value,
                phone: document.getElementById('employeePhone').value,
                department: document.getElementById('employeeDepartment').value,
                notes: document.getElementById('employeeNotes').value
            };
            
            if (id) {
                const index = employees.findIndex(e => e.id === id);
                if (index !== -1) employees[index] = emp;
            } else {
                employees.push(emp);
            }
            
            Storage.setItem('bbc_employees', JSON.stringify(employees));
            closeEmployeeModal();
            renderEmployeesList();
            loadEmployees();
        }

        function deleteEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            showConfirmModal(`${emp.name} l√∂schen?`, function() {
                employees = employees.filter(e => e.id !== id);
                Storage.setItem('bbc_employees', JSON.stringify(employees));
                renderEmployeesList();
                loadEmployees();
            });
        }

        function renderCustomServicesSettings() {
            const container = document.getElementById('customServicesSettings');
            if (!customServices || customServices.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:40px;">Keine eigenen Leistungen</p>';
                return;
            }
            container.innerHTML = `<div style="background:white;padding:24px;border-radius:12px;">
                <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;">Ihre Leistungen</h3>
                ${customServices.map((s, i) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);">
                    <span>${s}</span><button class="delete-btn" onclick="deleteCustomServiceSetting(${i})">üóëÔ∏è</button>
                </div>`).join('')}
            </div>`;
        }

        function addCustomServiceSetting() {
            const input = document.getElementById('newServiceInput');
            const s = input.value.trim();
            if (!s) { alert('Bitte Leistung eingeben'); return; }
            if (customServices.includes(s)) { alert('Existiert bereits'); return; }
            customServices.push(s);
            Storage.setItem('bbc_custom_services', JSON.stringify(customServices));
            input.value = '';
            renderCustomServicesSettings();
        }

        function deleteCustomServiceSetting(i) {
            showConfirmModal('Leistung l√∂schen?', function() {
                customServices.splice(i, 1);
                Storage.setItem('bbc_custom_services', JSON.stringify(customServices));
                renderCustomServicesSettings();
            });
        }

        function renderDealStagesList() {
            document.getElementById('dealStagesList').innerHTML = dealStages.map((s, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);">
                    <input type="text" class="form-input" value="${s}" onchange="updateDealStage(${i}, this.value)" style="flex:1;margin-right:12px;">
                    <button class="delete-btn" onclick="deleteDealStage(${i})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateDealStage(i, v) {
            dealStages[i] = v;
            Storage.setItem('bbc_deal_stages', JSON.stringify(dealStages));
        }

        function addDealStage() {
            dealStages.push('Neue Phase');
            Storage.setItem('bbc_deal_stages', JSON.stringify(dealStages));
            renderDealStagesList();
        }

        function deleteDealStage(i) {
            if (dealStages.length <= 1) { alert('Min. 1 Phase erforderlich'); return; }
            dealStages.splice(i, 1);
            Storage.setItem('bbc_deal_stages', JSON.stringify(dealStages));
            renderDealStagesList();
        }

        function renderLeadStatusesList() {
            document.getElementById('leadStatusesList').innerHTML = leadStatuses.map((s, i) => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);">
                    <input type="text" class="form-input" value="${s}" onchange="updateLeadStatus(${i}, this.value)" style="flex:1;margin-right:12px;">
                    <button class="delete-btn" onclick="deleteLeadStatus(${i})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateLeadStatus(i, v) {
            leadStatuses[i] = v;
            Storage.setItem('bbc_lead_statuses', JSON.stringify(leadStatuses));
        }

        function addLeadStatus() {
            leadStatuses.push('Neuer Status');
            Storage.setItem('bbc_lead_statuses', JSON.stringify(leadStatuses));
            renderLeadStatusesList();
        }

        function deleteLeadStatus(i) {
            if (leadStatuses.length <= 1) { alert('Min. 1 Status erforderlich'); return; }
            leadStatuses.splice(i, 1);
            Storage.setItem('bbc_lead_statuses', JSON.stringify(leadStatuses));
            renderLeadStatusesList();
        }

        function loadGeneralSettings() {
            document.getElementById('companyNameSetting').value = generalSettings.companyName || '';
            document.getElementById('companyEmailSetting').value = generalSettings.companyEmail || '';
            document.getElementById('companyPhoneSetting').value = generalSettings.companyPhone || '';
            document.getElementById('enableReminders').checked = generalSettings.enableReminders || false;
            document.getElementById('reminderDays').value = generalSettings.reminderDays || 1;
        }

        function saveGeneralSettings() {
            generalSettings = {
                companyName: document.getElementById('companyNameSetting').value,
                companyEmail: document.getElementById('companyEmailSetting').value,
                companyPhone: document.getElementById('companyPhoneSetting').value,
                enableReminders: document.getElementById('enableReminders').checked,
                reminderDays: parseInt(document.getElementById('reminderDays').value)
            };
            Storage.setItem('bbc_general_settings', JSON.stringify(generalSettings));
            alert('Einstellungen gespeichert!');
        }

        function createBackup() {
            const backup = {
                version: '2.0',
                date: new Date().toISOString(),
                contacts,
                companies,
                deals,
                orders,
                tasks,
                reminders,
                employees,
                customServices,
                availableTags,
                dealStages,
                leadStatuses,
                generalSettings,
                dashboardGoals
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bbc-crm-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('Backup erstellt', `Backup mit ${contacts.length} Kontakten, ${companies.length} Unternehmen, ${deals.length} Deals und ${orders.length} Auftr√§gen wurde heruntergeladen.`);
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file || !confirm('ACHTUNG: Alle aktuellen Daten werden √ºberschrieben! Fortfahren?')) { 
                event.target.value = ''; 
                return; 
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const b = JSON.parse(e.target.result);
                    
                    // Load all data
                    contacts = b.contacts || [];
                    companies = b.companies || [];
                    deals = b.deals || [];
                    orders = b.orders || [];
                    tasks = b.tasks || [];
                    reminders = b.reminders || [];
                    employees = b.employees || [];
                    customServices = b.customServices || [];
                    availableTags = b.availableTags || [];
                    dealStages = b.dealStages || [];
                    leadStatuses = b.leadStatuses || [];
                    generalSettings = b.generalSettings || {};
                    dashboardGoals = b.dashboardGoals || {revenue: 0, contacts: 0, deals: 0};
                    
                    // Save to localStorage
                    Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                    Storage.setItem('bbc_companies', JSON.stringify(companies));
                    Storage.setItem('bbc_deals', JSON.stringify(deals));
                    Storage.setItem('bbc_orders', JSON.stringify(orders));
                    Storage.setItem('bbc_tasks', JSON.stringify(tasks));
                    Storage.setItem('bbc_reminders', JSON.stringify(reminders));
                    Storage.setItem('bbc_employees', JSON.stringify(employees));
                    Storage.setItem('bbc_custom_services', JSON.stringify(customServices));
                    Storage.setItem('bbc_available_tags', JSON.stringify(availableTags));
                    Storage.setItem('bbc_deal_stages', JSON.stringify(dealStages));
                    Storage.setItem('bbc_lead_statuses', JSON.stringify(leadStatuses));
                    Storage.setItem('bbc_general_settings', JSON.stringify(generalSettings));
                    Storage.setItem('bbc_dashboard_goals', JSON.stringify(dashboardGoals));
                    
                    showNotification('Backup wiederhergestellt', `${contacts.length} Kontakte, ${companies.length} Unternehmen, ${deals.length} Deals und ${orders.length} Auftr√§ge wurden importiert.`);
                    
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } catch(err) {
                    alert('Fehler beim Wiederherstellen: ' + err.message);
                    console.error('Restore error:', err);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function deleteAllData() {
            const c = prompt('WARNUNG: Alle Daten werden unwiderruflich gel√∂scht!\n\nGeben Sie "ALLES L√ñSCHEN" ein um fortzufahren:');
            if (c === 'ALLES L√ñSCHEN') {
                localStorage.clear();
                alert('Alle Daten wurden gel√∂scht.');
                location.reload();
            }
        }
        
        // ==========================================
        // SERVICES EDIT FUNKTIONEN
        // ==========================================
        function openServicesEditModal(entityType, entityId) {
            document.getElementById('servicesEditEntityType').value = entityType;
            document.getElementById('servicesEditEntityId').value = entityId;
            
            let entity;
            if (entityType === 'contact') {
                entity = contacts.find(c => c.id === entityId);
                document.getElementById('servicesEditModalTitle').textContent = 'Leistungen bearbeiten - Kontakt';
            } else if (entityType === 'company') {
                entity = companies.find(c => c.id === entityId);
                document.getElementById('servicesEditModalTitle').textContent = 'Leistungen bearbeiten - Unternehmen';
            }
            
            if (!entity) return;
            
            // Reset checkboxes
            document.querySelectorAll('input[name="edit-service"]').forEach(cb => cb.checked = false);
            
            // Set current services
            if (entity.services) {
                entity.services.forEach(service => {
                    const checkbox = Array.from(document.querySelectorAll('input[name="edit-service"]'))
                        .find(cb => cb.value === service);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
            
            // Render custom services in edit modal
            renderEditCustomServices(entity.services || []);
            
            // Update current services display
            updateCurrentServicesDisplay();
            
            document.getElementById('servicesEditModal').classList.add('active');
            
            // Add change listeners to update display
            document.querySelectorAll('input[name="edit-service"]').forEach(cb => {
                cb.addEventListener('change', updateCurrentServicesDisplay);
            });
        }
        
        function closeServicesEditModal() {
            document.getElementById('servicesEditModal').classList.remove('active');
        }
        
        function updateCurrentServicesDisplay() {
            const container = document.getElementById('currentServicesList');
            const selectedServices = Array.from(document.querySelectorAll('input[name="edit-service"]:checked'))
                .map(cb => cb.value);
            
            if (selectedServices.length === 0) {
                container.innerHTML = '<span style="color: var(--text-secondary);">Keine Leistungen ausgew√§hlt</span>';
            } else {
                container.innerHTML = selectedServices.map(s => 
                    `<span class="badge badge-primary">${s}</span>`
                ).join('');
            }
        }
        
        function renderEditCustomServices(currentServices) {
            const container = document.getElementById('editCustomServicesList');
            
            if (customServices.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="services-section">
                    <div class="service-category">Eigene Leistungen</div>
                    ${customServices.map((service, index) => {
                        const isChecked = currentServices.includes(service);
                        return `
                            <div class="checkbox-item">
                                <input type="checkbox" id="edit-custom-service-${index}" value="${service}" name="edit-service" ${isChecked ? 'checked' : ''}>
                                <label for="edit-custom-service-${index}">${service}</label>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Add change listeners
            document.querySelectorAll('input[name="edit-service"]').forEach(cb => {
                cb.addEventListener('change', updateCurrentServicesDisplay);
            });
        }
        
        function addCustomServiceToEdit() {
            const input = document.getElementById('editNewServiceInput');
            const service = input.value.trim();
            
            if (!service) {
                alert('Bitte geben Sie eine Leistung ein.');
                return;
            }
            
            if (customServices.includes(service)) {
                alert('Diese Leistung existiert bereits.');
                return;
            }
            
            customServices.push(service);
            Storage.setItem('bbc_custom_services', JSON.stringify(customServices));
            
            const entityType = document.getElementById('servicesEditEntityType').value;
            const entityId = document.getElementById('servicesEditEntityId').value;
            let entity;
            
            if (entityType === 'contact') {
                entity = contacts.find(c => c.id === entityId);
            } else if (entityType === 'company') {
                entity = companies.find(c => c.id === entityId);
            }
            
            renderEditCustomServices(entity ? entity.services : []);
            input.value = '';
        }
        
        function saveServicesEdit() {
            const entityType = document.getElementById('servicesEditEntityType').value;
            const entityId = document.getElementById('servicesEditEntityId').value;
            
            const selectedServices = Array.from(document.querySelectorAll('input[name="edit-service"]:checked'))
                .map(cb => cb.value);
            
            if (entityType === 'contact') {
                const contact = contacts.find(c => c.id === entityId);
                if (contact) {
                    contact.services = selectedServices;
                    Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                    
                    // Update company services if contact has company
                    if (contact.companyId) {
                        updateCompanyServices(contact.companyId);
                    }
                    
                    closeServicesEditModal();
                    showContactDetail(entityId);
                    renderContacts();
                }
            } else if (entityType === 'company') {
                const company = companies.find(c => c.id === entityId);
                if (company) {
                    company.services = selectedServices;
                    Storage.setItem('bbc_companies', JSON.stringify(companies));
                    
                    closeServicesEditModal();
                    showCompanyDetail(entityId);
                    renderCompanies();
                }
            }
        }
        
        // ==========================================
        // ORDERS FUNKTIONEN
        // ==========================================
        function renderOrders() {
            const filterStatus = document.getElementById('orderStatusFilter')?.value || '';
            const filterPayment = document.getElementById('orderPaymentFilter')?.value || '';
            const sortBy = document.getElementById('orderSortBy')?.value || 'date-desc';
            const searchTerm = document.getElementById('orderSearch')?.value.toLowerCase() || '';
            
            let filteredOrders = orders.filter(o => {
                const matchesStatus = !filterStatus || o.status === filterStatus;
                const matchesPayment = !filterPayment || o.paymentModel === filterPayment;
                const matchesSearch = !searchTerm || 
                    o.orderNumber.toLowerCase().includes(searchTerm) ||
                    o.dealName.toLowerCase().includes(searchTerm) ||
                    o.companyName.toLowerCase().includes(searchTerm) ||
                    (o.responsiblePerson && o.responsiblePerson.toLowerCase().includes(searchTerm));
                
                return matchesStatus && matchesPayment && matchesSearch;
            });
            
            // Sorting
            filteredOrders.sort((a, b) => {
                switch(sortBy) {
                    case 'date-desc':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'date-asc':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'value-desc':
                        return calculateOrderTotalRevenue(b) - calculateOrderTotalRevenue(a);
                    case 'value-asc':
                        return calculateOrderTotalRevenue(a) - calculateOrderTotalRevenue(b);
                    case 'company':
                        return a.companyName.localeCompare(b.companyName);
                    default:
                        return 0;
                }
            });
            
            // Update statistics
            const totalValue = orders.reduce((sum, o) => sum + calculateOrderTotalRevenue(o), 0);
            const activeOrders = orders.filter(o => o.status === 'In Bearbeitung');
            const activeValue = activeOrders.reduce((sum, o) => sum + calculateOrderTotalRevenue(o), 0);
            
            // Calculate MRR/ARR
            let totalMRR = 0;
            orders.filter(o => o.status !== 'Storniert').forEach(o => {
                totalMRR += calculateOrderMRR(o);
            });
            const totalARR = totalMRR * 12;
            
            document.getElementById('ordersTotal').textContent = orders.length;
            document.getElementById('ordersValue').textContent = '‚Ç¨ ' + Math.round(totalValue).toLocaleString('de-DE');
            document.getElementById('ordersActive').textContent = activeOrders.length;
            document.getElementById('ordersActiveValue').textContent = '‚Ç¨ ' + Math.round(activeValue).toLocaleString('de-DE');
            document.getElementById('ordersMRR').textContent = '‚Ç¨ ' + Math.round(totalMRR).toLocaleString('de-DE');
            document.getElementById('ordersARR').textContent = '‚Ç¨ ' + Math.round(totalARR).toLocaleString('de-DE') + '/Jahr';
            
            // Render orders table
            const container = document.getElementById('ordersList');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 60px 20px;">
                        <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg></div>
                        <div class="empty-state-text">${searchTerm || filterStatus || filterPayment ? 'Keine Auftr√§ge gefunden' : 'Keine Auftr√§ge vorhanden'}</div>
                        <div class="empty-state-subtext">${searchTerm || filterStatus || filterPayment ? 'Versuchen Sie andere Filter' : 'Auftr√§ge werden automatisch aus gewonnenen Deals erstellt'}</div>
                    </div>
                `;
                return;
            }
            
            const paymentModelLabels = {
                'one-time': 'Einmalig',
                'monthly': 'Monatlich',
                'quarterly': 'Viertelj√§hrlich',
                'yearly': 'J√§hrlich'
            };
            
            const statusColors = {
                'Neu': '#3b82f6',
                'In Bearbeitung': '#f59e0b',
                'Abgeschlossen': '#10b981',
                'Storniert': '#ef4444'
            };
            
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #e2e8f0; background: #f8fafc;">
                            <th style="padding: 16px; text-align: left; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Auftragsnr.</th>
                            <th style="padding: 16px; text-align: left; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Deal / Unternehmen</th>
                            <th style="padding: 16px; text-align: left; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Zahlungsmodell</th>
                            <th style="padding: 16px; text-align: left; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Verantwortlich</th>
                            <th style="padding: 16px; text-align: right; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Wert/Rate</th>
                            <th style="padding: 16px; text-align: right; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Gesamtumsatz</th>
                            <th style="padding: 16px; text-align: center; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Status</th>
                            <th style="padding: 16px; text-align: center; font-weight: 600; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredOrders.map(order => {
                            const totalRevenue = calculateOrderTotalRevenue(order);
                            const paymentLabel = paymentModelLabels[order.paymentModel] || order.paymentModel;
                            const statusColor = statusColors[order.status] || '#64748b';
                            
                            return `
                                <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;" 
                                    onmouseover="this.style.background='#f8fafc'" 
                                    onmouseout="this.style.background='white'">
                                    <td style="padding: 16px;">
                                        <div style="font-weight: 600; color: #1e293b;">${order.orderNumber}</div>
                                        <div style="font-size: 12px; color: #94a3b8; margin-top: 2px;">${new Date(order.createdAt).toLocaleDateString('de-DE')}</div>
                                    </td>
                                    <td style="padding: 16px;">
                                        <div style="font-weight: 500; color: #334155; margin-bottom: 2px;">${order.dealName}</div>
                                        <div style="font-size: 13px; color: #64748b;">${order.companyName}</div>
                                    </td>
                                    <td style="padding: 16px;">
                                        <div style="display: inline-block; padding: 4px 10px; background: #f0f9ff; border-radius: 6px; font-size: 12px; font-weight: 600; color: #1e40af;">
                                            ${paymentLabel}
                                        </div>
                                        ${order.contractDuration ? `<div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">${order.contractDuration} Monate</div>` : ''}
                                    </td>
                                    <td style="padding: 16px;">
                                        ${order.responsiblePerson ? 
                                            `<div style="display: flex; align-items: center; gap: 6px;">
                                                <span style="font-size: 16px;">üë§</span>
                                                <span style="font-size: 13px; color: #475569;">${order.responsiblePerson}</span>
                                            </div>` : 
                                            '<span style="color: #cbd5e1; font-size: 13px;">Nicht zugewiesen</span>'}
                                    </td>
                                    <td style="padding: 16px; text-align: right;">
                                        <div style="font-weight: 600; color: #10b981; font-size: 15px;">‚Ç¨ ${Math.round(order.value).toLocaleString('de-DE')}</div>
                                        ${order.paymentModel !== 'one-time' ? `<div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">pro ${order.paymentModel === 'monthly' ? 'Monat' : order.paymentModel === 'quarterly' ? 'Quartal' : 'Jahr'}</div>` : ''}
                                    </td>
                                    <td style="padding: 16px; text-align: right;">
                                        <div style="font-weight: 700; color: #0f172a; font-size: 16px;">‚Ç¨ ${Math.round(totalRevenue).toLocaleString('de-DE')}</div>
                                        ${totalRevenue !== order.value ? `<div style="font-size: 11px; color: #64748b; margin-top: 2px;">√ºber ${order.contractDuration || 12} Mon.</div>` : ''}
                                    </td>
                                    <td style="padding: 16px; text-align: center;">
                                        <span style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; background: ${statusColor}15; color: ${statusColor};">
                                            ${order.status}
                                        </span>
                                    </td>
                                    <td style="padding: 16px; text-align: center;">
                                        <div style="display: flex; gap: 8px; justify-content: center;">
                                            <button onclick="openEditOrderModal('${order.id}')" 
                                                    style="padding: 8px 12px; background: #f1f5f9; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #475569; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#e2e8f0'"
                                                    onmouseout="this.style.background='#f1f5f9'"
                                                    title="Bearbeiten">
                                                ‚úèÔ∏è Bearbeiten
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                
                <div style="padding: 16px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 13px; color: #64748b;">
                        Zeige ${filteredOrders.length} von ${orders.length} Auftr√§gen
                    </div>
                    <div style="font-size: 14px; font-weight: 600; color: #334155;">
                        Gesamt: ‚Ç¨ ${Math.round(filteredOrders.reduce((sum, o) => sum + calculateOrderTotalRevenue(o), 0)).toLocaleString('de-DE')}
                    </div>
                </div>
            `;
        }
        
        function showOrderDetail(orderId) {
            console.log('showOrderDetail called with ID:', orderId);
            
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                alert('Auftrag nicht gefunden!');
                return;
            }
            
            console.log('Order found:', order);
            
            const company = companies.find(c => c.id === order.companyId);
            const deal = deals.find(d => d.id === order.dealId);
            
            // Hide all views
            document.querySelectorAll('.view-content, .detail-view').forEach(v => v.classList.add('hidden'));
            
            // Get or create detail view
            let detailView = document.getElementById('order-detail-view');
            if (!detailView) {
                console.log('Creating order detail view...');
                detailView = document.createElement('div');
                detailView.id = 'order-detail-view';
                detailView.className = 'detail-view';
                document.querySelector('.main-content').appendChild(detailView);
            }
            
            console.log('Showing detail view...');
            detailView.classList.remove('hidden');
            
            detailView.innerHTML = `
                <a href="#" class="back-btn" onclick="showView('orders'); return false;">‚Üê Zur√ºck zu Auftr√§gen</a>
                
                <div class="detail-header">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <div class="detail-title">${order.orderNumber}</div>
                            <div style="font-size: 18px; color: var(--text-secondary); margin-top: 8px;">${order.dealName}</div>
                            <div style="margin-top: 8px;">
                                <span class="badge badge-${order.status === 'Neu' ? 'primary' : order.status === 'In Bearbeitung' ? 'bearbeitung' : order.status === 'Abgeschlossen' ? 'kunde' : 'verloren'}">${order.status}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button onclick="openEditOrderModal('${order.id}')" style="padding: 12px 20px; font-size: 15px; font-weight: 600; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                                ‚úèÔ∏è Bearbeiten
                            </button>
                            <button onclick="changeOrderStatus('${order.id}')" style="padding: 12px 20px; font-size: 15px; font-weight: 600; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                                Status √§ndern
                            </button>
                        </div>
                    </div>
                    
                    <div class="detail-grid" style="margin-top: 24px;">
                        <div class="detail-item">
                            <div class="detail-label">Auftragswert</div>
                            <div class="detail-value" style="font-size: 24px; font-weight: 700; color: var(--success);">‚Ç¨ ${(order.value || 0).toLocaleString('de-DE')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Unternehmen</div>
                            <div class="detail-value">
                                ${company ? `<a href="#" onclick="showCompanyDetail('${company.id}'); return false;" style="color: var(--primary);">${company.name}</a>` : order.companyName}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Hauptverantwortlicher</div>
                            <div class="detail-value">${order.responsiblePerson || '<span style="color: var(--text-secondary);">Nicht zugewiesen</span>'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Erstellt am</div>
                            <div class="detail-value">${new Date(order.createdAt).toLocaleDateString('de-DE')}</div>
                        </div>
                        ${order.completedAt ? `
                        <div class="detail-item">
                            <div class="detail-label">Abgeschlossen am</div>
                            <div class="detail-value">${new Date(order.completedAt).toLocaleDateString('de-DE')}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${order.services && order.services.length > 0 ? `
                <div class="section">
                    <h3 class="section-title">Leistungen</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${order.services.map(s => `<span class="badge badge-kontakt">${s}</span>`).join('')}
                    </div>
                </div>
                ` : `
                <div class="section">
                    <h3 class="section-title">Leistungen</h3>
                    <p style="color: var(--text-secondary);">Keine Leistungen zugeordnet</p>
                </div>
                `}
                
                ${order.notes ? `
                <div class="section">
                    <h3 class="section-title">Notizen</h3>
                    <div style="background: var(--bg-main); padding: 16px; border-radius: 8px; white-space: pre-wrap;">${order.notes}</div>
                </div>
                ` : ''}
                
                ${deal ? `
                <div class="section">
                    <h3 class="section-title">Zugeh√∂riger Deal</h3>
                    <div class="list-item" onclick="showDealDetail('${deal.id}')" style="cursor: pointer;">
                        <div class="list-item-main">
                            <div class="list-item-title">${deal.name}</div>
                            <div class="list-item-sub">${deal.stage}</div>
                        </div>
                        <div class="list-item-meta">
                            <div style="font-weight: 600;">‚Ç¨ ${(deal.value || 0).toLocaleString('de-DE')}</div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            console.log('Order detail view rendered successfully');
        }
        
        function changeOrderStatus(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Status √§ndern</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Neuer Status</label>
                        <select class="form-select" id="newOrderStatus">
                            <option value="Neu" ${order.status === 'Neu' ? 'selected' : ''}>Neu</option>
                            <option value="In Bearbeitung" ${order.status === 'In Bearbeitung' ? 'selected' : ''}>In Bearbeitung</option>
                            <option value="Abgeschlossen" ${order.status === 'Abgeschlossen' ? 'selected' : ''}>Abgeschlossen</option>
                            <option value="Storniert" ${order.status === 'Storniert' ? 'selected' : ''}>Storniert</option>
                        </select>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveOrderStatus('${orderId}'); this.closest('.modal').remove();">Speichern</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveOrderStatus(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const newStatus = document.getElementById('newOrderStatus').value;
            order.status = newStatus;
            
            if (newStatus === 'Abgeschlossen' && !order.completedAt) {
                order.completedAt = new Date().toISOString();
            }
            
            Storage.setItem('bbc_orders', JSON.stringify(orders));
            showOrderDetail(orderId);
            renderOrders();
        }
        
        function addOrderNote(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Notiz hinzuf√ºgen</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notiz</label>
                        <textarea class="form-input" id="orderNoteText" rows="5">${order.notes || ''}</textarea>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveOrderNote('${orderId}'); this.closest('.modal').remove();">Speichern</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function saveOrderNote(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            order.notes = document.getElementById('orderNoteText').value;
            Storage.setItem('bbc_orders', JSON.stringify(orders));
            showOrderDetail(orderId);
        }
        
        // Edit Order Modal
        function openEditOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            
            if (!order) {
                alert('Auftrag nicht gefunden!');
                return;
            }
            
            // Remove old modal if exists
            const oldModal = document.getElementById('editOrderModal');
            if (oldModal) oldModal.remove();
            
            // Initialize temp services
            window.tempOrderServices = order.services ? [...order.services] : [];
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'editOrderModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 99999;
            `;
            
            const servicesHtml = window.tempOrderServices.length > 0 ? 
                window.tempOrderServices.map(s => '<span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; display: inline-block; margin: 4px;">' + s + '</span>').join('') : 
                '<span style="color: #94a3b8;">Keine Leistungen ausgew√§hlt</span>';
            
            // Build responsible person dropdown
            let responsibleOptions = '<option value="">Nicht zugewiesen</option>';
            employees.forEach(emp => {
                const selected = order.responsiblePerson === emp.name ? 'selected' : '';
                responsibleOptions += `<option value="${emp.name}" ${selected}>${emp.name}</option>`;
            });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 700px; max-height: 90vh; overflow-y: auto; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 700;">üìù Auftrag bearbeiten</h2>
                        <button onclick="document.getElementById('editOrderModal').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Auftragsnummer</label>
                        <input type="text" value="${order.orderNumber}" readonly style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'DM Sans', sans-serif; background: #f1f5f9; cursor: not-allowed; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Auftragsname</label>
                        <input type="text" id="editOrderName" value="${order.dealName || ''}" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'DM Sans', sans-serif; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Auftragswert (‚Ç¨)</label>
                        <input type="number" id="editOrderValue" value="${order.value || 0}" step="0.01" onchange="updateOrderValuePreview()" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'IBM Plex Sans', sans-serif; box-sizing: border-box;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Zahlungsmodell</label>
                        <select id="editOrderPaymentModel" onchange="toggleOrderPaymentFields()" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'IBM Plex Sans', sans-serif; box-sizing: border-box;">
                            <option value="one-time" ${(order.paymentModel || 'one-time') === 'one-time' ? 'selected' : ''}>Einmalzahlung</option>
                            <option value="monthly" ${order.paymentModel === 'monthly' ? 'selected' : ''}>Monatlich (Abo/Vertrag)</option>
                            <option value="quarterly" ${order.paymentModel === 'quarterly' ? 'selected' : ''}>Viertelj√§hrlich</option>
                            <option value="yearly" ${order.paymentModel === 'yearly' ? 'selected' : ''}>J√§hrlich</option>
                        </select>
                    </div>
                    
                    <div id="editOrderRecurringFields" style="margin-bottom: 20px; ${(order.paymentModel && order.paymentModel !== 'one-time') ? '' : 'display: none;'}">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Vertragslaufzeit (Monate)</label>
                        <input type="number" id="editOrderContractDuration" value="${order.contractDuration || 12}" min="1" onchange="updateOrderValuePreview()" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'IBM Plex Sans', sans-serif; box-sizing: border-box;">
                        <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-left: 4px solid #1e40af; border-radius: 4px;">
                            <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 4px;">Umsatz√ºbersicht</div>
                            <div id="editOrderValuePreview" style="font-size: 13px; color: #64748b;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                            Startdatum (Erste Zahlung)
                            <span style="font-weight: 400; color: #64748b; font-size: 12px; margin-left: 8px;">Bestimmt wann die erste Zahlung erfolgt</span>
                        </label>
                        <input type="date" id="editOrderStartDate" value="${order.startDate || new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'IBM Plex Sans', sans-serif; box-sizing: border-box;">
                        <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
                            üí° Bei Einmalzahlung: Wann der Betrag eingeht<br>
                            üí° Bei wiederkehrend: Wann die erste Rate f√§llig wird
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Leistungen</label>
                        <div id="editOrderServicesPreview" style="min-height: 50px; padding: 12px; background: #f1f5f9; border-radius: 8px; margin-bottom: 12px;">
                            ${servicesHtml}
                        </div>
                        <button type="button" onclick="openOrderServicesSelector('${orderId}')" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'DM Sans', sans-serif;">
                            Leistungen ausw√§hlen
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Hauptverantwortlicher (BBC Mitarbeiter)</label>
                        <select id="editOrderResponsible" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'DM Sans', sans-serif; box-sizing: border-box;">
                            ${responsibleOptions}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Status</label>
                        <select id="editOrderStatus" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'DM Sans', sans-serif; box-sizing: border-box;">
                            <option value="Neu" ${order.status === 'Neu' ? 'selected' : ''}>Neu</option>
                            <option value="In Bearbeitung" ${order.status === 'In Bearbeitung' ? 'selected' : ''}>In Bearbeitung</option>
                            <option value="Abgeschlossen" ${order.status === 'Abgeschlossen' ? 'selected' : ''}>Abgeschlossen</option>
                            <option value="Storniert" ${order.status === 'Storniert' ? 'selected' : ''}>Storniert</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Notizen</label>
                        <div style="position: relative;">
                            <textarea id="editOrderNotes" rows="4" style="width: 100%; padding: 12px; padding-right: 60px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'IBM Plex Sans', sans-serif; resize: vertical; box-sizing: border-box;">${order.notes || ''}</textarea>
                            <button type="button"
                                    data-voice-target="editOrderNotes"
                                    onclick="toggleVoiceInput('editOrderNotes', true)"
                                    style="position: absolute; right: 10px; top: 10px; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;"
                                    title="Spracherkennung starten/stoppen">
                                üé§
                            </button>
                        </div>
                        <small style="color: #64748b; font-size: 12px; display: block; margin-top: 6px;">
                            üí° Klicken Sie auf üé§ um per Sprache einzugeben
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="saveEditedOrder('${orderId}')" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                            üíæ Speichern
                        </button>
                        <button onclick="document.getElementById('editOrderModal').remove()" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 600; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif;">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Services Selector for Order
        function openOrderServicesSelector(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Store current services temporarily
            window.tempOrderServices = order.services ? [...order.services] : [];
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'orderServicesModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Leistungen ausw√§hlen</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 12px;">Ausgew√§hlte Leistungen:</h4>
                        <div id="orderServicesPreview" style="min-height: 40px; padding: 12px; background: var(--bg-main); border-radius: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                            ${window.tempOrderServices.length > 0 ? 
                                window.tempOrderServices.map(s => `<span class="badge badge-kontakt">${s}</span>`).join('') : 
                                '<span style="color: var(--text-secondary);">Keine Leistungen ausgew√§hlt</span>'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 12px;">Verf√ºgbare Leistungen:</h4>
                        
                        <div style="margin-bottom: 16px;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">Marketing</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                ${renderServiceCheckbox('SEO')}
                                ${renderServiceCheckbox('SEO Blog')}
                                ${renderServiceCheckbox('SEA')}
                                ${renderServiceCheckbox('Social Media')}
                                ${renderServiceCheckbox('Rundum Marketing')}
                                ${renderServiceCheckbox('Website')}
                                ${renderServiceCheckbox('Webshop')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">Unternehmensberatung</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                ${renderServiceCheckbox('Vertriebsoptimierung')}
                                ${renderServiceCheckbox('Vertriebsberatung')}
                                ${renderServiceCheckbox('CRM Beratung')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">Sonstiges</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                ${renderServiceCheckbox('Leadinfo')}
                            </div>
                        </div>
                        
                        ${customServices.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">Eigene Leistungen</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                ${customServices.map(s => renderServiceCheckbox(s)).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="applyOrderServices('${orderId}'); this.closest('.modal').remove();" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'DM Sans', sans-serif;">
                            √úbernehmen
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 12px; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'DM Sans', sans-serif;">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function renderServiceCheckbox(service) {
            const isChecked = window.tempOrderServices && window.tempOrderServices.includes(service);
            return `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleOrderService('${service}')" style="cursor: pointer;">
                    <span style="font-size: 14px;">${service}</span>
                </label>
            `;
        }
        
        function toggleOrderService(service) {
            if (!window.tempOrderServices) window.tempOrderServices = [];
            
            const index = window.tempOrderServices.indexOf(service);
            if (index > -1) {
                window.tempOrderServices.splice(index, 1);
            } else {
                window.tempOrderServices.push(service);
            }
            
            updateOrderServicesPreview();
        }
        
        function updateOrderServicesPreview() {
            const preview = document.getElementById('orderServicesPreview');
            if (preview) {
                preview.innerHTML = window.tempOrderServices.length > 0 ? 
                    window.tempOrderServices.map(s => `<span class="badge badge-kontakt">${s}</span>`).join('') : 
                    '<span style="color: var(--text-secondary);">Keine Leistungen ausgew√§hlt</span>';
            }
        }
        
        function applyOrderServices(orderId) {
            // Update preview in edit modal
            const editPreview = document.getElementById('editOrderServicesPreview');
            if (editPreview) {
                editPreview.innerHTML = window.tempOrderServices.length > 0 ? 
                    window.tempOrderServices.map(s => `<span class="badge badge-kontakt">${s}</span>`).join('') : 
                    '<span style="color: var(--text-secondary); font-size: 14px;">Keine Leistungen ausgew√§hlt</span>';
            }
        }
        
        function saveEditedOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Get values
            const newName = document.getElementById('editOrderName').value.trim();
            const newValue = parseFloat(document.getElementById('editOrderValue').value);
            const newPaymentModel = document.getElementById('editOrderPaymentModel').value;
            const newContractDuration = parseInt(document.getElementById('editOrderContractDuration').value) || 12;
            const newStartDate = document.getElementById('editOrderStartDate').value;
            const newStatus = document.getElementById('editOrderStatus').value;
            const newNotes = document.getElementById('editOrderNotes').value.trim();
            const responsiblePerson = document.getElementById('editOrderResponsible').value;
            
            // Check if status changed to "Storniert"
            const oldStatus = order.status;
            const wasCancelled = (oldStatus !== 'Storniert' && newStatus === 'Storniert');
            
            // Validate
            if (!newName) {
                alert('Bitte geben Sie einen Auftragsnamen ein.');
                return;
            }
            
            if (isNaN(newValue) || newValue < 0) {
                alert('Bitte geben Sie einen g√ºltigen Auftragswert ein.');
                return;
            }
            
            // Update order
            order.dealName = newName;
            order.value = newValue;
            order.paymentModel = newPaymentModel;
            order.contractDuration = newPaymentModel !== 'one-time' ? newContractDuration : null;
            order.startDate = newStartDate || new Date().toISOString().split('T')[0];
            order.status = newStatus;
            order.notes = newNotes;
            order.responsiblePerson = responsiblePerson;
            order.services = window.tempOrderServices || order.services || [];
            
            // Set completed date if status is "Abgeschlossen"
            if (newStatus === 'Abgeschlossen' && !order.completedAt) {
                order.completedAt = new Date().toISOString();
            } else if (newStatus !== 'Abgeschlossen') {
                order.completedAt = null;
            }
            
            // Save
            Storage.setItem('bbc_orders', JSON.stringify(orders));
            
            // Sync back to deal if exists
            if (order.dealId) {
                const linkedDeal = deals.find(d => d.id === order.dealId);
                if (linkedDeal) {
                    linkedDeal.name = newName;
                    linkedDeal.value = newValue;
                    linkedDeal.paymentModel = newPaymentModel;
                    linkedDeal.contractDuration = newPaymentModel !== 'one-time' ? newContractDuration : null;
                    Storage.setItem('bbc_deals', JSON.stringify(deals));
                }
            }
            
            // Close modal
            const modal = document.getElementById('editOrderModal');
            if (modal) modal.remove();
            
            // Show notification
            if (wasCancelled) {
                showNotification(
                    'Auftrag storniert', 
                    `Auftrag "${order.orderNumber}" wurde storniert. Der Wert von ‚Ç¨ ${newValue.toLocaleString('de-DE')} wird vom Jahresumsatz abgezogen.`
                );
            } else {
                showNotification('Auftrag aktualisiert', `Die √Ñnderungen am Auftrag "${order.orderNumber}" wurden gespeichert.`);
            }
            
            // Refresh view and dashboard
            renderOrders();
            updateKPICards();
            updateGoalsProgress();
            updateRevenueOverview();
            
            // Update Analytics if currently open
            if (!document.getElementById('analytics-view').classList.contains('hidden')) {
                updateAnalytics();
            }
        }
        
        // ==========================================
        // DASHBOARD FUNKTIONEN
        // ==========================================
        let dashboardGoals = JSON.parse(Storage.getItem('bbc_dashboard_goals') || JSON.stringify({
            revenue: 500000,
            contacts: 100,
            deals: 50
        }));

        // ==========================================
        // ACTIVITY TRACKING
        // ==========================================
        
        function updateContactActivity(contactId, activityType) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            contact.lastActivity = new Date().toISOString();
            contact.lastActivityType = activityType;
            
            Storage.setItem('bbc_contacts', JSON.stringify(contacts));
        }
        
        function updateCompanyActivity(companyId, activityType) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            company.lastActivity = new Date().toISOString();
            company.lastActivityType = activityType;
            
            Storage.setItem('bbc_companies', JSON.stringify(companies));
        }
        
        function getLastActivity(entity, entityType) {
            let lastActivity = entity.lastActivity || entity.createdAt;
            
            // Check for protocol entries
            if (entity.protocol && entity.protocol.length > 0) {
                const lastProtocol = entity.protocol[0].date;
                if (new Date(lastProtocol) > new Date(lastActivity)) {
                    lastActivity = lastProtocol;
                }
            }
            
            // Check for deals
            if (entityType === 'company') {
                const companyDeals = deals.filter(d => d.companyId === entity.id);
                if (companyDeals.length > 0) {
                    const lastDeal = companyDeals.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                    if (new Date(lastDeal.createdAt) > new Date(lastActivity)) {
                        lastActivity = lastDeal.createdAt;
                    }
                }
            }
            
            // Check for contact deals
            if (entityType === 'contact') {
                const company = companies.find(c => c.id === entity.companyId);
                if (company) {
                    const companyDeals = deals.filter(d => d.companyId === company.id);
                    if (companyDeals.length > 0) {
                        const lastDeal = companyDeals.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                        if (new Date(lastDeal.createdAt) > new Date(lastActivity)) {
                            lastActivity = lastDeal.createdAt;
                        }
                    }
                }
            }
            
            // Check for tasks
            const entityTasks = entityType === 'company' 
                ? tasks.filter(t => t.companyId === entity.id)
                : tasks.filter(t => t.contactId === entity.id);
            
            if (entityTasks.length > 0) {
                const lastTask = entityTasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                if (new Date(lastTask.createdAt) > new Date(lastActivity)) {
                    lastActivity = lastTask.createdAt;
                }
            }
            
            return lastActivity;
        }
        
        function updateInactiveCustomers() {
            const container = document.getElementById('inactiveCustomersContainer');
            if (!container) return;
            
            const thresholdDays = parseInt(document.getElementById('inactivityThreshold').value) || 30;
            const sortBy = document.getElementById('inactivitySort').value;
            const filterType = document.getElementById('inactivityType').value;
            
            const now = new Date();
            const thresholdDate = new Date(now - thresholdDays * 24 * 60 * 60 * 1000);
            
            let inactiveEntities = [];
            
            // Check contacts
            if (filterType === 'all' || filterType === 'contacts') {
                contacts.forEach(contact => {
                    const lastActivity = getLastActivity(contact, 'contact');
                    const lastActivityDate = new Date(lastActivity);
                    
                    if (lastActivityDate < thresholdDate) {
                        const daysSinceActivity = Math.floor((now - lastActivityDate) / (1000 * 60 * 60 * 24));
                        const company = companies.find(c => c.id === contact.companyId);
                        const contactDeals = company ? deals.filter(d => d.companyId === company.id) : [];
                        const totalValue = contactDeals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
                        
                        inactiveEntities.push({
                            type: 'contact',
                            id: contact.id,
                            name: contact.name,
                            companyName: company ? company.name : 'Kein Unternehmen',
                            email: contact.email,
                            phone: contact.phone,
                            lastActivity: lastActivity,
                            lastActivityDate: lastActivityDate,
                            daysSinceActivity: daysSinceActivity,
                            totalValue: totalValue,
                            hasDeals: contactDeals.length > 0
                        });
                    }
                });
            }
            
            // Check companies
            if (filterType === 'all' || filterType === 'companies') {
                companies.forEach(company => {
                    const lastActivity = getLastActivity(company, 'company');
                    const lastActivityDate = new Date(lastActivity);
                    
                    if (lastActivityDate < thresholdDate) {
                        const daysSinceActivity = Math.floor((now - lastActivityDate) / (1000 * 60 * 60 * 24));
                        const companyDeals = deals.filter(d => d.companyId === company.id);
                        const totalValue = companyDeals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
                        const companyContacts = contacts.filter(c => c.companyId === company.id);
                        
                        inactiveEntities.push({
                            type: 'company',
                            id: company.id,
                            name: company.name,
                            contactCount: companyContacts.length,
                            email: company.email,
                            phone: company.phone,
                            lastActivity: lastActivity,
                            lastActivityDate: lastActivityDate,
                            daysSinceActivity: daysSinceActivity,
                            totalValue: totalValue,
                            hasDeals: companyDeals.length > 0
                        });
                    }
                });
            }
            
            // Sort
            switch(sortBy) {
                case 'oldest':
                    inactiveEntities.sort((a, b) => a.lastActivityDate - b.lastActivityDate);
                    break;
                case 'newest':
                    inactiveEntities.sort((a, b) => b.lastActivityDate - a.lastActivityDate);
                    break;
                case 'value':
                    inactiveEntities.sort((a, b) => b.totalValue - a.totalValue);
                    break;
            }
            
            // Update summary
            document.getElementById('inactiveSummaryCount').textContent = inactiveEntities.length;
            const avgDays = inactiveEntities.length > 0 
                ? Math.round(inactiveEntities.reduce((sum, e) => sum + e.daysSinceActivity, 0) / inactiveEntities.length)
                : 0;
            document.getElementById('inactiveSummaryAvgDays').textContent = avgDays;
            const totalRisk = inactiveEntities.reduce((sum, e) => sum + e.totalValue, 0);
            document.getElementById('inactiveSummaryRisk').textContent = '‚Ç¨ ' + Math.round(totalRisk).toLocaleString('de-DE');
            
            // Render list
            if (inactiveEntities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 80px 20px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">Alle Kunden sind aktiv!</div>
                        <div style="color: var(--text-secondary);">Es gibt keine inaktiven Kunden f√ºr den gew√§hlten Zeitraum.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = inactiveEntities.map(entity => {
                const statusColor = entity.daysSinceActivity > 90 ? '#ef4444' : entity.daysSinceActivity > 60 ? '#f59e0b' : '#64748b';
                const urgencyLabel = entity.daysSinceActivity > 90 ? 'Kritisch' : entity.daysSinceActivity > 60 ? 'Dringend' : 'Achtung';
                
                return `
                    <div class="card" style="margin-bottom: 16px; cursor: pointer; transition: all 0.2s;" onclick="${entity.type === 'contact' ? `showContactDetail('${entity.id}')` : `showCompanyDetail('${entity.id}')`}">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 24px;">${entity.type === 'contact' ? 'üë§' : 'üè¢'}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">${entity.name}</div>
                                        ${entity.type === 'contact' ? `<div style="color: var(--text-secondary); font-size: 13px;">${entity.companyName}</div>` : `<div style="color: var(--text-secondary); font-size: 13px;">${entity.contactCount} Kontakt${entity.contactCount !== 1 ? 'e' : ''}</div>`}
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 24px; margin-top: 12px; font-size: 13px;">
                                    ${entity.email ? `
                                        <div style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary);">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                            </svg>
                                            ${entity.email}
                                        </div>
                                    ` : ''}
                                    ${entity.phone ? `
                                        <div style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary);">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                            </svg>
                                            ${entity.phone}
                                        </div>
                                    ` : ''}
                                    ${entity.hasDeals ? `
                                        <div style="display: flex; align-items: center; gap: 6px; color: #10b981;">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            ‚Ç¨ ${Math.round(entity.totalValue).toLocaleString('de-DE')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div style="text-align: right;">
                                <div style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 11px; margin-bottom: 8px; white-space: nowrap;">
                                    ${urgencyLabel}
                                </div>
                                <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 4px;">
                                    Letzte Aktivit√§t:
                                </div>
                                <div style="font-weight: 700; font-size: 16px; color: ${statusColor};">
                                    vor ${entity.daysSinceActivity} Tagen
                                </div>
                                <div style="color: var(--text-secondary); font-size: 11px; margin-top: 4px;">
                                    ${new Date(entity.lastActivity).toLocaleDateString('de-DE')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDashboard() {
            updateKPICards();
            updateGoalsProgress();
            updateRevenueOverview();
            renderPipelineChart();
            renderDashboardTasks();
            renderDashboardReminders();
            renderActivityFeed();
        }

        function updateKPICards() {
            // Berechne Jahresumsatz aus aktiven Auftr√§gen (nicht storniert)
            const activeOrders = orders.filter(o => o.status !== 'Storniert');
            let yearRevenue = activeOrders.reduce((sum, o) => sum + calculateOrderTotalRevenue(o), 0);
            
            const revenueProgress = dashboardGoals.revenue > 0 ? ((yearRevenue / dashboardGoals.revenue) * 100).toFixed(0) : 0;
            
            if (document.getElementById('kpiYearRevenue')) {
                document.getElementById('kpiYearRevenue').textContent = '‚Ç¨ ' + Math.round(yearRevenue).toLocaleString('de-DE');
                document.getElementById('kpiYearProgress').textContent = revenueProgress + '% vom Ziel';
            }
            
            // Gewonnene Deals KPI (nur best√§tigte)
            const wonDeals = deals.filter(d => d.stage === 'Abgeschlossen gewonnen' && d.wonConfirmed);
            if (document.getElementById('kpiWonDeals')) {
                document.getElementById('kpiWonDeals').textContent = wonDeals.length;
                document.getElementById('kpiWonDealsValue').textContent = '‚Ç¨ ' + Math.round(yearRevenue).toLocaleString('de-DE');
            }
            
            // Verlorene Deals (nur best√§tigte)
            const lostDeals = deals.filter(d => d.stage === 'Abgeschlossen verloren' && d.lostConfirmed);
            const lostDealsValue = lostDeals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
            
            if (document.getElementById('kpiLostDeals')) {
                document.getElementById('kpiLostDeals').textContent = lostDeals.length;
                document.getElementById('kpiLostDealsValue').textContent = '‚Ç¨ ' + Math.round(lostDealsValue).toLocaleString('de-DE');
            }
            
            // Aktive Deals in Pipeline (ohne gewonnen/verloren)
            const activeDeals = deals.filter(d => d.stage !== 'Abgeschlossen gewonnen' && d.stage !== 'Abgeschlossen verloren');
            const pipelineValue = activeDeals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
            
            if (document.getElementById('kpiDealsCount')) {
                document.getElementById('kpiDealsCount').textContent = activeDeals.length;
                document.getElementById('kpiDealsValue').textContent = '‚Ç¨ ' + Math.round(pipelineValue).toLocaleString('de-DE');
            }
            
            // Kontakte
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const newContacts = contacts.filter(c => new Date(c.createdAt) >= oneWeekAgo).length;
            
            if (document.getElementById('kpiContactsCount')) {
                document.getElementById('kpiContactsCount').textContent = contacts.length;
                document.getElementById('kpiNewContacts').textContent = '+' + newContacts + ' diese Woche';
            }
            
            // Aufgaben
            const openTasks = tasks.filter(t => t.status === 'offen');
            const overdueTasks = openTasks.filter(t => t.overdue).length;
            
            if (document.getElementById('kpiTasksCount')) {
                document.getElementById('kpiTasksCount').textContent = openTasks.length;
                document.getElementById('kpiOverdueTasks').textContent = overdueTasks + ' √ºberf√§llig';
            }
        }

        function updateGoalsProgress() {
            // Berechne Jahresumsatz aus aktiven Auftr√§gen (nicht storniert)
            const activeOrders = orders.filter(o => o.status !== 'Storniert');
            let yearRevenue = activeOrders.reduce((sum, o) => sum + calculateOrderTotalRevenue(o), 0);
            
            console.log('Jahresumsatz aus Auftr√§gen:', yearRevenue);
            console.log('Aktive Auftr√§ge:', activeOrders.length);
            
            const revenueProgress = dashboardGoals.revenue > 0 ? ((yearRevenue / dashboardGoals.revenue) * 100) : 0;
            
            if (document.getElementById('goalRevenueText')) {
                document.getElementById('goalRevenueText').textContent = '‚Ç¨ ' + dashboardGoals.revenue.toLocaleString('de-DE');
                document.getElementById('goalRevenueProgress').style.width = Math.min(revenueProgress, 100) + '%';
                document.getElementById('goalRevenueStatus').textContent = revenueProgress.toFixed(0) + '% erreicht (‚Ç¨ ' + Math.round(yearRevenue).toLocaleString('de-DE') + ')';
            }
            
            const contactsProgress = dashboardGoals.contacts > 0 ? ((contacts.length / dashboardGoals.contacts) * 100) : 0;
            
            if (document.getElementById('goalContactsText')) {
                document.getElementById('goalContactsText').textContent = dashboardGoals.contacts;
                document.getElementById('goalContactsProgress').style.width = Math.min(contactsProgress, 100) + '%';
                document.getElementById('goalContactsStatus').textContent = contactsProgress.toFixed(0) + '% erreicht (' + contacts.length + ' Kontakte)';
            }
            
            // Gewonnene Deals f√ºr Ziel-Tracking
            const wonDeals = deals.filter(d => d.stage === 'Abgeschlossen gewonnen' && d.wonConfirmed);
            const closedDeals = wonDeals.length;
            const dealsProgress = dashboardGoals.deals > 0 ? ((closedDeals / dashboardGoals.deals) * 100) : 0;
            
            if (document.getElementById('goalDealsText')) {
                document.getElementById('goalDealsText').textContent = dashboardGoals.deals;
                document.getElementById('goalDealsProgress').style.width = Math.min(dealsProgress, 100) + '%';
                document.getElementById('goalDealsStatus').textContent = dealsProgress.toFixed(0) + '% erreicht (' + closedDeals + ' Deals)';
            }
        }

        function updateRevenueOverview() {
            // Berechne Ist-Umsatz aus aktiven Auftr√§gen (nicht storniert)
            const activeOrders = orders.filter(o => o.status !== 'Storniert');
            let actual = activeOrders.reduce((sum, o) => sum + calculateOrderTotalRevenue(o), 0);
            
            console.log('Ist-Umsatz aus Auftr√§gen:', actual);
            console.log('Aktive Auftr√§ge:', activeOrders.length);
            
            const target = dashboardGoals.revenue;
            const percentage = target > 0 ? ((actual / target) * 100) : 0;
            const remaining = Math.max(0, target - actual);
            const monthly = remaining / 12;
            
            if (document.getElementById('revenueActual')) {
                document.getElementById('revenueActual').textContent = '‚Ç¨ ' + Math.round(actual).toLocaleString('de-DE');
                document.getElementById('revenueTarget').textContent = '‚Ç¨ ' + target.toLocaleString('de-DE');
                document.getElementById('revenueProgress').style.width = Math.min(percentage, 100) + '%';
                document.getElementById('revenuePercentage').textContent = percentage.toFixed(1) + '%';
                document.getElementById('revenueRemaining').textContent = '‚Ç¨ ' + Math.round(remaining).toLocaleString('de-DE');
                document.getElementById('revenueMonthly').textContent = '‚Ç¨ ' + Math.round(monthly).toLocaleString('de-DE');
            }
        }

        function renderPipelineChart() {
            const container = document.getElementById('pipelineChart');
            if (!container) return;
            
            const stageStats = pipelineStages.map(stage => {
                const stageDeals = deals.filter(d => d.stage === stage);
                const value = stageDeals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
                return { stage, count: stageDeals.length, value };
            });
            
            const maxValue = Math.max(...stageStats.map(s => s.value), 1);
            
            container.innerHTML = stageStats.map(stat => `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600; font-size: 14px;">${stat.stage}</span>
                        <span style="color: var(--text-secondary); font-size: 14px;">${stat.count} ‚Ä¢ ‚Ç¨ ${stat.value.toLocaleString('de-DE')}</span>
                    </div>
                    <div style="height: 32px; background: var(--bg-main); border-radius: 8px; overflow: hidden; position: relative;">
                        <div style="position: absolute; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: ${(stat.value / maxValue * 100)}%; border-radius: 8px;"></div>
                        <div style="position: relative; height: 100%; display: flex; align-items: center; padding: 0 12px; color: ${stat.value > maxValue * 0.3 ? 'white' : 'var(--text-primary)'}; font-weight: 600; font-size: 13px;">
                            ${stat.value > 0 ? '‚Ç¨ ' + stat.value.toLocaleString('de-DE', {maximumFractionDigits: 0}) : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderDashboardTasks() {
            const container = document.getElementById('dashboardTasks');
            if (!container) return;
            
            checkOverdueTasks();
            const openTasks = tasks.filter(t => t.status === 'offen');
            const sortedTasks = sortTasksByPriority(openTasks).slice(0, 5);
            
            if (sortedTasks.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">Keine offenen Aufgaben</p>';
                return;
            }
            
            container.innerHTML = sortedTasks.map(task => {
                const contact = contacts.find(c => c.id === task.contactId);
                return `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;" onclick="showView('tasks')" onmouseover="this.style.background='var(--bg-main)'" onmouseout="this.style.background='white'">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: ${task.overdue ? '#fee2e2' : '#dbeafe'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                ${task.overdue ? 
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>' : 
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                                }
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${task.title}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    ${task.dueDate ? '' + new Date(task.dueDate).toLocaleDateString('de-DE') : 'Kein Datum'}
                                    ${contact ? ' ‚Ä¢ ' + contact.name : ''}
                                    ${task.overdue ? ' ‚Ä¢ <span style="color: #C62828; font-weight: 600;">√úBERF√ÑLLIG</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderDashboardReminders() {
            const container = document.getElementById('dashboardReminders');
            if (!container) return;
            
            const activeReminders = reminders
                .filter(r => !r.triggered)
                .sort((a, b) => new Date(a.reminderDate) - new Date(b.reminderDate))
                .slice(0, 5);
            
            if (activeReminders.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">Keine anstehenden Wiedervorlagen</p>';
                return;
            }
            
            container.innerHTML = activeReminders.map(reminder => {
                const reminderDate = new Date(reminder.reminderDate);
                const now = new Date();
                const diffDays = Math.ceil((reminderDate - now) / (1000 * 60 * 60 * 24));
                const isToday = diffDays === 0;
                const isTomorrow = diffDays === 1;
                
                let dateText = '';
                if (isToday) {
                    dateText = 'Heute um ' + reminderDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                } else if (isTomorrow) {
                    dateText = 'Morgen um ' + reminderDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                } else if (diffDays > 0) {
                    dateText = 'In ' + diffDays + ' Tagen';
                } else {
                    dateText = '√úberf√§llig!';
                }
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-main)'" onmouseout="this.style.background='white'">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: ${isToday ? '#fef3c7' : '#e0e7ff'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${isToday ? '#92400e' : '#1e40af'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${reminder.text}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    ${dateText} ‚Ä¢ ${reminder.entityName}
                                </div>
                            </div>
                            <button onclick="deleteReminder('${reminder.id}'); renderDashboardReminders();" style="background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px;" title="L√∂schen">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActivityFeed() {
            const container = document.getElementById('activityFeed');
            if (!container) return;
            
            // Icon Mapper f√ºr SVG-Icons
            const getIconSvg = (iconName, color) => {
                const iconColor = color === '#d1fae5' ? '#059669' : 
                                 color === '#fee2e2' ? '#dc2626' : 
                                 color === '#fef3c7' ? '#f59e0b' : 
                                 color === '#dbeafe' ? '#1e40af' : '#64748b';
                
                const icons = {
                    'user': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
                    'briefcase': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`,
                    'check-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
                    'x-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`
                };
                
                return icons[iconName] || icons['user'];
            };
            
            const activities = [];
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            // Neue Kontakte
            contacts.filter(c => new Date(c.createdAt) >= oneWeekAgo).forEach(contact => {
                activities.push({
                    icon: 'user',
                    color: '#dbeafe',
                    title: 'Neuer Kontakt',
                    description: contact.name,
                    date: new Date(contact.createdAt)
                });
            });
            
            // Neue Deals
            deals.filter(d => new Date(d.createdAt) >= oneWeekAgo).forEach(deal => {
                const company = companies.find(c => c.id === deal.companyId);
                activities.push({
                    icon: 'briefcase',
                    color: '#fef3c7',
                    title: 'Neuer Deal',
                    description: deal.name + (company ? ' ‚Ä¢ ' + company.name : ''),
                    date: new Date(deal.createdAt)
                });
            });
            
            // Gewonnene Deals
            deals.filter(d => d.stage === 'Abgeschlossen gewonnen' && new Date(d.createdAt) >= oneWeekAgo).forEach(deal => {
                activities.push({
                    icon: 'check-circle',
                    color: '#d1fae5',
                    title: 'Deal gewonnen',
                    description: deal.name + ' ‚Ä¢ ‚Ç¨ ' + (deal.value || 0).toLocaleString('de-DE'),
                    date: new Date(deal.createdAt)
                });
            });
            
            // Verlorene Deals
            deals.filter(d => d.stage === 'Abgeschlossen verloren' && new Date(d.createdAt) >= oneWeekAgo).forEach(deal => {
                activities.push({
                    icon: 'x-circle',
                    color: '#fee2e2',
                    title: 'Deal verloren',
                    description: deal.name + ' ‚Ä¢ ‚Ç¨ ' + (deal.value || 0).toLocaleString('de-DE'),
                    date: new Date(deal.createdAt)
                });
            });
            
            activities.sort((a, b) => b.date - a.date);
            
            if (activities.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">Keine Aktivit√§ten in den letzten 7 Tagen</p>';
                return;
            }
            
            container.innerHTML = activities.slice(0, 8).map(activity => {
                const now = new Date();
                const diff = now - activity.date;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const timeAgo = days === 0 ? 'Heute' : days === 1 ? 'Gestern' : `Vor ${days} Tagen`;
                
                return `
                    <div style="display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border);">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${activity.color}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            ${getIconSvg(activity.icon, activity.color)}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${activity.title}</div>
                            <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 4px;">${activity.description}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // ANALYTICS & REPORTING
        // ==========================================
        
        // ==========================================
        // HELPER FUNCTIONS FOR REVENUE CALCULATION
        // ==========================================
        
        function calculateOrderTotalRevenue(order) {
            const value = parseFloat(order.value) || 0;
            const paymentModel = order.paymentModel || 'one-time';
            const duration = parseInt(order.contractDuration) || 12;
            
            if (paymentModel === 'one-time') {
                return value;
            }
            
            // Berechne Anzahl der Zahlungen basierend auf Modell
            let periodsPerYear;
            switch(paymentModel) {
                case 'monthly':
                    periodsPerYear = 12;
                    break;
                case 'quarterly':
                    periodsPerYear = 4;
                    break;
                case 'yearly':
                    periodsPerYear = 1;
                    break;
                default:
                    return value;
            }
            
            const totalPeriods = Math.ceil((duration / 12) * periodsPerYear);
            return value * totalPeriods;
        }
        
        function calculateOrderMRR(order) {
            const value = parseFloat(order.value) || 0;
            const paymentModel = order.paymentModel || 'one-time';
            
            if (paymentModel === 'one-time') {
                return 0; // Einmalzahlungen z√§hlen nicht zu MRR
            }
            
            switch(paymentModel) {
                case 'monthly':
                    return value;
                case 'quarterly':
                    return value / 3;
                case 'yearly':
                    return value / 12;
                default:
                    return 0;
            }
        }
        
        // ==========================================
        // ANALYTICS & REPORTING
        // ==========================================
        
        function updateAnalytics() {
            const timeframe = document.getElementById('analyticsTimeframe')?.value || 'year';
            const filteredData = getFilteredData(timeframe);
            
            updateAnalyticsKPIs(filteredData);
            renderRevenueTimeline(filteredData, timeframe);
            renderTopPerformers(filteredData);
            renderSalesFunnel(filteredData);
            renderLossReasons(filteredData);
            renderForecast();
        }
        
        function getFilteredData(timeframe) {
            const now = new Date();
            let startDate;
            
            switch(timeframe) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(2020, 0, 1); // All time
            }
            
            return {
                deals: deals.filter(d => new Date(d.createdAt) >= startDate),
                contacts: contacts.filter(c => new Date(c.createdAt) >= startDate),
                orders: orders.filter(o => new Date(o.createdAt) >= startDate)
            };
        }
        
        function updateAnalyticsKPIs(data) {
            // MRR/ARR Berechnung aus aktiven Auftr√§gen
            let totalMRR = 0;
            const activeOrders = data.orders.filter(o => o.status !== 'Storniert');
            
            activeOrders.forEach(order => {
                totalMRR += calculateOrderMRR(order);
            });
            
            const totalARR = totalMRR * 12;
            
            const mrrEl = document.getElementById('analyticsMRR');
            if (mrrEl) mrrEl.textContent = '‚Ç¨ ' + Math.round(totalMRR).toLocaleString('de-DE');
            
            const arrEl = document.getElementById('analyticsARR');
            if (arrEl) arrEl.textContent = '‚Ç¨ ' + Math.round(totalARR).toLocaleString('de-DE');
            
            // Conversion Rate: Lead ‚Üí Deal ‚Üí Won
            const totalDeals = data.deals.length;
            const wonDeals = data.deals.filter(d => d.wonConfirmed).length;
            const conversionRate = totalDeals > 0 ? ((wonDeals / totalDeals) * 100).toFixed(1) : 0;
            
            const el = document.getElementById('analyticsConversionRate');
            if (el) el.textContent = conversionRate + '%';
            
            const changeEl = document.getElementById('analyticsConversionChange');
            if (changeEl) {
                const trend = conversionRate > 50 ? '‚Üë Sehr gut' : conversionRate > 30 ? '‚Üí Gut' : '‚Üì Verbesserungsbedarf';
                changeEl.textContent = trend;
                changeEl.style.color = conversionRate > 50 ? '#059669' : conversionRate > 30 ? '#f59e0b' : '#dc2626';
            }
            
            // Deal Velocity: Durchschnittliche Zeit bis Abschluss
            const closedDeals = data.deals.filter(d => d.wonConfirmed || d.lostConfirmed);
            let totalDays = 0;
            let count = 0;
            
            closedDeals.forEach(deal => {
                const created = new Date(deal.createdAt);
                const closed = deal.wonConfirmed ? (deal.wonDate ? new Date(deal.wonDate) : new Date()) : new Date();
                const days = Math.floor((closed - created) / (1000 * 60 * 60 * 24));
                totalDays += days;
                count++;
            });
            
            const avgVelocity = count > 0 ? Math.round(totalDays / count) : 0;
            const velEl = document.getElementById('analyticsDealVelocity');
            if (velEl) velEl.textContent = avgVelocity + ' Tage';
            
            // Average Deal Value
            const dealsWithValue = data.deals.filter(d => d.value > 0);
            const totalValue = dealsWithValue.reduce((sum, d) => sum + parseFloat(d.value || 0), 0);
            const avgValue = dealsWithValue.length > 0 ? totalValue / dealsWithValue.length : 0;
            
            const avgEl = document.getElementById('analyticsAvgDealValue');
            if (avgEl) avgEl.textContent = '‚Ç¨ ' + Math.round(avgValue).toLocaleString('de-DE');
            
            // Win Rate
            const closedCount = closedDeals.length;
            const winRate = closedCount > 0 ? ((wonDeals / closedCount) * 100).toFixed(1) : 0;
            
            const winEl = document.getElementById('analyticsWinRate');
            if (winEl) winEl.textContent = winRate + '%';
            
            const winDetailsEl = document.getElementById('analyticsWinRateDetails');
            if (winDetailsEl) {
                const lostDeals = data.deals.filter(d => d.lostConfirmed).length;
                winDetailsEl.textContent = `${wonDeals} gewonnen / ${lostDeals} verloren`;
            }
        }
        
        function renderRevenueTimeline(data, timeframe) {
            const container = document.getElementById('revenueTimelineChart');
            if (!container) return;
            
            // Berechne Zeitraum-Grenzen
            const now = new Date();
            let startDate, endDate;
            
            switch(timeframe) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                default: // all
                    startDate = new Date(2020, 0, 1);
                    endDate = new Date(now.getFullYear() + 2, 11, 31);
            }
            
            // Berechne monatliche Einnahmen basierend auf Zahlungsmodellen
            const monthlyRevenue = {};
            
            // Hole alle aktiven Auftr√§ge (nicht storniert)
            const activeOrders = orders.filter(o => o.status !== 'Storniert');
            
            activeOrders.forEach(order => {
                // Verwende startDate wenn vorhanden, sonst createdAt
                const orderStartDate = new Date(order.startDate || order.createdAt);
                const paymentModel = order.paymentModel || 'one-time';
                const value = parseFloat(order.value) || 0;
                const duration = parseInt(order.contractDuration) || 12;
                
                // Berechne Einnahmen pro Monat basierend auf Zahlungsmodell
                if (paymentModel === 'one-time') {
                    // Einmalzahlung: Voller Betrag im Startmonat
                    const key = `${orderStartDate.getFullYear()}-${String(orderStartDate.getMonth() + 1).padStart(2, '0')}`;
                    
                    // Nur hinzuf√ºgen wenn im gew√§hlten Zeitraum
                    if (orderStartDate >= startDate && orderStartDate <= endDate) {
                        if (!monthlyRevenue[key]) monthlyRevenue[key] = { actual: 0, recurring: 0, oneTime: 0 };
                        monthlyRevenue[key].oneTime += value;
                        monthlyRevenue[key].actual += value;
                    }
                    
                } else if (paymentModel === 'monthly') {
                    // Monatliche Zahlung: Verteile √ºber Laufzeit
                    for (let i = 0; i < duration; i++) {
                        const paymentDate = new Date(orderStartDate);
                        paymentDate.setMonth(paymentDate.getMonth() + i);
                        
                        // Nur hinzuf√ºgen wenn im gew√§hlten Zeitraum
                        if (paymentDate >= startDate && paymentDate <= endDate) {
                            const key = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
                            if (!monthlyRevenue[key]) monthlyRevenue[key] = { actual: 0, recurring: 0, oneTime: 0 };
                            monthlyRevenue[key].recurring += value;
                            monthlyRevenue[key].actual += value;
                        }
                    }
                    
                } else if (paymentModel === 'quarterly') {
                    // Viertelj√§hrliche Zahlung: Alle 3 Monate
                    const quarters = Math.ceil(duration / 3);
                    for (let i = 0; i < quarters; i++) {
                        const paymentDate = new Date(orderStartDate);
                        paymentDate.setMonth(paymentDate.getMonth() + (i * 3));
                        
                        // Nur hinzuf√ºgen wenn im gew√§hlten Zeitraum
                        if (paymentDate >= startDate && paymentDate <= endDate) {
                            const key = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
                            if (!monthlyRevenue[key]) monthlyRevenue[key] = { actual: 0, recurring: 0, oneTime: 0 };
                            monthlyRevenue[key].recurring += value;
                            monthlyRevenue[key].actual += value;
                        }
                    }
                    
                } else if (paymentModel === 'yearly') {
                    // J√§hrliche Zahlung: Alle 12 Monate
                    const years = Math.ceil(duration / 12);
                    for (let i = 0; i < years; i++) {
                        const paymentDate = new Date(orderStartDate);
                        paymentDate.setMonth(paymentDate.getMonth() + (i * 12));
                        
                        // Nur hinzuf√ºgen wenn im gew√§hlten Zeitraum
                        if (paymentDate >= startDate && paymentDate <= endDate) {
                            const key = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
                            if (!monthlyRevenue[key]) monthlyRevenue[key] = { actual: 0, recurring: 0, oneTime: 0 };
                            monthlyRevenue[key].recurring += value;
                            monthlyRevenue[key].actual += value;
                        }
                    }
                }
            });
            
            // Sortiere Monate
            const sortedMonths = Object.keys(monthlyRevenue).sort();
            
            if (sortedMonths.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 80px 0;">Keine Daten f√ºr diesen Zeitraum</p>';
                return;
            }
            
            // Finde Maximum f√ºr Skalierung
            const maxRevenue = Math.max(...sortedMonths.map(m => monthlyRevenue[m].actual), 1);
            
            // Generiere Chart
            container.innerHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 20px; padding: 12px; background: #f0f9ff; border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 2px;"></div>
                        <span style="font-size: 13px; color: #1e40af; font-weight: 600;">Wiederkehrend</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                        <span style="font-size: 13px; color: #059669; font-weight: 600;">Einmalig</span>
                    </div>
                </div>
            ` + sortedMonths.map(month => {
                const data = monthlyRevenue[month];
                const percentage = (data.actual / maxRevenue) * 100;
                const recurringPercentage = (data.recurring / data.actual) * 100;
                const [year, monthNum] = month.split('-');
                const monthDate = new Date(year, monthNum - 1);
                const monthName = monthDate.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
                const isPast = monthDate <= now;
                const isFuture = monthDate > now;
                
                return `
                    <div style="margin-bottom: 20px; ${isFuture ? 'opacity: 0.6;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: 600; color: var(--text-primary);">${monthName}</span>
                                ${isFuture ? '<span style="font-size: 11px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 3px;">Geplant</span>' : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${data.recurring > 0 ? `<span style="font-size: 13px; color: #1e40af;">‚Ç¨ ${Math.round(data.recurring).toLocaleString('de-DE')}</span>` : ''}
                                ${data.oneTime > 0 ? `<span style="font-size: 13px; color: #059669;">‚Ç¨ ${Math.round(data.oneTime).toLocaleString('de-DE')}</span>` : ''}
                                <span style="font-weight: 700; color: var(--primary); min-width: 80px; text-align: right;">‚Ç¨ ${Math.round(data.actual).toLocaleString('de-DE')}</span>
                            </div>
                        </div>
                        <div style="width: 100%; height: 14px; background: var(--bg-main); border-radius: 7px; overflow: hidden; position: relative;">
                            ${data.recurring > 0 ? `
                                <div style="position: absolute; width: ${(data.recurring / maxRevenue) * 100}%; height: 100%; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border-radius: 7px;"></div>
                            ` : ''}
                            ${data.oneTime > 0 ? `
                                <div style="position: absolute; left: ${(data.recurring / maxRevenue) * 100}%; width: ${(data.oneTime / maxRevenue) * 100}%; height: 100%; background: #10b981; border-radius: 7px;"></div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTopPerformers(data) {
            const container = document.getElementById('topPerformersChart');
            if (!container) return;
            
            // Gruppiere Auftr√§ge nach Hauptverantwortlichem der verkn√ºpften Deals
            const performerStats = {};
            
            // Durchlaufe alle aktiven Auftr√§ge (nicht nur gefilterte)
            const activeOrders = orders.filter(o => o.status !== 'Storniert');
            
            activeOrders.forEach(order => {
                // Finde den verkn√ºpften Deal (aus ALLEN Deals, nicht nur gefilterten)
                const deal = deals.find(d => d.id === order.dealId);
                if (!deal || !deal.wonConfirmed) return; // Nur gewonnene Deals
                
                const responsible = deal.responsiblePerson || 'Nicht zugewiesen';
                if (!performerStats[responsible]) {
                    performerStats[responsible] = { count: 0, value: 0, deals: new Set() };
                }
                
                // Count unique deals (ein Deal kann nur einmal gez√§hlt werden)
                if (!performerStats[responsible].deals.has(deal.id)) {
                    performerStats[responsible].deals.add(deal.id);
                    performerStats[responsible].count++;
                }
                
                // Addiere Gesamtumsatz des Auftrags
                performerStats[responsible].value += calculateOrderTotalRevenue(order);
            });
            
            // Sortiere nach Umsatz
            const sorted = Object.entries(performerStats)
                .sort((a, b) => b[1].value - a[1].value)
                .slice(0, 5);
            
            if (sorted.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">Keine Daten verf√ºgbar</p>';
                return;
            }
            
            const maxValue = sorted[0][1].value;
            
            container.innerHTML = sorted.map(([name, stats], index) => {
                const percentage = (stats.value / maxValue) * 100;
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                return `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: var(--text-primary);">${medal} ${name}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">${stats.count} Deals</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1; height: 8px; background: var(--bg-main); border-radius: 4px; margin-right: 12px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: ${index === 0 ? '#059669' : index === 1 ? '#1e40af' : '#64748b'}; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-weight: 700; color: var(--primary); min-width: 100px; text-align: right;">‚Ç¨ ${Math.round(stats.value).toLocaleString('de-DE')}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSalesFunnel(data) {
            const container = document.getElementById('salesFunnelChart');
            if (!container) return;
            
            const stages = [
                { name: 'Leads', count: data.contacts.length, color: '#3b82f6' },
                { name: 'Qualifizierung', count: data.deals.filter(d => d.stage === 'Qualifizierung').length, color: '#6366f1' },
                { name: 'Angebot', count: data.deals.filter(d => d.stage === 'Angebot').length, color: '#8b5cf6' },
                { name: 'Verhandlung', count: data.deals.filter(d => d.stage === 'Verhandlung').length, color: '#a855f7' },
                { name: 'Gewonnen', count: data.deals.filter(d => d.wonConfirmed).length, color: '#059669' }
            ];
            
            const maxCount = stages[0].count;
            
            container.innerHTML = stages.map((stage, index) => {
                const percentage = maxCount > 0 ? (stage.count / maxCount) * 100 : 0;
                const dropOff = index > 0 ? stages[index - 1].count - stage.count : 0;
                
                return `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: var(--text-primary);">${stage.name}</span>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                ${dropOff > 0 ? `<span style="font-size: 11px; color: #dc2626;">-${dropOff}</span>` : ''}
                                <span style="font-weight: 700; color: ${stage.color};">${stage.count}</span>
                            </div>
                        </div>
                        <div style="width: ${percentage}%; height: 32px; background: ${stage.color}; border-radius: 4px; display: flex; align-items: center; padding: 0 12px; color: white; font-weight: 600; transition: width 0.3s ease;">
                            ${percentage.toFixed(0)}%
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderLossReasons(data) {
            const container = document.getElementById('lossReasonsChart');
            if (!container) return;
            
            const lostDeals = data.deals.filter(d => d.lostConfirmed);
            
            // Simuliere Verlustgr√ºnde (in Zukunft k√∂nnte man diese beim Deal speichern)
            const reasons = {
                'Preis zu hoch': Math.floor(lostDeals.length * 0.35),
                'Konkurrenz': Math.floor(lostDeals.length * 0.25),
                'Timing': Math.floor(lostDeals.length * 0.20),
                'Features fehlen': Math.floor(lostDeals.length * 0.10),
                'Sonstige': Math.floor(lostDeals.length * 0.10)
            };
            
            const totalLost = Object.values(reasons).reduce((sum, val) => sum + val, 0);
            
            if (totalLost === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">Keine verlorenen Deals</p>';
                return;
            }
            
            const colors = ['#dc2626', '#f59e0b', '#64748b', '#94a3b8', '#cbd5e1'];
            
            container.innerHTML = Object.entries(reasons).map(([reason, count], index) => {
                const percentage = totalLost > 0 ? ((count / totalLost) * 100).toFixed(1) : 0;
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div style="width: 12px; height: 12px; background: ${colors[index]}; border-radius: 2px;"></div>
                            <span style="font-weight: 500; color: var(--text-primary);">${reason}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">${count} Deals</span>
                            <span style="font-weight: 700; color: ${colors[index]}; min-width: 50px; text-align: right;">${percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderForecast() {
            const container = document.getElementById('forecastChart');
            if (!container) return;
            
            const now = new Date();
            
            // Berechne TATS√ÑCHLICHE geplante Einnahmen f√ºr die n√§chsten 3 Monate
            const futureRevenue = {};
            const activeOrders = orders.filter(o => o.status !== 'Storniert');
            
            // Generiere Monate f√ºr Forecast
            const forecastMonths = [];
            for (let i = 1; i <= 3; i++) {
                const futureDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const key = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}`;
                forecastMonths.push({
                    key: key,
                    name: futureDate.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' }),
                    date: futureDate
                });
                futureRevenue[key] = { confirmed: 0, recurring: 0, oneTime: 0, pipeline: 0 };
            }
            
            // Berechne BEST√ÑTIGTE zuk√ºnftige Einnahmen aus bestehenden Auftr√§gen
            activeOrders.forEach(order => {
                // Verwende startDate wenn vorhanden, sonst createdAt
                const startDate = new Date(order.startDate || order.createdAt);
                const paymentModel = order.paymentModel || 'one-time';
                const value = parseFloat(order.value) || 0;
                const duration = parseInt(order.contractDuration) || 12;
                
                if (paymentModel === 'monthly') {
                    // Monatlich: Pr√ºfe welche Zahlungen in Zukunft liegen
                    for (let i = 0; i < duration; i++) {
                        const paymentDate = new Date(startDate);
                        paymentDate.setMonth(paymentDate.getMonth() + i);
                        const key = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (futureRevenue[key] && paymentDate > now) {
                            futureRevenue[key].confirmed += value;
                            futureRevenue[key].recurring += value;
                        }
                    }
                } else if (paymentModel === 'quarterly') {
                    const quarters = Math.ceil(duration / 3);
                    for (let i = 0; i < quarters; i++) {
                        const paymentDate = new Date(startDate);
                        paymentDate.setMonth(paymentDate.getMonth() + (i * 3));
                        const key = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (futureRevenue[key] && paymentDate > now) {
                            futureRevenue[key].confirmed += value;
                            futureRevenue[key].recurring += value;
                        }
                    }
                } else if (paymentModel === 'yearly') {
                    const years = Math.ceil(duration / 12);
                    for (let i = 0; i < years; i++) {
                        const paymentDate = new Date(startDate);
                        paymentDate.setMonth(paymentDate.getMonth() + (i * 12));
                        const key = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (futureRevenue[key] && paymentDate > now) {
                            futureRevenue[key].confirmed += value;
                            futureRevenue[key].recurring += value;
                        }
                    }
                }
            });
            
            // Berechne Durchschnitt der letzten 3 Monate f√ºr Szenarien
            const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);
            const recentDeals = deals.filter(d => {
                return d.wonConfirmed && new Date(d.createdAt) >= threeMonthsAgo;
            });
            const recentRevenue = recentDeals.reduce((sum, d) => sum + parseFloat(d.value || 0), 0);
            const avgMonthlyNewBusiness = recentRevenue / 3;
            
            // Pipeline-Wert
            const pipelineValue = deals.filter(d => 
                d.stage !== 'Abgeschlossen gewonnen' && 
                d.stage !== 'Abgeschlossen verloren'
            ).reduce((sum, d) => sum + parseFloat(d.value || 0), 0);
            
            // Szenarien f√ºr neues Business
            const conservativeNew = avgMonthlyNewBusiness * 0.5; // 50% vom Durchschnitt
            const realisticNew = avgMonthlyNewBusiness * 0.8; // 80% vom Durchschnitt
            const optimisticNew = avgMonthlyNewBusiness * 1.2; // 120% vom Durchschnitt
            
            // Finde Maximum f√ºr Skalierung
            const maxValue = Math.max(
                ...forecastMonths.map(m => futureRevenue[m.key].confirmed + optimisticNew),
                1
            );
            
            container.innerHTML = `
                <div style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-left: 4px solid #1e40af; border-radius: 4px;">
                    <div style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 12px;">Forecast-Basis</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div>
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Best√§tigte Einnahmen</div>
                            <div style="font-size: 16px; font-weight: 700; color: #10b981;">‚Ç¨ ${Math.round(futureRevenue[forecastMonths[0].key].confirmed).toLocaleString('de-DE')}</div>
                            <div style="font-size: 10px; color: #64748b;">N√§chster Monat</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">√ò Neues Business</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e40af;">‚Ç¨ ${Math.round(avgMonthlyNewBusiness).toLocaleString('de-DE')}</div>
                            <div style="font-size: 10px; color: #64748b;">Letzte 3 Monate</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Pipeline</div>
                            <div style="font-size: 16px; font-weight: 700; color: #f59e0b;">‚Ç¨ ${Math.round(pipelineValue).toLocaleString('de-DE')}</div>
                            <div style="font-size: 10px; color: #64748b;">Potenzial</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 20px; padding: 12px; background: #fefce8; border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                        <span style="font-size: 13px; color: #059669; font-weight: 600;">Best√§tigt (aus Vertr√§gen)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #94a3b8; border-radius: 2px;"></div>
                        <span style="font-size: 13px; color: #64748b; font-weight: 600;">Prognostiziert (neues Business)</span>
                    </div>
                </div>
                
                ${forecastMonths.map(month => {
                    const data = futureRevenue[month.key];
                    const conservativeTotal = data.confirmed + conservativeNew;
                    const realisticTotal = data.confirmed + realisticNew;
                    const optimisticTotal = data.confirmed + optimisticNew;
                    
                    return `
                        <div style="margin-bottom: 28px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 16px; font-size: 15px;">${month.name}</div>
                            
                            <!-- Konservativ -->
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 12px; color: #64748b; font-weight: 600;">KONSERVATIV</span>
                                    <span style="font-size: 13px; font-weight: 700; color: #dc2626;">‚Ç¨ ${Math.round(conservativeTotal).toLocaleString('de-DE')}</span>
                                </div>
                                <div style="height: 24px; background: var(--bg-main); border-radius: 4px; overflow: hidden; position: relative;">
                                    <div style="position: absolute; width: ${(data.confirmed / maxValue) * 100}%; height: 100%; background: #10b981;"></div>
                                    <div style="position: absolute; left: ${(data.confirmed / maxValue) * 100}%; width: ${(conservativeNew / maxValue) * 100}%; height: 100%; background: #94a3b8;"></div>
                                    <div style="position: relative; height: 100%; display: flex; align-items: center; padding: 0 8px; font-size: 11px; font-weight: 600; color: white;">
                                        ${data.confirmed > 0 ? `‚Ç¨ ${Math.round(data.confirmed).toLocaleString('de-DE')}` : ''}
                                        ${conservativeNew > 0 ? ` + ‚Ç¨ ${Math.round(conservativeNew).toLocaleString('de-DE')}` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Realistisch -->
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 12px; color: #64748b; font-weight: 600;">REALISTISCH</span>
                                    <span style="font-size: 13px; font-weight: 700; color: #1e40af;">‚Ç¨ ${Math.round(realisticTotal).toLocaleString('de-DE')}</span>
                                </div>
                                <div style="height: 24px; background: var(--bg-main); border-radius: 4px; overflow: hidden; position: relative;">
                                    <div style="position: absolute; width: ${(data.confirmed / maxValue) * 100}%; height: 100%; background: #10b981;"></div>
                                    <div style="position: absolute; left: ${(data.confirmed / maxValue) * 100}%; width: ${(realisticNew / maxValue) * 100}%; height: 100%; background: #94a3b8;"></div>
                                    <div style="position: relative; height: 100%; display: flex; align-items: center; padding: 0 8px; font-size: 11px; font-weight: 600; color: white;">
                                        ${data.confirmed > 0 ? `‚Ç¨ ${Math.round(data.confirmed).toLocaleString('de-DE')}` : ''}
                                        ${realisticNew > 0 ? ` + ‚Ç¨ ${Math.round(realisticNew).toLocaleString('de-DE')}` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Optimistisch -->
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                    <span style="font-size: 12px; color: #64748b; font-weight: 600;">OPTIMISTISCH</span>
                                    <span style="font-size: 13px; font-weight: 700; color: #059669;">‚Ç¨ ${Math.round(optimisticTotal).toLocaleString('de-DE')}</span>
                                </div>
                                <div style="height: 24px; background: var(--bg-main); border-radius: 4px; overflow: hidden; position: relative;">
                                    <div style="position: absolute; width: ${(data.confirmed / maxValue) * 100}%; height: 100%; background: #10b981;"></div>
                                    <div style="position: absolute; left: ${(data.confirmed / maxValue) * 100}%; width: ${(optimisticNew / maxValue) * 100}%; height: 100%; background: #94a3b8;"></div>
                                    <div style="position: relative; height: 100%; display: flex; align-items: center; padding: 0 8px; font-size: 11px; font-weight: 600; color: white;">
                                        ${data.confirmed > 0 ? `‚Ç¨ ${Math.round(data.confirmed).toLocaleString('de-DE')}` : ''}
                                        ${optimisticNew > 0 ? ` + ‚Ç¨ ${Math.round(optimisticNew).toLocaleString('de-DE')}` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }
        
        function exportAnalyticsPDF() {
            alert('PDF Export wird vorbereitet...\n\nIn der finalen Version w√ºrde hier ein detaillierter Report als PDF erstellt werden mit:\n\n‚Ä¢ Alle KPIs und Charts\n‚Ä¢ Umsatzentwicklung\n‚Ä¢ Top Performer\n‚Ä¢ Sales Funnel\n‚Ä¢ Verlustgr√ºnde\n‚Ä¢ Forecast\n\nDownload w√ºrde automatisch starten.');
        }
        
        // ==========================================
        // INACTIVE CUSTOMERS TRACKING
        // ==========================================
        
        function trackActivity(entityType, entityId, activityType) {
            // Track last activity for companies and contacts
            const now = new Date().toISOString();
            
            if (entityType === 'company') {
                const company = companies.find(c => c.id === entityId);
                if (company) {
                    company.lastActivity = now;
                    company.lastActivityType = activityType;
                    Storage.setItem('bbc_companies', JSON.stringify(companies));
                }
            } else if (entityType === 'contact') {
                const contact = contacts.find(c => c.id === entityId);
                if (contact) {
                    contact.lastActivity = now;
                    contact.lastActivityType = activityType;
                    Storage.setItem('bbc_contacts', JSON.stringify(contacts));
                }
            }
        }
        
        function calculateInactivityDays(entity) {
            // Check verschiedene Aktivit√§tsquellen
            const dates = [];
            
            // createdAt
            if (entity.createdAt) dates.push(new Date(entity.createdAt));
            
            // lastActivity (wenn vorhanden)
            if (entity.lastActivity) dates.push(new Date(entity.lastActivity));
            
            // Protocol entries
            if (entity.protocol && entity.protocol.length > 0) {
                dates.push(new Date(entity.protocol[0].date));
            }
            
            // Deals (f√ºr Companies)
            if (entity.deals && entity.deals.length > 0) {
                entity.deals.forEach(dealId => {
                    const deal = deals.find(d => d.id === dealId);
                    if (deal) {
                        dates.push(new Date(deal.createdAt));
                        if (deal.protocol && deal.protocol.length > 0) {
                            dates.push(new Date(deal.protocol[0].date));
                        }
                    }
                });
            }
            
            // Orders (f√ºr Companies)
            if (entity.orders && entity.orders.length > 0) {
                entity.orders.forEach(orderId => {
                    const order = orders.find(o => o.id === orderId);
                    if (order) {
                        dates.push(new Date(order.createdAt));
                    }
                });
            }
            
            // Tasks
            const entityTasks = tasks.filter(t => 
                (t.companyId === entity.id) || (t.contactId === entity.id)
            );
            entityTasks.forEach(task => {
                dates.push(new Date(task.createdAt));
            });
            
            // Finde neuestes Datum
            if (dates.length === 0) {
                return 999; // Keine Aktivit√§t
            }
            
            const lastDate = new Date(Math.max(...dates));
            const now = new Date();
            const diffTime = Math.abs(now - lastDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }
        
        function updateInactiveCustomers() {
            const threshold = parseInt(document.getElementById('inactivityThreshold').value);
            const sortBy = document.getElementById('inactivitySort').value;
            const filterType = document.getElementById('inactivityType').value;
            
            // Sammle alle Entit√§ten
            let allEntities = [];
            
            if (filterType === 'all' || filterType === 'companies') {
                companies.forEach(company => {
                    const inactiveDays = calculateInactivityDays(company);
                    if (inactiveDays >= threshold) {
                        // Berechne Risiko-Wert (Umsatz der aktiven Auftr√§ge)
                        let riskValue = 0;
                        if (company.orders) {
                            company.orders.forEach(orderId => {
                                const order = orders.find(o => o.id === orderId && o.status !== 'Storniert');
                                if (order) {
                                    riskValue += calculateOrderTotalRevenue(order);
                                }
                            });
                        }
                        
                        allEntities.push({
                            type: 'company',
                            id: company.id,
                            name: company.name,
                            inactiveDays,
                            riskValue,
                            entity: company
                        });
                    }
                });
            }
            
            if (filterType === 'all' || filterType === 'contacts') {
                contacts.forEach(contact => {
                    const inactiveDays = calculateInactivityDays(contact);
                    if (inactiveDays >= threshold) {
                        allEntities.push({
                            type: 'contact',
                            id: contact.id,
                            name: contact.name,
                            inactiveDays,
                            riskValue: 0,
                            entity: contact
                        });
                    }
                });
            }
            
            // Sortierung
            if (sortBy === 'oldest') {
                allEntities.sort((a, b) => b.inactiveDays - a.inactiveDays);
            } else if (sortBy === 'newest') {
                allEntities.sort((a, b) => a.inactiveDays - b.inactiveDays);
            } else if (sortBy === 'value') {
                allEntities.sort((a, b) => b.riskValue - a.riskValue);
            }
            
            // Statistiken berechnen
            const critical = allEntities.filter(e => e.inactiveDays > 90).length;
            const warning = allEntities.filter(e => e.inactiveDays >= 30 && e.inactiveDays <= 90).length;
            const totalActive = companies.length + contacts.length - allEntities.length;
            const totalRisk = allEntities.reduce((sum, e) => sum + e.riskValue, 0);
            
            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('activeCount').textContent = totalActive;
            document.getElementById('riskValue').textContent = '‚Ç¨ ' + Math.round(totalRisk).toLocaleString('de-DE');
            
            // Render Liste
            renderInactiveCustomersList(allEntities, threshold);
        }
        
        function renderInactiveCustomersList(entities, threshold) {
            const container = document.getElementById('inactiveCustomersContainer');
            
            if (entities.length === 0) {
                container.innerHTML = `
                    <div style="background: white; padding: 60px; text-align: center; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üéâ</div>
                        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #10b981;">Keine inaktiven Kontakte!</h3>
                        <p style="color: var(--text-secondary);">Alle Ihre Kontakte wurden in den letzten ${threshold} Tagen kontaktiert.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="background: white; border-radius: 12px; overflow: hidden;">
                    <div style="padding: 20px; border-bottom: 2px solid var(--border);">
                        <h3 style="font-size: 18px; font-weight: 700;">Inaktive Kontakte (${entities.length})</h3>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Kontakte ohne Aktivit√§t seit mehr als ${threshold} Tagen</p>
                    </div>
                    
                    ${entities.map(item => {
                        const severityClass = item.inactiveDays > 90 ? 'critical' : 
                                            item.inactiveDays > 60 ? 'warning' : 'info';
                        const severityColor = item.inactiveDays > 90 ? '#ef4444' : 
                                             item.inactiveDays > 60 ? '#f59e0b' : '#64748b';
                        const severityBg = item.inactiveDays > 90 ? '#fee2e2' : 
                                          item.inactiveDays > 60 ? '#fef3c7' : '#f1f5f9';
                        
                        const icon = item.type === 'company' ? 'üè¢' : 'üë§';
                        
                        return `
                            <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;" 
                                 onmouseover="this.style.background='#f8fafc'" 
                                 onmouseout="this.style.background='white'">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 24px;">${icon}</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px;">${item.name}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                                                ${item.type === 'company' ? 'Unternehmen' : 'Kontakt'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${item.riskValue > 0 ? `
                                        <div style="margin-left: 36px; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 12px; color: #1e40af; background: #dbeafe; padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                                Risiko-Wert: ‚Ç¨ ${Math.round(item.riskValue).toLocaleString('de-DE')}
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div style="text-align: right;">
                                        <div style="font-size: 24px; font-weight: 700; color: ${severityColor};">
                                            ${item.inactiveDays}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            Tage inaktiv
                                        </div>
                                        <div style="margin-top: 6px; padding: 4px 12px; background: ${severityBg}; color: ${severityColor}; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                            ${item.inactiveDays > 90 ? 'KRITISCH' : item.inactiveDays > 60 ? 'WARNUNG' : 'HINWEIS'}
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="${item.type === 'company' ? `showCompanyDetail('${item.id}')` : `showContactDetail('${item.id}')`}" 
                                                class="btn btn-secondary" 
                                                style="padding: 10px 16px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                <circle cx="12" cy="12" r="3"></circle>
                                            </svg>
                                            √ñffnen
                                        </button>
                                        <button onclick="openProtocolModal('${item.type}', '${item.id}')" 
                                                class="btn btn-primary" 
                                                style="padding: 10px 16px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                            Kontaktieren
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function openGoalsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Jahresziele 2026 bearbeiten</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Umsatzziel (‚Ç¨)</label>
                        <input type="number" class="form-input" id="goalRevenueInput" value="${dashboardGoals.revenue}" step="1000">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Neue Kontakte (Anzahl)</label>
                        <input type="number" class="form-input" id="goalContactsInput" value="${dashboardGoals.contacts}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Abgeschlossene Deals (Anzahl)</label>
                        <input type="number" class="form-input" id="goalDealsInput" value="${dashboardGoals.deals}">
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveGoals(); this.closest('.modal').remove();">Speichern</button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Abbrechen</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveGoals() {
            dashboardGoals = {
                revenue: parseInt(document.getElementById('goalRevenueInput').value) || 0,
                contacts: parseInt(document.getElementById('goalContactsInput').value) || 0,
                deals: parseInt(document.getElementById('goalDealsInput').value) || 0
            };
            Storage.setItem('bbc_dashboard_goals', JSON.stringify(dashboardGoals));
            renderDashboard();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize navigation
            initNavigation();
            
            // Load initial data
            loadEmployees();
            
            // Check storage availability and show warning
            setTimeout(() => {
                if (!Storage.isAvailable()) {
                    showNotification(
                        'Eingeschr√§nkter Speicher',
                        'Ihre Daten werden nur tempor√§r gespeichert und gehen beim Schlie√üen verloren. Bitte nutzen Sie die Export-Funktion f√ºr Backups oder hosten Sie das CRM auf einer eigenen Domain!',
                        10000
                    );
                }
            }, 1000);
            
            // Show initial view (Dashboard)
            showView('dashboard');
            
            // Check for overdue tasks
            checkOverdueTasks();
            setInterval(checkOverdueTasks, 300000); // Check every 5 minutes
        });
    </script>
</body>
</html>